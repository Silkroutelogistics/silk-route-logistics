<!DOCTYPE html>
<html lang="en">
<head>
  <script>
(function(){var A=window.API_URL||'https://api.silkroutelogistics.ai';fetch(A+'/api/build-version').then(function(r){return r.json()}).then(function(d){var s=localStorage.getItem('srl_build_version');if(s&&s!==d.version){localStorage.removeItem('token');localStorage.removeItem('carrier_token');localStorage.removeItem('user');localStorage.removeItem('carrier_user');localStorage.setItem('srl_build_version',d.version);window.location.href='/auth/login.html';return}localStorage.setItem('srl_build_version',d.version)}).catch(function(){})})();
</script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Communications Hub - Silk Route Logistics</title>
  <link rel="icon" href="/logo.png" type="image/png">
  <link rel="stylesheet" href="/ae/css/console.css">
  <link rel="stylesheet" href="/shared/css/themes.css">
  <link rel="stylesheet" href="/shared/css/marco-polo.css">
  <script>(function(){try{var t=localStorage.getItem('srl_theme')||'silk-route-classic';var m=localStorage.getItem('srl_mode')||'light';document.documentElement.setAttribute('data-theme',t);document.documentElement.setAttribute('data-mode',m)}catch(e){document.documentElement.setAttribute('data-theme','silk-route-classic');document.documentElement.setAttribute('data-mode','light')}})()</script>
  <style>
    /* ========== Communications Hub Styles ========== */
    .comm-layout {
      display: flex;
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }

    /* --- Left: Contact List (30%) --- */
    .contact-panel {
      width: 30%;
      min-width: 260px;
      border-right: 1px solid var(--gray-200);
      display: flex;
      flex-direction: column;
      background: var(--white);
    }
    .contact-search {
      padding: 12px;
      border-bottom: 1px solid var(--gray-200);
    }
    .contact-search input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--gray-200);
      border-radius: 6px;
      font-size: 13px;
      outline: none;
    }
    .contact-search input:focus { border-color: var(--gold); }
    .contact-tabs {
      display: flex;
      border-bottom: 1px solid var(--gray-200);
    }
    .contact-tab {
      flex: 1;
      padding: 8px;
      text-align: center;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      color: var(--gray-500);
      border-bottom: 2px solid transparent;
      transition: color 0.15s, border-color 0.15s;
      background: none;
      border-top: none;
      border-left: none;
      border-right: none;
    }
    .contact-tab.active {
      color: var(--gold);
      border-bottom-color: var(--gold);
    }
    .contact-list {
      flex: 1;
      overflow-y: auto;
      list-style: none;
    }
    .contact-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      cursor: pointer;
      border-bottom: 1px solid var(--gray-50);
      transition: background 0.1s;
    }
    .contact-item:hover { background: var(--gray-50); }
    .contact-item.active { background: var(--gold-dim); }
    .contact-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
      color: var(--white);
      flex-shrink: 0;
    }
    .avatar-carrier { background: #6366F1; }
    .avatar-shipper { background: #F59E0B; }
    .avatar-inbox { background: #A855F7; }
    .contact-info {
      flex: 1;
      min-width: 0;
    }
    .contact-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--navy);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .contact-last-msg {
      font-size: 11px;
      color: var(--gray-400);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-top: 2px;
    }
    .contact-meta {
      text-align: right;
      flex-shrink: 0;
    }
    .contact-time {
      font-size: 10px;
      color: var(--gray-400);
    }
    .contact-unread {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--gold);
      margin-top: 4px;
    }

    /* --- Center: Conversation (50%) --- */
    .convo-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--gray-50);
    }
    .convo-header {
      padding: 14px 20px;
      background: var(--white);
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .convo-header h3 {
      font-size: 16px;
      color: var(--navy);
      font-weight: 700;
    }
    .convo-header-type {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 600;
    }
    .type-carrier { background: rgba(99,102,241,0.1); color: #6366F1; }
    .type-shipper { background: rgba(245,158,11,0.1); color: #B45309; }
    .type-inbox { background: rgba(168,85,247,0.1); color: #A855F7; }
    .convo-thread {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .convo-empty {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--gray-400);
      font-size: 14px;
    }
    .comm-entry {
      display: flex;
      gap: 10px;
      max-width: 85%;
    }
    .comm-entry.outbound { margin-left: auto; flex-direction: row-reverse; }
    .comm-icon {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 12px;
    }
    .icon-call { background: rgba(34,197,94,0.1); color: var(--green); }
    .icon-text { background: rgba(59,130,246,0.1); color: #3B82F6; }
    .icon-email-in { background: rgba(168,85,247,0.1); color: #A855F7; }
    .icon-email-out { background: rgba(200,150,62,0.15); color: var(--gold); }
    .icon-email { background: rgba(168,85,247,0.1); color: #A855F7; }
    .icon-note { background: rgba(245,158,11,0.1); color: #B45309; }
    .comm-bubble {
      background: var(--white);
      border-radius: 12px;
      padding: 10px 14px;
      box-shadow: var(--shadow-sm);
      min-width: 120px;
    }
    .comm-entry.inbound-email .comm-bubble {
      background: linear-gradient(135deg, #F5F3FF 0%, #EDE9FE 100%);
      border: 1px solid #DDD6FE;
      color: #1E1B4B;
      border-left: 3px solid #7C3AED;
    }
    .comm-entry.inbound-email .comm-type-label { color: #7C3AED; }
    .comm-entry.inbound-email .comm-timestamp { color: #9CA3AF; }
    /* Collapsible old messages */
    .comm-collapsed-group {
      padding: 8px 16px;
      text-align: center;
      cursor: pointer;
      user-select: none;
    }
    .comm-collapsed-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 16px;
      background: var(--white);
      border: 1px dashed var(--gray-300);
      border-radius: 20px;
      color: var(--gray-500);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .comm-collapsed-btn:hover {
      background: var(--gray-50);
      border-color: var(--gold);
      color: var(--gold);
    }
    .comm-collapsed-btn svg {
      transition: transform 0.2s;
    }
    .comm-collapsed-btn.expanded svg {
      transform: rotate(180deg);
    }
    .comm-hidden-messages {
      display: none;
      flex-direction: column;
      gap: 12px;
    }
    .comm-hidden-messages.show {
      display: flex;
    }
    .comm-entry.outbound .comm-bubble {
      background: linear-gradient(135deg, #0D1B2A 0%, #1B2D45 100%);
      color: var(--white);
      border-left: 3px solid var(--gold);
    }
    .comm-bubble-header {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }
    .comm-type-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .comm-timestamp {
      font-size: 10px;
      color: var(--gray-400);
    }
    .comm-entry.outbound .comm-timestamp { color: rgba(255,255,255,0.5); }
    .comm-subject {
      font-size: 12px;
      font-weight: 700;
      margin-bottom: 6px;
      padding-bottom: 4px;
      border-bottom: 1px solid rgba(0,0,0,0.06);
    }
    .comm-entry.outbound .comm-subject {
      border-bottom-color: rgba(255,255,255,0.1);
    }
    .comm-body {
      font-size: 13px;
      line-height: 1.5;
      word-break: break-word;
    }
    .comm-entry.outbound .comm-type-label { color: var(--gold); }
    .comm-duration {
      font-size: 11px;
      color: var(--gray-400);
      margin-top: 4px;
    }
    .comm-entry.outbound .comm-duration { color: rgba(255,255,255,0.4); }

    /* --- Compose Bar --- */
    .compose-bar {
      background: var(--white);
      border-top: 1px solid var(--gray-200);
      padding: 12px 20px;
    }
    .compose-tabs {
      display: flex;
      gap: 0;
      margin-bottom: 10px;
    }
    .compose-tab {
      padding: 6px 14px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      color: var(--gray-500);
      border: 1px solid var(--gray-200);
      background: var(--white);
      transition: background 0.15s, color 0.15s;
    }
    .compose-tab:first-child { border-radius: 6px 0 0 6px; }
    .compose-tab:last-child { border-radius: 0 6px 6px 0; border-left: none; }
    .compose-tab.active { background: var(--navy); color: var(--white); border-color: var(--navy); }
    .compose-form { display: flex; gap: 8px; flex-wrap: wrap; align-items: flex-end; }
    .compose-textarea {
      flex: 1;
      min-width: 200px;
      padding: 8px 12px;
      border: 1px solid var(--gray-200);
      border-radius: 6px;
      font-size: 13px;
      font-family: inherit;
      resize: vertical;
      min-height: 100px;
      max-height: 300px;
      outline: none;
    }
    .compose-textarea:focus { border-color: var(--gold); }
    .compose-email-fields {
      display: none;
      width: 100%;
      gap: 8px;
      margin-bottom: 8px;
    }
    .compose-email-fields.active { display: flex; flex-wrap: wrap; }
    .compose-email-fields input,
    .compose-email-fields select {
      padding: 6px 10px;
      border: 1px solid var(--gray-200);
      border-radius: 6px;
      font-size: 12px;
      outline: none;
    }
    .compose-email-fields input { flex: 1; min-width: 150px; }
    .compose-email-fields select { width: 180px; }
    .compose-email-fields input:focus,
    .compose-email-fields select:focus { border-color: var(--gold); }
    .btn-send {
      padding: 8px 18px;
      background: var(--gold);
      color: var(--white);
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
    }
    .btn-send:hover { background: var(--gold-hover); }
    .btn-new-convo {
      padding: 6px 14px;
      background: var(--gold);
      color: var(--white);
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
    }
    .btn-new-convo:hover { background: var(--gold-hover); }

    /* --- Right: Contact Info (20%) --- */
    .info-panel {
      width: 20%;
      min-width: 200px;
      border-left: 1px solid var(--gray-200);
      background: var(--white);
      overflow-y: auto;
      padding: 20px 16px;
    }
    .info-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      margin: 0 auto 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: 700;
      color: var(--white);
    }
    .info-name {
      text-align: center;
      font-size: 16px;
      font-weight: 700;
      color: var(--navy);
      margin-bottom: 4px;
    }
    .info-type-badge {
      text-align: center;
      margin-bottom: 16px;
    }
    .info-section {
      margin-bottom: 16px;
    }
    .info-section-title {
      font-size: 11px;
      font-weight: 700;
      color: var(--gray-400);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    .info-field {
      margin-bottom: 6px;
    }
    .info-field label {
      display: block;
      font-size: 10px;
      color: var(--gray-400);
      text-transform: uppercase;
    }
    .info-field span {
      font-size: 13px;
      color: var(--navy);
      font-weight: 500;
    }
    .tier-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 700;
    }
    .tier-PLATINUM { background: #E5E7EB; color: #374151; }
    .tier-GOLD { background: var(--gold-dim); color: var(--gold); }
    .tier-SILVER { background: rgba(148,163,184,0.15); color: #64748B; }
    .tier-BRONZE { background: rgba(180,83,9,0.1); color: #B45309; }
    .tier-NONE { background: var(--gray-100); color: var(--gray-400); }
    .stage-badge {
      display: inline-block; padding: 2px 8px; border-radius: 4px;
      font-size: 10px; font-weight: 700;
    }
    .stage-Lead { background: rgba(99,102,241,0.1); color: #6366F1; }
    .stage-Contacted { background: rgba(59,130,246,0.1); color: #3B82F6; }
    .stage-Quoted { background: rgba(245,158,11,0.1); color: #B45309; }
    .stage-Negotiating { background: rgba(249,115,22,0.1); color: #C2410C; }
    .stage-Won { background: rgba(34,197,94,0.1); color: #15803D; }
    .stage-Active { background: var(--gold-dim); color: var(--gold); }

    /* Toast */
    .toast {
      position: fixed; bottom: 24px; right: 24px; padding: 12px 20px;
      border-radius: 8px; font-size: 13px; font-weight: 500; color: var(--white);
      z-index: 9999; transform: translateY(80px); opacity: 0;
      transition: transform 0.3s, opacity 0.3s;
    }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast-success { background: #15803D; }
    .toast-error { background: var(--red); }

    @media (max-width: 1024px) {
      .info-panel { display: none; }
      .contact-panel { width: 35%; min-width: 220px; }
    }
    @media (max-width: 640px) {
      .comm-layout { flex-direction: column; }
      .contact-panel { width: 100%; max-height: 40vh; }
      .convo-panel { min-height: 50vh; }
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-logo"><img src="/logo.png" alt="SRL"><span>SRL Command</span></div>
      <div class="sidebar-user">
        <div class="sidebar-user-name" id="user-name">--</div>
        <div class="sidebar-user-role" id="user-role">--</div>
      </div>
      <nav class="sidebar-nav">
        <a href="/ae/dashboard"><svg class="sidebar-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>Dashboard</a>
        <a href="/ae/loads.html"><svg class="sidebar-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 3h15v13H1z"/><path d="M16 8h4l3 3v5h-7V8z"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>Load Board</a>
        <a href="/ae/caravan.html"><svg class="sidebar-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 6h13"/><path d="M8 12h13"/><path d="M8 18h13"/><path d="M3 6h.01"/><path d="M3 12h.01"/><path d="M3 18h.01"/></svg>The Caravan</a>
        <a href="/ae/crm.html"><svg class="sidebar-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>CRM</a>
        <a href="/ae/communications.html" class="active"><svg class="sidebar-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>Communications</a>
        <a href="/ae/claims.html"><svg class="sidebar-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="9" y1="15" x2="15" y2="15"/><line x1="9" y1="11" x2="13" y2="11"/></svg>Claims</a>
        <a href="/ae/financials.html"><svg class="sidebar-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>Financials</a>
        <a href="/ae/training.html"><svg class="sidebar-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>Training</a>
        <a href="/ae/analytics.html">
          <svg class="sidebar-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10"/><path d="M12 20V4"/><path d="M6 20v-6"/></svg>
          Analytics
        </a>
        <a href="/ae/accounting/dashboard.html"><svg class="sidebar-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="18" rx="2"/><path d="M2 9h20M9 21V9"/></svg>Accounting</a>
        <div style="border-top:1px solid var(--gray-200);margin:12px 0;padding-top:12px;">
          <div style="font-size:10px;color:var(--gray-400);text-transform:uppercase;letter-spacing:1px;padding:0 16px 8px;">Compliance</div>
          <a href="/ae/compliance/dashboard.html"><svg class="sidebar-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>Dashboard</a>
          <a href="/ae/compliance/overview.html"><svg class="sidebar-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>Overview</a>
          <a href="/ae/compliance/alerts.html"><svg class="sidebar-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>Alerts</a>
        </div>
      </nav>
      <div class="sidebar-footer">
        <button class="sidebar-logout" onclick="handleLogout()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>Sign Out</button>
      </div>
    </aside>
    <button class="hamburger" id="hamburger" onclick="toggleSidebar()">&#9776;</button>
    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

    <main class="main" style="display:flex;flex-direction:column">
      <div class="main-header" style="flex-shrink:0">
        <h1>Communications Hub</h1>
      </div>

      <!-- Integration Banners -->
      <div style="display:flex;gap:12px;padding:0 20px 16px;flex-shrink:0;flex-wrap:wrap">
        <div style="flex:1;min-width:200px;background:linear-gradient(135deg,#1a73e8 0%,#4285f4 100%);border-radius:10px;padding:14px 18px;display:flex;align-items:center;gap:12px">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
          <div>
            <div style="color:#fff;font-size:13px;font-weight:600">Sales Inbox</div>
            <div style="color:rgba(255,255,255,0.7);font-size:11px">sales@silkroutelogistics.ai — Inbound emails appear in Inbox tab</div>
          </div>
        </div>
        <div style="flex:1;min-width:200px;background:linear-gradient(135deg,#7c3aed 0%,#a78bfa 100%);border-radius:10px;padding:14px 18px;display:flex;align-items:center;gap:12px">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2A19.79 19.79 0 0 1 3.09 5.18 2 2 0 0 1 5.11 3h3a2 2 0 0 1 2 1.72c.13.81.36 1.6.7 2.35a2 2 0 0 1-.45 2.11L8.09 10.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.75.34 1.54.57 2.35.7A2 2 0 0 1 22 17.92z"/></svg>
          <div>
            <div style="color:#fff;font-size:13px;font-weight:600">OpenPhone / Quo</div>
            <div style="color:rgba(255,255,255,0.7);font-size:11px">Call integration + auto check-calls — Coming Soon</div>
          </div>
        </div>
      </div>

      <div class="comm-layout">
        <!-- LEFT: Contact List -->
        <div class="contact-panel">
          <div class="contact-search">
            <input type="text" id="contact-search" placeholder="Search contacts..." oninput="filterContacts()">
          </div>
          <div class="contact-tabs">
            <button class="contact-tab active" data-filter="all" onclick="setContactTab('all',this)">All</button>
            <button class="contact-tab" data-filter="carrier" onclick="setContactTab('carrier',this)">Carriers</button>
            <button class="contact-tab" data-filter="shipper" onclick="setContactTab('shipper',this)">Shippers</button>
            <button class="contact-tab" data-filter="inbox" onclick="setContactTab('inbox',this)">Inbox</button>
          </div>
          <ul class="contact-list" id="contact-list"></ul>
        </div>

        <!-- CENTER: Conversation -->
        <div class="convo-panel">
          <div class="convo-header" id="convo-header" style="display:none">
            <h3 id="convo-name">--</h3>
            <span class="convo-header-type" id="convo-type-badge"></span>
            <div style="flex:1"></div>
            <button class="btn-new-convo" onclick="startNewConversation()" title="New conversation">+ New</button>
          </div>
          <div class="convo-thread" id="convo-thread">
            <div class="convo-empty">Select a contact to view communications</div>
          </div>
          <div class="compose-bar" id="compose-bar" style="display:none">
            <div class="compose-tabs">
              <button class="compose-tab active" onclick="setComposeMode('note',this)">Note</button>
              <button class="compose-tab" onclick="setComposeMode('email',this)">Email</button>
            </div>
            <div class="compose-email-fields" id="email-fields">
              <input type="email" id="email-to" placeholder="To email address...">
              <input type="text" id="email-subject" placeholder="Subject...">
              <select id="email-template" onchange="loadTemplate()"></select>
            </div>
            <div class="compose-form">
              <textarea class="compose-textarea" id="compose-text" placeholder="Type a message... (Shift+Enter to send)" onkeydown="if(event.key==='Enter'&&event.shiftKey){event.preventDefault();sendComm()}"></textarea>
              <button class="btn-send" onclick="sendComm()">Send</button>
            </div>
          </div>
        </div>

        <!-- RIGHT: Contact Info -->
        <div class="info-panel" id="info-panel">
          <div style="text-align:center;color:var(--gray-400);padding:40px 0;font-size:13px">
            Select a contact
          </div>
        </div>
      </div>
    </main>
  </div>

  <div class="toast" id="toast"></div>

  <script src="/js/auth.js"></script>
  <script src="/ae/js/api.js"></script>
  <script>
    /* ======== STATE ======== */
    var state = {
      contacts: [],
      filtered: [],
      currentContact: null,
      communications: [],
      composeMode: "note",
      tabFilter: "all",
      currentUser: null,
      templates: []
    };

    /* ======== INIT ======== */
    (function init() {
      loadUser();
      loadContacts();
      loadTemplates();
    })();

    function loadUser() {
      SRL.getMe().then(function(u) {
        if(window.SRLTheme)SRLTheme.restoreFromUser(u);
        state.currentUser = u;
        document.getElementById("user-name").textContent = u.firstName + " " + u.lastName;
        document.getElementById("user-role").textContent = formatRole(u.role);
      }).catch(function(){});
    }

    function loadTemplates() {
      SRL.request("/api/email/templates").then(function(res) {
        state.templates = res.templates || [];
      }).catch(function(){});
    }

    function loadContacts() {
      // Load both carriers and customers as "contacts"
      Promise.allSettled([
        SRL.request("/api/carriers?limit=200"),
        SRL.request("/api/customers?limit=200")
      ]).then(function(results) {
        var contacts = [];

        // Carriers
        if (results[0].status === "fulfilled" && results[0].value.carriers) {
          results[0].value.carriers.forEach(function(c) {
            contacts.push({
              id: c.userId || c.id,
              entityType: "CARRIER",
              entityId: c.userId || c.id,
              name: c.company || c.contactName || "Unknown Carrier",
              subtitle: "MC# " + (c.mcNumber || "--"),
              email: c.email,
              phone: c.phone,
              tier: c.tier,
              data: c
            });
          });
        }

        // Customers/Shippers
        if (results[1].status === "fulfilled" && results[1].value.customers) {
          results[1].value.customers.forEach(function(c) {
            contacts.push({
              id: c.id,
              entityType: "SHIPPER",
              entityId: c.id,
              name: c.name || "Unknown Shipper",
              subtitle: c.city ? c.city + ", " + (c.state || "") : c.industry || "",
              email: c.email,
              phone: c.phone,
              stage: c.status,
              data: c
            });
          });
        }

        state.contacts = contacts;
        filterContacts();
      });
    }

    function filterContacts() {
      var search = (document.getElementById("contact-search").value || "").toLowerCase();
      if (state.tabFilter === "inbox") {
        loadInboxContacts(search);
        return;
      }
      state.filtered = state.contacts.filter(function(c) {
        if (state.tabFilter === "carrier" && c.entityType !== "CARRIER") return false;
        if (state.tabFilter === "shipper" && c.entityType !== "SHIPPER") return false;
        if (search) {
          var hay = ((c.name||"")+" "+(c.subtitle||"")+" "+(c.email||"")).toLowerCase();
          if (hay.indexOf(search) === -1) return false;
        }
        return true;
      });
      renderContactList();
    }

    function loadInboxContacts(search) {
      SRL.request("/api/communications?type=EMAIL_INBOUND&limit=100").then(function(res) {
        var emails = res.communications || [];
        // Group by sender email
        var senderMap = {};
        emails.forEach(function(e) {
          var from = e.from || "unknown";
          if (!senderMap[from]) {
            var meta = e.metadata || {};
            senderMap[from] = {
              id: "inbox_" + from,
              entityType: "INBOX",
              entityId: from,
              name: meta.senderName || from,
              subtitle: from,
              email: from,
              lastMsg: e.subject || e.body || "",
              lastTime: e.createdAt,
              count: 0,
              matchedType: e.entityType,
              matchedId: e.entityId
            };
          }
          senderMap[from].count++;
        });
        var inboxContacts = Object.values(senderMap);
        // Sort by most recent
        inboxContacts.sort(function(a, b) { return new Date(b.lastTime) - new Date(a.lastTime); });
        if (search) {
          inboxContacts = inboxContacts.filter(function(c) {
            var hay = ((c.name||"")+" "+(c.email||"")).toLowerCase();
            return hay.indexOf(search) !== -1;
          });
        }
        state.filtered = inboxContacts;
        renderContactList();
      }).catch(function() {
        state.filtered = [];
        renderContactList();
      });
    }

    function setContactTab(filter, btn) {
      state.tabFilter = filter;
      document.querySelectorAll(".contact-tab").forEach(function(t) { t.classList.remove("active"); });
      btn.classList.add("active");
      filterContacts();
    }

    function renderContactList() {
      var list = document.getElementById("contact-list");
      if (state.filtered.length === 0) {
        var emptyMsg = state.tabFilter === "inbox" ? "No inbound emails yet" : "No contacts found";
        list.innerHTML = '<li style="padding:30px;text-align:center;color:var(--gray-400);font-size:13px">' + emptyMsg + '</li>';
        return;
      }
      list.innerHTML = state.filtered.map(function(c) {
        var initials = getInitials(c.name);
        var avatarClass = c.entityType === "CARRIER" ? "avatar-carrier" : c.entityType === "INBOX" ? "avatar-inbox" : "avatar-shipper";
        var isActive = state.currentContact && state.currentContact.id === c.id;
        var subtitle = c.entityType === "INBOX" ? esc(c.lastMsg) : esc(c.subtitle);
        var countBadge = c.count ? ' <span style="font-size:10px;background:var(--gold);color:#fff;border-radius:10px;padding:1px 6px;margin-left:4px">' + c.count + '</span>' : '';
        var safeId = c.id.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        return '<li class="contact-item' + (isActive ? ' active' : '') + '" onclick="selectContact(\'' + safeId + '\')">' +
          '<div class="contact-avatar ' + avatarClass + '">' + initials + '</div>' +
          '<div class="contact-info">' +
            '<div class="contact-name">' + esc(c.name) + countBadge + '</div>' +
            '<div class="contact-last-msg">' + subtitle + '</div>' +
          '</div>' +
          (c.lastTime ? '<div class="contact-meta"><div class="contact-time">' + timeAgo(c.lastTime) + '</div></div>' : '') +
        '</li>';
      }).join("");
    }

    /* ======== SELECT CONTACT ======== */
    function selectContact(id) {
      // Check in both regular contacts and filtered (for inbox)
      var contact = state.contacts.find(function(c) { return c.id === id; });
      if (!contact) contact = state.filtered.find(function(c) { return c.id === id; });
      if (!contact) return;
      state.currentContact = contact;
      renderContactList();
      loadCommunications(contact);
      document.getElementById("convo-header").style.display = "";
      document.getElementById("convo-name").textContent = contact.name;
      var badge = document.getElementById("convo-type-badge");
      var typeLabel = contact.entityType === "INBOX" ? "INBOUND" : contact.entityType;
      badge.textContent = typeLabel;
      badge.className = "convo-header-type type-" + contact.entityType.toLowerCase();
      document.getElementById("compose-bar").style.display = "";
      updateTemplateDropdown();

      if (contact.entityType === "INBOX") {
        renderInboxInfoPanel(contact);
        // Auto-switch to email reply mode for inbox contacts
        var emailBtn = document.querySelector('.compose-tab:nth-child(2)');
        if (emailBtn) setComposeMode("email", emailBtn);
        document.getElementById("email-to").value = contact.email || "";
        document.getElementById("email-subject").value = contact.lastMsg ? "Re: " + contact.lastMsg : "";
      } else {
        renderInfoPanel(contact);
        // Auto-switch to email mode for carrier/shipper contacts
        var emailBtn = document.querySelector('.compose-tab:nth-child(2)');
        if (emailBtn) setComposeMode("email", emailBtn);
        // Pre-fill email to if available
        if (contact.email) {
          document.getElementById("email-to").value = contact.email;
        }
      }
    }

    function loadCommunications(contact) {
      var url;
      if (contact.entityType === "INBOX") {
        // For inbox contacts, load full thread (inbound + outbound with this email)
        url = "/api/communications?thread_email=" + encodeURIComponent(contact.email) + "&limit=100";
      } else {
        url = "/api/communications?entity_type=" + contact.entityType + "&entity_id=" + contact.entityId + "&limit=100";
      }
      SRL.request(url).then(function(res) {
        state.communications = (res.communications || []).reverse();
        renderThread();
      }).catch(function() {
        state.communications = [];
        renderThread();
      });
    }

    function renderInboxInfoPanel(contact) {
      var html = '';
      var initials = getInitials(contact.name);
      html += '<div class="info-avatar avatar-inbox">' + initials + '</div>';
      html += '<div class="info-name">' + esc(contact.name) + '</div>';
      html += '<div class="info-type-badge"><span class="convo-header-type" style="background:rgba(168,85,247,0.1);color:#A855F7">INBOUND EMAIL</span></div>';
      html += '<div class="info-section">';
      html += '<div class="info-section-title">Sender</div>';
      html += '<div class="info-field"><label>Email</label><span>' + esc(contact.email) + '</span></div>';
      html += '<div class="info-field"><label>Total Emails</label><span>' + (contact.count || 0) + '</span></div>';
      if (contact.matchedType && contact.matchedType !== "UNKNOWN") {
        html += '<div class="info-field"><label>Matched</label><span>' + esc(contact.matchedType) + '</span></div>';
      }
      html += '</div>';
      document.getElementById("info-panel").innerHTML = html;
    }

    /* ======== RENDER THREAD ======== */
    function cleanEmailBody(body, type) {
      if (!body) return "(no content)";
      var text = body;
      // Strip full HTML email templates (outbound emails store raw HTML)
      if (text.indexOf("<!DOCTYPE") !== -1 || text.indexOf("<html") !== -1) {
        // Try to extract just the user content from SRL template
        var contentMatch = text.match(/<td[^>]*style="[^"]*padding:32px[^"]*"[^>]*>([\s\S]*?)<\/td>/i);
        if (contentMatch) {
          text = contentMatch[1];
        }
        // Strip remaining HTML tags
        text = text.replace(/<br\s*\/?>/gi, "\n");
        text = text.replace(/<\/?(p|div|tr|td|table|h[1-6])[^>]*>/gi, "\n");
        text = text.replace(/<[^>]+>/g, "");
        text = text.replace(/&nbsp;/g, " ");
        text = text.replace(/&amp;/g, "&");
        text = text.replace(/&lt;/g, "<");
        text = text.replace(/&gt;/g, ">");
        text = text.replace(/&quot;/g, '"');
        text = text.replace(/&#x27;/g, "'");
        text = text.replace(/&middot;/g, " ");
      }
      // Clean up whitespace
      text = text.replace(/\n{3,}/g, "\n\n").trim();
      // Remove common email footer/signature noise
      text = text.replace(/Silk Route Logistics\s*[·•]\s*Moving Freight.*$/i, "").trim();
      return text || "(no content)";
    }

    function renderCommEntry(c) {
      var isOutbound = c.direction === "OUTBOUND" || c.type.includes("OUTBOUND") || c.type === "NOTE";
      var isInboundEmail = c.type === "EMAIL_INBOUND";
      var iconClass = isInboundEmail ? "icon-email-in" : isOutbound && c.type === "EMAIL_OUTBOUND" ? "icon-email-out" : getTypeIcon(c.type);
      var typeLabel = getTypeLabel(c.type);
      var entryClass = "comm-entry";
      if (isOutbound) entryClass += " outbound";
      if (isInboundEmail) entryClass += " inbound-email";

      var displayBody = cleanEmailBody(c.body, c.type);
      var fromLabel = isInboundEmail && c.from ? '<div style="font-size:10px;margin-top:4px;opacity:0.6">from ' + esc(c.from) + '</div>' : '';
      var byLabel = isOutbound && c.user ? '<div style="font-size:10px;margin-top:4px;opacity:0.6">by ' + esc(c.user.firstName + " " + c.user.lastName) + '</div>' : '';
      var dateStr = c.createdAt ? new Date(c.createdAt).toLocaleString("en-US", {month:"short",day:"numeric",hour:"numeric",minute:"2-digit"}) : "";

      return '<div class="' + entryClass + '">' +
        '<div class="comm-icon ' + iconClass + '">' + getTypeEmoji(c.type) + '</div>' +
        '<div class="comm-bubble">' +
          '<div class="comm-bubble-header">' +
            '<span class="comm-type-label">' + typeLabel + '</span>' +
            '<span class="comm-timestamp">' + timeAgo(c.createdAt) + '</span>' +
            '<span style="font-size:10px;color:var(--gray-400);margin-left:auto">' + dateStr + '</span>' +
          '</div>' +
          (c.subject ? '<div class="comm-subject">' + esc(c.subject) + '</div>' : '') +
          '<div class="comm-body">' + esc(displayBody).replace(/\n/g, "<br>") + '</div>' +
          (c.duration ? '<div class="comm-duration">' + formatDuration(c.duration) + '</div>' : '') +
          fromLabel + byLabel +
        '</div>' +
      '</div>';
    }

    function renderThread() {
      var thread = document.getElementById("convo-thread");
      if (state.communications.length === 0) {
        thread.innerHTML = '<div class="convo-empty">No communications yet. Log a note or send an email to get started.</div>';
        return;
      }
      // Show newest first — reverse the array (state.communications is oldest-first)
      var sorted = state.communications.slice().reverse();
      var VISIBLE_COUNT = 3;

      if (sorted.length <= VISIBLE_COUNT) {
        // Few messages — show all
        thread.innerHTML = sorted.map(renderCommEntry).join("");
      } else {
        // Show latest messages + collapsible older ones
        var recent = sorted.slice(0, VISIBLE_COUNT);
        var older = sorted.slice(VISIBLE_COUNT);
        var html = recent.map(renderCommEntry).join("");
        html += '<div class="comm-collapsed-group">' +
          '<button class="comm-collapsed-btn" onclick="toggleOlderMessages(this)">' +
            '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>' +
            'Show ' + older.length + ' older message' + (older.length > 1 ? 's' : '') +
          '</button></div>';
        html += '<div class="comm-hidden-messages" id="older-messages">' +
          older.map(renderCommEntry).join("") + '</div>';
        thread.innerHTML = html;
      }
      // Scroll to top to see newest
      thread.scrollTop = 0;
    }

    function toggleOlderMessages(btn) {
      var container = document.getElementById("older-messages");
      if (container.classList.contains("show")) {
        container.classList.remove("show");
        btn.classList.remove("expanded");
        var count = container.children.length;
        btn.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>' +
          'Show ' + count + ' older message' + (count > 1 ? 's' : '');
      } else {
        container.classList.add("show");
        btn.classList.add("expanded");
        btn.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>' +
          'Hide older messages';
      }
    }

    /* ======== INFO PANEL ======== */
    function renderInfoPanel(contact) {
      var html = '';
      var initials = getInitials(contact.name);
      var avatarClass = contact.entityType === "CARRIER" ? "avatar-carrier" : "avatar-shipper";

      html += '<div class="info-avatar ' + avatarClass + '">' + initials + '</div>';
      html += '<div class="info-name">' + esc(contact.name) + '</div>';
      html += '<div class="info-type-badge">';
      html += '<span class="convo-header-type type-' + contact.entityType.toLowerCase() + '">' + contact.entityType + '</span>';
      html += '</div>';

      // Contact details
      html += '<div class="info-section">';
      html += '<div class="info-section-title">Contact</div>';
      if (contact.email) html += '<div class="info-field"><label>Email</label><span>' + esc(contact.email) + '</span></div>';
      if (contact.phone) html += '<div class="info-field"><label>Phone</label><span><a href="tel:' + esc(contact.phone) + '">' + esc(contact.phone) + '</a></span></div>';
      html += '</div>';

      // Type-specific info
      if (contact.entityType === "CARRIER") {
        var d = contact.data;
        html += '<div class="info-section">';
        html += '<div class="info-section-title">Carrier Details</div>';
        if (d.mcNumber) html += '<div class="info-field"><label>MC#</label><span>' + esc(d.mcNumber) + '</span></div>';
        if (d.dotNumber) html += '<div class="info-field"><label>DOT#</label><span>' + esc(d.dotNumber) + '</span></div>';
        if (d.tier) html += '<div class="info-field"><label>CPP Tier</label><span class="tier-badge tier-' + d.tier + '">' + d.tier + '</span></div>';
        if (d.numberOfTrucks) html += '<div class="info-field"><label>Trucks</label><span>' + d.numberOfTrucks + '</span></div>';
        if (d.equipmentTypes && d.equipmentTypes.length) html += '<div class="info-field"><label>Equipment</label><span>' + d.equipmentTypes.join(", ") + '</span></div>';
        html += '</div>';
      } else {
        var d = contact.data;
        html += '<div class="info-section">';
        html += '<div class="info-section-title">Shipper Details</div>';
        if (contact.stage) html += '<div class="info-field"><label>Pipeline</label><span class="stage-badge stage-' + contact.stage + '">' + contact.stage + '</span></div>';
        if (d.industry) html += '<div class="info-field"><label>Industry</label><span>' + esc(d.industry) + '</span></div>';
        if (d.avgLoadsPerMonth) html += '<div class="info-field"><label>Avg Loads/Mo</label><span>' + d.avgLoadsPerMonth + '</span></div>';
        if (d.paymentTerms) html += '<div class="info-field"><label>Payment Terms</label><span>' + esc(d.paymentTerms) + '</span></div>';
        html += '</div>';
      }

      document.getElementById("info-panel").innerHTML = html;
    }

    /* ======== NEW CONVERSATION ======== */
    function startNewConversation() {
      if (!state.currentContact) return;
      // Switch to email mode
      var emailBtn = document.querySelector('.compose-tab:nth-child(2)');
      if (emailBtn) setComposeMode("email", emailBtn);
      // Clear fields for new subject
      document.getElementById("email-subject").value = "";
      document.getElementById("compose-text").value = "";
      document.getElementById("email-template").selectedIndex = 0;
      // Pre-fill to address
      if (state.currentContact.email) {
        document.getElementById("email-to").value = state.currentContact.email;
      }
      // Focus on subject
      document.getElementById("email-subject").focus();
      showToast("New conversation — enter a subject", "success");
    }

    /* ======== COMPOSE ======== */
    function setComposeMode(mode, btn) {
      state.composeMode = mode;
      document.querySelectorAll(".compose-tab").forEach(function(t) { t.classList.remove("active"); });
      btn.classList.add("active");
      var emailFields = document.getElementById("email-fields");
      var textarea = document.getElementById("compose-text");
      if (mode === "email") {
        emailFields.classList.add("active");
        textarea.placeholder = "Email body...";
      } else {
        emailFields.classList.remove("active");
        textarea.placeholder = "Type a note...";
      }
    }

    var carrierTemplates = [
      { id: "", label: "No template" },
      { id: "carrier_intro", label: "Carrier Introduction", subject: "Partnership Opportunity - Silk Route Logistics", body: "Hi [NAME],\n\nI'm reaching out from Silk Route Logistics. We're a growing freight brokerage and we're always looking for reliable carriers to join our network.\n\nWe have consistent freight in your operating lanes and offer quick pay options. Would you be interested in a brief call to discuss how we can work together?" },
      { id: "carrier_load_offer", label: "Load Available", subject: "Load Available - Silk Route Logistics", body: "Hi [NAME],\n\nWe have a load available that matches your equipment and lanes. Please let me know if you're interested and I can share the full details including rate, pickup/delivery times, and commodity info." },
      { id: "carrier_rate_confirm", label: "Rate Confirmation", subject: "Rate Confirmation - Silk Route Logistics", body: "Hi [NAME],\n\nPlease find the rate confirmation for the load we discussed. Kindly review the details and sign at your earliest convenience. If you have any questions, don't hesitate to reach out." },
      { id: "carrier_pod_request", label: "POD Request", subject: "POD Required - Silk Route Logistics", body: "Hi [NAME],\n\nThe load has been delivered. Could you please upload the signed Proof of Delivery (POD) at your earliest convenience? This will help us process your payment quickly." },
      { id: "carrier_payment", label: "Payment Update", subject: "Payment Update - Silk Route Logistics", body: "Hi [NAME],\n\nThis is to confirm that your payment has been processed. Please allow 2-3 business days for the funds to reflect in your account. Thank you for your service." },
      { id: "carrier_followup", label: "Follow Up", subject: "Following Up - Silk Route Logistics", body: "Hi [NAME],\n\nJust following up on our previous conversation. We'd love to continue working together and have more loads available in your lanes. Let me know your current availability." },
      { id: "carrier_thank_you", label: "Thank You", subject: "Thank You - Silk Route Logistics", body: "Hi [NAME],\n\nThank you for the great service on the recent load. We appreciate your professionalism and reliability. Looking forward to working with you again soon." },
      { id: "carrier_onboarding", label: "Onboarding Welcome", subject: "Welcome to Silk Route Logistics Network", body: "Hi [NAME],\n\nWelcome aboard! We're excited to have you as part of the Silk Route Logistics carrier network.\n\nTo complete your onboarding, please ensure the following documents are uploaded to your carrier portal:\n- W-9 Form\n- Certificate of Insurance\n- Operating Authority\n\nOnce verified, you'll start receiving load opportunities in your preferred lanes. Our team is here to support you every step of the way." },
      { id: "carrier_quickpay", label: "Quick Pay Offer", subject: "Quick Pay Available - Silk Route Logistics", body: "Hi [NAME],\n\nGood news! You're eligible for our Quick Pay program. Get paid within 2 business days of delivering the load and submitting your POD.\n\nQuick Pay Terms:\n- 2% fee deducted from carrier rate\n- Payment within 48 hours of approved POD\n- Available on all loads over $500\n\nWould you like to opt in? Just reply to confirm." },
      { id: "carrier_capacity", label: "Capacity Check", subject: "Capacity Inquiry - Silk Route Logistics", body: "Hi [NAME],\n\nWe're seeing strong demand in your operating region and wanted to check on your current availability.\n\nCould you share:\n1. Number of trucks available this week\n2. Preferred lanes\n3. Any deadhead limitations\n\nWe'd love to keep you loaded and moving. Let me know your capacity and I'll match you with the best opportunities." }
    ];

    var shipperTemplates = [
      { id: "", label: "No template" },
      { id: "shipper_intro", label: "Introduction", subject: "Introduction - Silk Route Logistics", body: "Hi [NAME],\n\nI'd like to introduce myself and Silk Route Logistics. We are a full-service freight brokerage specializing in reliable, on-time delivery across all 48 states.\n\nWe offer competitive rates, real-time tracking, and dedicated account management. I'd love to learn more about your shipping needs and see how we can help." },
      { id: "shipper_quote", label: "Rate Quote", subject: "Rate Quote - Silk Route Logistics", body: "Hi [NAME],\n\nThank you for the opportunity to quote on your freight. Please find our competitive rate below for the requested lane.\n\nWe're confident we can provide reliable service at this rate. Let me know if you'd like to proceed or if you have any questions." },
      { id: "shipper_load_confirm", label: "Load Confirmation", subject: "Load Booked - Silk Route Logistics", body: "Hi [NAME],\n\nGreat news! Your load has been booked and a carrier has been assigned. You can expect pickup at the scheduled time. I'll keep you updated with tracking information throughout transit." },
      { id: "shipper_delivery_update", label: "Delivery Update", subject: "Delivery Update - Silk Route Logistics", body: "Hi [NAME],\n\nI wanted to provide an update on your shipment. The load is currently in transit and on schedule for delivery. I'll notify you once delivery is confirmed." },
      { id: "shipper_invoice", label: "Invoice", subject: "Invoice - Silk Route Logistics", body: "Hi [NAME],\n\nPlease find the invoice for the recently completed shipment. Payment terms are as agreed. If you have any questions about the charges, please don't hesitate to reach out." },
      { id: "shipper_followup", label: "Follow Up", subject: "Following Up - Silk Route Logistics", body: "Hi [NAME],\n\nFollowing up on our previous conversation. I'd love to discuss how we can support your upcoming shipping needs. Do you have any loads coming up that we can help with?" },
      { id: "shipper_thank_you", label: "Thank You", subject: "Thank You - Silk Route Logistics", body: "Hi [NAME],\n\nThank you for trusting Silk Route Logistics with your freight. We value our partnership and are committed to providing you with the best service possible." },
      { id: "shipper_seasonal", label: "Seasonal Capacity", subject: "Secure Your Capacity - Silk Route Logistics", body: "Hi [NAME],\n\nWith peak season approaching, we wanted to reach out early to help you secure reliable capacity for your upcoming shipments.\n\nWe recommend booking in advance to lock in competitive rates and guarantee truck availability. Our carrier network is strong and we can handle:\n- Dry van, reefer, and flatbed\n- Full truckload and LTL\n- Expedited and team driver options\n\nLet's set up a call to discuss your volume forecast and ensure a smooth peak season." },
      { id: "shipper_claims", label: "Claims Resolution", subject: "Claims Update - Silk Route Logistics", body: "Hi [NAME],\n\nI'm writing regarding the freight claim filed for your recent shipment. Our claims team has reviewed the documentation and is working to resolve this as quickly as possible.\n\nWe take cargo integrity seriously and will keep you updated on the resolution timeline. Please let me know if you have any additional documentation to share." },
      { id: "shipper_contract", label: "Contract Renewal", subject: "Partnership Renewal - Silk Route Logistics", body: "Hi [NAME],\n\nAs we approach the renewal period for our freight partnership, I wanted to check in and discuss how we can continue to serve your logistics needs.\n\nOver the past year, we've handled your shipments with a 98%+ on-time delivery rate and we're committed to maintaining that standard. I'd love to schedule a review call to discuss volume commitments, lane pricing, and any new requirements you may have." }
    ];

    function updateTemplateDropdown() {
      var select = document.getElementById("email-template");
      var templates = shipperTemplates; // default
      if (state.currentContact) {
        var type = state.currentContact.entityType;
        if (type === "CARRIER") templates = carrierTemplates;
        else if (type === "SHIPPER") templates = shipperTemplates;
        // INBOX: use shipper templates as default for unknown contacts
      }
      select.innerHTML = templates.map(function(t) {
        return '<option value="' + t.id + '">' + esc(t.label) + '</option>';
      }).join("");
    }

    function loadTemplate() {
      var tplId = document.getElementById("email-template").value;
      if (!tplId) return;
      var textarea = document.getElementById("compose-text");
      var recipientName = state.currentContact ? state.currentContact.name : "there";

      // Find template in both lists
      var tpl = carrierTemplates.concat(shipperTemplates).find(function(t) { return t.id === tplId; });
      if (!tpl) return;

      var body = (tpl.body || "").replace(/\[NAME\]/g, recipientName);
      textarea.value = body;
      document.getElementById("email-subject").value = tpl.subject || "Silk Route Logistics";
    }

    function sendComm() {
      if (!state.currentContact) return;
      var text = document.getElementById("compose-text").value.trim();
      if (!text) return;

      // For INBOX contacts, resolve the entity type/id for logging
      var entityType = state.currentContact.entityType;
      var entityId = state.currentContact.entityId;
      if (entityType === "INBOX") {
        // Use the matched type if sender was matched, otherwise UNKNOWN
        entityType = state.currentContact.matchedType || "UNKNOWN";
        entityId = state.currentContact.matchedId || state.currentContact.email;
      }

      if (state.composeMode === "note") {
        SRL.request("/api/communications", {
          method: "POST",
          body: {
            type: "NOTE",
            direction: "OUTBOUND",
            entityType: entityType,
            entityId: entityId,
            body: text
          }
        }).then(function() {
          document.getElementById("compose-text").value = "";
          loadCommunications(state.currentContact);
          showToast("Note saved", "success");
        }).catch(function(err) {
          showToast("Failed: " + err.message, "error");
        });
      } else {
        // Email
        var to = document.getElementById("email-to").value.trim();
        var subject = document.getElementById("email-subject").value.trim();
        var template = document.getElementById("email-template").value;

        if (!to) { showToast("Enter recipient email", "error"); return; }
        if (!subject) { showToast("Enter subject", "error"); return; }

        var senderName = state.currentUser ? (state.currentUser.firstName + " " + state.currentUser.lastName) : "AE";
        var body = {
          to: to,
          subject: subject,
          entityType: entityType,
          entityId: entityId
        };

        if (template) {
          body.template = template;
          body.templateParams = [state.currentContact.name, senderName, text];
        } else {
          body.customBody = text.replace(/\n/g, "<br>");
        }

        SRL.request("/api/email/send", { method: "POST", body: body }).then(function() {
          document.getElementById("compose-text").value = "";
          loadCommunications(state.currentContact);
          showToast("Email sent", "success");
        }).catch(function(err) {
          showToast("Failed: " + err.message, "error");
        });
      }
    }

    /* ======== HELPERS ======== */
    function getInitials(name) {
      if (!name) return "?";
      var parts = name.trim().split(/\s+/);
      return (parts[0][0] + (parts[1] ? parts[1][0] : "")).toUpperCase();
    }

    function getTypeIcon(type) {
      if (type.includes("CALL")) return "icon-call";
      if (type.includes("TEXT")) return "icon-text";
      if (type.includes("EMAIL")) return "icon-email";
      return "icon-note";
    }

    function getTypeEmoji(type) {
      if (type.includes("CALL")) return "&#128222;";
      if (type.includes("TEXT")) return "&#128172;";
      if (type.includes("EMAIL")) return "&#9993;";
      return "&#128221;";
    }

    function getTypeLabel(type) {
      var labels = {
        CALL_INBOUND: "Incoming Call", CALL_OUTBOUND: "Outgoing Call",
        TEXT_INBOUND: "Text Received", TEXT_OUTBOUND: "Text Sent",
        EMAIL_INBOUND: "Email Received", EMAIL_OUTBOUND: "Email Sent",
        NOTE: "Note"
      };
      return labels[type] || type;
    }

    function formatDuration(seconds) {
      if (!seconds) return "";
      var m = Math.floor(seconds / 60);
      var s = seconds % 60;
      return m + ":" + (s < 10 ? "0" : "") + s;
    }

    function esc(str) {
      if (!str) return "";
      var d = document.createElement("div");
      d.appendChild(document.createTextNode(String(str)));
      return d.innerHTML;
    }

    function timeAgo(dateStr) {
      if (!dateStr) return "";
      var diff = Date.now() - new Date(dateStr).getTime();
      var mins = Math.floor(diff / 60000);
      if (mins < 1) return "just now";
      if (mins < 60) return mins + "m ago";
      var hrs = Math.floor(mins / 60);
      if (hrs < 24) return hrs + "h ago";
      var days = Math.floor(hrs / 24);
      if (days < 30) return days + "d ago";
      return new Date(dateStr).toLocaleDateString("en-US", {month:"short",day:"numeric"});
    }

    function formatRole(role) {
      var m = {ADMIN:"Administrator",BROKER:"Account Executive",DISPATCH:"Dispatch",OPERATIONS:"Operations",CEO:"CEO"};
      return m[role] || role;
    }

    function showToast(msg, type) {
      var el = document.getElementById("toast");
      el.textContent = msg;
      el.className = "toast toast-" + (type||"success") + " show";
      setTimeout(function(){ el.classList.remove("show"); }, 3000);
    }

    function toggleSidebar() {
      document.getElementById("sidebar").classList.toggle("open");
      document.getElementById("overlay").classList.toggle("open");
    }

    function handleLogout() {
      localStorage.removeItem("token");
      sessionStorage.removeItem("token");
      window.location.href = "/auth/login";
    }
  </script>
<script src="/ae/js/notification-bell.js"></script>
<script src="/shared/js/themeEngine.js"></script>
<script src="/shared/js/marco-polo.js"></script>
</body>
</html>
