<!DOCTYPE html>
<html lang="en">
<head>
  <script>
(function(){var A=window.API_URL||'https://api.silkroutelogistics.ai';fetch(A+'/api/build-version').then(function(r){return r.json()}).then(function(d){var s=localStorage.getItem('srl_build_version');if(s&&s!==d.version){localStorage.removeItem('token');localStorage.removeItem('carrier_token');localStorage.removeItem('user');localStorage.removeItem('carrier_user');localStorage.setItem('srl_build_version',d.version);window.location.href='/auth/login.html';return}localStorage.setItem('srl_build_version',d.version)}).catch(function(){})})();
</script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Financial Reports — Silk Route Logistics</title>
  <link rel="icon" href="/logo.png" type="image/png">
  <link rel="stylesheet" href="/ae/css/console.css">
  <link rel="stylesheet" href="/shared/css/themes.css">
  <link rel="stylesheet" href="/shared/css/marco-polo.css">
  <script>(function(){try{var t=localStorage.getItem('srl_theme')||'silk-route-classic';var m=localStorage.getItem('srl_mode')||'light';document.documentElement.setAttribute('data-theme',t);document.documentElement.setAttribute('data-mode',m)}catch(e){document.documentElement.setAttribute('data-theme','silk-route-classic');document.documentElement.setAttribute('data-mode','light')}})()</script>
  <style>
    /* ========== Financial Reports Styles ========== */

    .page-layout { display: flex; min-height: 100vh; }
    .main-content { margin-left: var(--sidebar-width); flex: 1; min-height: 100vh; display: flex; flex-direction: column; }
    .page-header { padding: 24px 32px 0; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px; }
    .page-header h1 { font-size: 24px; font-weight: 700; color: var(--navy); }
    .page-header-actions { display: flex; align-items: center; gap: 10px; }
    .page-body { padding: 20px 32px 32px; flex: 1; }

    /* --- Quick Reports Row --- */
    .quick-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 28px; }
    .quick-card {
      background: var(--white); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm);
      padding: 24px 20px; text-align: center; cursor: pointer; border: 2px solid transparent;
      transition: all 0.2s;
    }
    .quick-card:hover { border-color: var(--gold); transform: translateY(-2px); box-shadow: var(--shadow-md); }
    .quick-card.active { border-color: var(--gold); background: var(--gold-dim); }
    .quick-card-icon { font-size: 28px; margin-bottom: 10px; }
    .quick-card-title { font-size: 15px; font-weight: 700; color: var(--navy); margin-bottom: 4px; }
    .quick-card-desc { font-size: 12px; color: var(--gray-400); }

    /* --- Buttons --- */
    .btn-primary {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 8px 18px; background: var(--gold); color: var(--white);
      border: none; border-radius: 6px; font-size: 13px; font-weight: 600;
      cursor: pointer; white-space: nowrap; text-decoration: none;
    }
    .btn-primary:hover { background: var(--gold-hover); }
    .btn-secondary {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 8px 18px; background: var(--white); color: var(--navy);
      border: 1px solid var(--gray-200); border-radius: 6px; font-size: 13px;
      font-weight: 500; cursor: pointer;
    }
    .btn-secondary:hover { border-color: var(--gold); color: var(--gold); }
    .btn-sm { padding: 6px 12px; font-size: 12px; }
    .btn-danger { background: var(--red); color: var(--white); border: none; border-radius: 6px; padding: 6px 12px; font-size: 12px; font-weight: 600; cursor: pointer; }
    .btn-danger:hover { background: #DC2626; }

    /* --- Report Display Section --- */
    .report-display {
      background: var(--white); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm);
      margin-bottom: 28px; overflow: hidden;
    }
    .report-display-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 20px 24px; border-bottom: 1px solid var(--gray-200);
    }
    .report-display-header h2 { font-size: 18px; font-weight: 700; color: var(--navy); }
    .report-display-body { padding: 24px; }
    .report-period-info { font-size: 13px; color: var(--gray-500); margin-bottom: 20px; padding: 10px 16px; background: var(--gray-50); border-radius: 6px; }

    /* --- Comparison Table --- */
    .comparison-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    .comparison-table th {
      text-align: left; padding: 12px 16px; font-size: 12px; color: var(--gray-400);
      text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid var(--gray-200);
      background: var(--gray-50);
    }
    .comparison-table td { padding: 12px 16px; border-bottom: 1px solid var(--gray-100); font-size: 14px; color: var(--gray-700); }
    .comparison-table tbody tr:hover { background: var(--gray-50); }
    .change-positive { color: #059669; font-weight: 600; }
    .change-negative { color: var(--red); font-weight: 600; }

    /* --- Stats Grid --- */
    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 20px; }
    .stat-card {
      background: var(--gray-50); border-radius: var(--radius); padding: 16px; text-align: center;
    }
    .stat-card-label { font-size: 11px; color: var(--gray-400); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
    .stat-card-value { font-size: 22px; font-weight: 700; color: var(--navy); }
    .stat-card-sub { font-size: 12px; color: var(--gray-400); margin-top: 4px; }

    /* --- Monthly Report Controls --- */
    .month-controls { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; }
    .month-controls select {
      padding: 8px 12px; border: 1px solid var(--gray-200);
      border-radius: 6px; font-size: 13px; outline: none; background: var(--white);
    }
    .month-controls select:focus { border-color: var(--gold); }

    /* --- Profitability Section --- */
    .profit-section { margin-bottom: 28px; }
    .profit-section h2 { font-size: 18px; font-weight: 700; color: var(--navy); margin-bottom: 16px; }
    .profit-tabs {
      display: flex; gap: 0; border-bottom: 2px solid var(--gray-200); margin-bottom: 0;
    }
    .profit-tab {
      padding: 10px 20px; font-size: 14px; font-weight: 500; color: var(--gray-500);
      cursor: pointer; border: none; background: none; border-bottom: 2px solid transparent;
      margin-bottom: -2px; transition: all 0.15s;
    }
    .profit-tab:hover { color: var(--navy); }
    .profit-tab.active { color: var(--gold); border-bottom-color: var(--gold); font-weight: 600; }
    .profit-table-wrap {
      background: var(--white); border-radius: 0 0 var(--radius-lg) var(--radius-lg);
      box-shadow: var(--shadow-sm); overflow-x: auto;
    }

    /* --- Data Table --- */
    .data-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .data-table th {
      text-align: left; padding: 12px 16px; font-size: 11px; color: var(--gray-400);
      text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid var(--gray-200);
      white-space: nowrap; background: var(--gray-50); cursor: pointer;
    }
    .data-table th:hover { color: var(--gold); }
    .data-table td { padding: 12px 16px; border-bottom: 1px solid var(--gray-100); color: var(--gray-700); }
    .data-table tbody tr:hover { background: var(--gray-50); }
    .amount-positive { color: #059669; font-weight: 600; }
    .amount-negative { color: var(--red); font-weight: 600; }

    /* --- Stored Reports Table --- */
    .stored-section { margin-bottom: 28px; }
    .stored-section h2 { font-size: 18px; font-weight: 700; color: var(--navy); margin-bottom: 16px; }
    .stored-table-wrap {
      background: var(--white); border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm); overflow-x: auto;
    }
    .report-type-badge {
      display: inline-block; padding: 3px 8px; border-radius: 4px;
      font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px;
    }
    .report-type-badge.WEEKLY { background: rgba(59,130,246,0.1); color: #2563EB; }
    .report-type-badge.MONTHLY { background: rgba(168,85,247,0.1); color: #7C3AED; }
    .report-type-badge.QUARTERLY { background: var(--gold-dim); color: var(--gold); }
    .report-type-badge.ANNUAL { background: var(--green-bg); color: #059669; }
    .report-type-badge.CUSTOM { background: var(--amber-bg); color: #B45309; }
    .status-badge {
      display: inline-block; padding: 3px 8px; border-radius: 4px;
      font-size: 11px; font-weight: 600; text-transform: uppercase;
    }
    .status-badge.COMPLETED { background: var(--green-bg); color: #059669; }
    .status-badge.PENDING { background: var(--amber-bg); color: #B45309; }
    .status-badge.FAILED { background: var(--red-bg); color: var(--red); }
    .status-badge.GENERATING { background: rgba(59,130,246,0.1); color: #2563EB; }

    /* --- Modal --- */
    .modal-overlay {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5);
      z-index: 500; align-items: center; justify-content: center;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: var(--white); border-radius: var(--radius-lg); box-shadow: var(--shadow-lg);
      width: 520px; max-width: 90vw; max-height: 85vh; overflow-y: auto;
    }
    .modal-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 20px 24px; border-bottom: 1px solid var(--gray-200);
    }
    .modal-header h2 { font-size: 18px; font-weight: 700; color: var(--navy); }
    .modal-close {
      background: none; border: none; font-size: 24px; color: var(--gray-400);
      cursor: pointer; line-height: 1;
    }
    .modal-close:hover { color: var(--red); }
    .modal-body { padding: 24px; }
    .modal-footer { padding: 16px 24px; border-top: 1px solid var(--gray-200); display: flex; justify-content: flex-end; gap: 10px; }

    /* --- Form --- */
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-size: 13px; font-weight: 600; color: var(--navy); margin-bottom: 6px; }
    .form-group input, .form-group textarea, .form-group select {
      width: 100%; padding: 10px 12px; border: 1px solid var(--gray-200);
      border-radius: 6px; font-size: 14px; outline: none; font-family: inherit;
      background: var(--white);
    }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus { border-color: var(--gold); }
    .form-group textarea { resize: vertical; min-height: 60px; }
    .form-hint { font-size: 12px; color: var(--gray-400); margin-top: 4px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

    /* --- Filter Bar --- */
    .filter-bar {
      display: flex; align-items: center; gap: 12px;
      padding: 16px 20px; background: var(--white);
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
      border-bottom: 1px solid var(--gray-200);
      box-shadow: var(--shadow-sm); flex-wrap: wrap;
    }
    .filter-bar select, .filter-bar input {
      padding: 8px 12px; border: 1px solid var(--gray-200);
      border-radius: 6px; font-size: 13px; outline: none; background: var(--white);
    }
    .filter-bar select:focus, .filter-bar input:focus { border-color: var(--gold); }
    .filter-spacer { flex: 1; }

    /* --- Empty & Loading --- */
    .empty-state { text-align: center; padding: 48px 20px; color: var(--gray-400); font-size: 14px; }
    .empty-state-icon { font-size: 36px; margin-bottom: 12px; opacity: 0.4; }
    .loading-spinner {
      display: flex; align-items: center; justify-content: center; padding: 48px;
      color: var(--gray-400); font-size: 14px; gap: 8px;
    }
    .spinner {
      width: 20px; height: 20px; border: 2px solid var(--gray-200);
      border-top-color: var(--gold); border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    /* --- Unauthorized --- */
    .unauthorized {
      display: flex; align-items: center; justify-content: center;
      min-height: 60vh; flex-direction: column; gap: 12px; color: var(--gray-400);
    }
    .unauthorized h2 { color: var(--red); font-size: 20px; }

    /* --- Sort Indicator --- */
    .sort-asc::after { content: ' \u25B2'; font-size: 9px; }
    .sort-desc::after { content: ' \u25BC'; font-size: 9px; }

    /* --- Responsive --- */
    @media (max-width: 1200px) {
      .quick-row { grid-template-columns: repeat(2, 1fr); }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 1024px) {
      .main-content { margin-left: 0; }
      .page-header { padding: 64px 20px 0; }
      .page-body { padding: 20px; }
    }
    @media (max-width: 640px) {
      .quick-row { grid-template-columns: 1fr; }
      .stats-grid { grid-template-columns: 1fr 1fr; }
      .form-row { grid-template-columns: 1fr; }
      .profit-tabs { overflow-x: auto; }
    }
  </style>
</head>
<body>
  <div class="page-layout">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-logo"><img src="/logo.png" alt="SRL"><span>SRL Command</span></div>
      <div class="sidebar-user">
        <div class="sidebar-user-name" id="user-name">--</div>
        <div class="sidebar-user-role" id="user-role">--</div>
      </div>
      <nav class="sidebar-nav">
        <a href="/ae/dashboard">Dashboard</a>
        <a href="/ae/loads.html">Load Board</a>
        <a href="/ae/caravan.html">The Caravan</a>
        <a href="/ae/crm.html">CRM</a>
        <a href="/ae/communications.html">Communications</a>
        <a href="/ae/claims.html">Claims</a>
        <a href="/ae/financials.html">Lead Hunter</a>
        <a href="/ae/training.html">Training</a>
        <a href="/ae/analytics.html">Analytics</a>
        <div style="border-top:1px solid var(--gray-200);margin:12px 0;padding-top:12px;">
          <div style="font-size:10px;color:var(--gray-400);text-transform:uppercase;letter-spacing:1px;padding:0 16px 8px;">Accounting</div>
          <a href="/ae/accounting/dashboard.html">Acct Dashboard</a>
          <a href="/ae/accounting/payable.html">Accounts Payable</a>
          <a href="/ae/accounting/receivable.html">Accounts Receivable</a>
          <a href="/ae/accounting/fund.html">Factoring Fund</a>
          <a href="/ae/accounting/reports.html" class="active">Reports</a>
          <a href="/ae/accounting/approvals.html">Approvals</a>
          <a href="/ae/accounting/analytics.html">Analytics</a>
        </div>

        <div style="border-top:1px solid var(--gray-200);margin:12px 0;padding-top:12px;">
          <div style="font-size:10px;color:var(--gray-400);text-transform:uppercase;letter-spacing:1px;padding:0 16px 8px;">Compliance</div>
          <a href="/ae/compliance/dashboard.html"><svg class="sidebar-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>Dashboard</a>
          <a href="/ae/compliance/overview.html"><svg class="sidebar-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>Overview</a>
          <a href="/ae/compliance/alerts.html"><svg class="sidebar-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>Alerts</a>
        </div>
      </nav>
      <div class="sidebar-footer"><button onclick="handleLogout()">Sign Out</button></div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="page-header">
        <div>
          <h1>Financial Reports</h1>
          <p style="font-size:14px;color:var(--gray-500);margin-top:4px;">Generate, view, and export financial reports</p>
        </div>
        <div class="page-header-actions">
          <button class="btn-secondary btn-sm" onclick="refreshStoredReports()">Refresh</button>
        </div>
      </div>

      <div class="page-body" id="page-body">
        <!-- Loading State -->
        <div class="loading-spinner" id="loading-state">
          <div class="spinner"></div>
          <span>Loading reports...</span>
        </div>

        <!-- Unauthorized State -->
        <div class="unauthorized" id="unauthorized-state" style="display:none;">
          <h2>Access Denied</h2>
          <p>You do not have permission to view this page. Required role: ADMIN, CEO, or ACCOUNTING.</p>
        </div>

        <!-- Main Content Container -->
        <div id="main-container" style="display:none;">

          <!-- Quick Reports Row -->
          <div class="quick-row">
            <div class="quick-card" id="qr-weekly" onclick="selectQuickReport('weekly')">
              <div class="quick-card-icon">&#128197;</div>
              <div class="quick-card-title">Weekly Report</div>
              <div class="quick-card-desc">Current vs previous week comparison</div>
            </div>
            <div class="quick-card" id="qr-monthly" onclick="selectQuickReport('monthly')">
              <div class="quick-card-icon">&#128200;</div>
              <div class="quick-card-title">Monthly Report</div>
              <div class="quick-card-desc">Detailed monthly financial breakdown</div>
            </div>
            <div class="quick-card" id="qr-generate" onclick="openGenerateModal()">
              <div class="quick-card-icon">&#128221;</div>
              <div class="quick-card-title">Generate Custom Report</div>
              <div class="quick-card-desc">Create a report for any period</div>
            </div>
            <div class="quick-card" id="qr-export" onclick="openExportModal()">
              <div class="quick-card-icon">&#128229;</div>
              <div class="quick-card-title">Export Data</div>
              <div class="quick-card-desc">Download invoices, payments, and more</div>
            </div>
          </div>

          <!-- Report Display Area (hidden by default) -->
          <div class="report-display" id="report-display" style="display:none;">
            <div class="report-display-header">
              <h2 id="report-display-title">Report</h2>
              <button class="btn-secondary btn-sm" onclick="closeReportDisplay()">Close</button>
            </div>
            <div class="report-display-body" id="report-display-body">
              <div class="loading-spinner"><div class="spinner"></div><span>Loading report...</span></div>
            </div>
          </div>

          <!-- Profitability Section -->
          <div class="profit-section">
            <h2>Profitability Analysis</h2>
            <div class="profit-tabs" id="profit-tabs">
              <button class="profit-tab active" data-tab="loads" onclick="selectProfitTab('loads')">By Load</button>
              <button class="profit-tab" data-tab="lanes" onclick="selectProfitTab('lanes')">By Lane</button>
              <button class="profit-tab" data-tab="carriers" onclick="selectProfitTab('carriers')">By Carrier</button>
              <button class="profit-tab" data-tab="shippers" onclick="selectProfitTab('shippers')">By Shipper</button>
            </div>
            <div class="profit-table-wrap">
              <table class="data-table" id="profit-table">
                <thead id="profit-thead"></thead>
                <tbody id="profit-tbody">
                  <tr><td colspan="8"><div class="loading-spinner"><div class="spinner"></div><span>Loading profitability data...</span></div></td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Stored Reports -->
          <div class="stored-section">
            <h2>Stored Reports</h2>
            <div class="stored-table-wrap">
              <table class="data-table" id="stored-table">
                <thead>
                  <tr>
                    <th>Title</th>
                    <th>Type</th>
                    <th>Period</th>
                    <th>Status</th>
                    <th>Generated By</th>
                    <th>Date</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="stored-tbody">
                  <tr><td colspan="7"><div class="loading-spinner"><div class="spinner"></div><span>Loading stored reports...</span></div></td></tr>
                </tbody>
              </table>
            </div>
          </div>

        </div><!-- /main-container -->
      </div><!-- /page-body -->

      <!-- Footer -->
      <footer class="main-footer">
        <span>Silk Route Logistics &copy; 2026</span>
        <span id="last-updated"></span>
      </footer>
    </main>
  </div>

  <!-- Generate Report Modal -->
  <div class="modal-overlay" id="generate-modal">
    <div class="modal">
      <div class="modal-header">
        <h2>Generate Custom Report</h2>
        <button class="modal-close" onclick="closeGenerateModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="gen-title">Report Title</label>
          <input type="text" id="gen-title" placeholder="e.g. Q1 2026 Financial Summary">
        </div>
        <div class="form-group">
          <label for="gen-type">Report Type</label>
          <select id="gen-type">
            <option value="WEEKLY">Weekly</option>
            <option value="MONTHLY">Monthly</option>
            <option value="QUARTERLY">Quarterly</option>
            <option value="ANNUAL">Annual</option>
            <option value="CUSTOM">Custom</option>
          </select>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="gen-start">Period Start</label>
            <input type="date" id="gen-start">
          </div>
          <div class="form-group">
            <label for="gen-end">Period End</label>
            <input type="date" id="gen-end">
          </div>
        </div>
        <div id="gen-error" style="color:var(--red);font-size:13px;margin-top:8px;display:none;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeGenerateModal()">Cancel</button>
        <button class="btn-primary" id="gen-submit-btn" onclick="submitGenerateReport()">Generate Report</button>
      </div>
    </div>
  </div>

  <!-- Export Modal -->
  <div class="modal-overlay" id="export-modal">
    <div class="modal">
      <div class="modal-header">
        <h2>Export Data</h2>
        <button class="modal-close" onclick="closeExportModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="exp-type">Data Type</label>
          <select id="exp-type">
            <option value="invoices">Invoices</option>
            <option value="payments">Payments</option>
            <option value="disputes">Disputes</option>
            <option value="loads">Loads</option>
            <option value="credit">Credit</option>
          </select>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="exp-from">Date From</label>
            <input type="date" id="exp-from">
          </div>
          <div class="form-group">
            <label for="exp-to">Date To</label>
            <input type="date" id="exp-to">
          </div>
        </div>
        <div class="form-group">
          <label for="exp-format">Format</label>
          <select id="exp-format">
            <option value="JSON">JSON</option>
            <option value="CSV">CSV</option>
          </select>
        </div>
        <div id="exp-error" style="color:var(--red);font-size:13px;margin-top:8px;display:none;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeExportModal()">Cancel</button>
        <button class="btn-primary" id="exp-submit-btn" onclick="submitExport()">Export</button>
      </div>
    </div>
  </div>

  <script src="/js/auth.js"></script>
  <script src="/js/session-timeout.js"></script>
  <script src="/ae/js/api.js"></script>
  <script>
    /* ============================
       Financial Reports — Controller
       ============================ */

    // --- State ---
    var currentUser = null;
    var activeQuickReport = null;
    var activeProfitTab = 'loads';
    var profitData = {};
    var profitSortField = null;
    var profitSortDir = 'desc';

    // --- Helpers ---
    function fmt(n) {
      if (n === null || n === undefined) return '$0.00';
      var num = parseFloat(n);
      if (isNaN(num)) return '$0.00';
      var sign = num < 0 ? '-' : '';
      var abs = Math.abs(num).toFixed(2);
      var parts = abs.split('.');
      parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      return sign + '$' + parts.join('.');
    }

    function fmtPct(n) {
      if (n === null || n === undefined) return '0.0%';
      return parseFloat(n).toFixed(1) + '%';
    }

    function fmtDate(dateStr) {
      if (!dateStr) return '--';
      var d = new Date(dateStr);
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function fmtDateTime(dateStr) {
      if (!dateStr) return '--';
      var d = new Date(dateStr);
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) +
        ' ' + d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    }

    function changeClass(val) {
      var num = parseFloat(val);
      if (num > 0) return 'change-positive';
      if (num < 0) return 'change-negative';
      return '';
    }

    function changePctHtml(val) {
      var num = parseFloat(val);
      if (isNaN(num)) return '<span>--</span>';
      var cls = num > 0 ? 'change-positive' : (num < 0 ? 'change-negative' : '');
      var prefix = num > 0 ? '+' : '';
      return '<span class="' + cls + '">' + prefix + num.toFixed(1) + '%</span>';
    }

    function changeAmtHtml(val) {
      var num = parseFloat(val);
      if (isNaN(num)) return '<span>--</span>';
      var cls = num > 0 ? 'change-positive' : (num < 0 ? 'change-negative' : '');
      var prefix = num > 0 ? '+' : '';
      return '<span class="' + cls + '">' + prefix + fmt(num) + '</span>';
    }

    function escHtml(str) {
      if (!str) return '';
      var div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // --- Auth ---
    function handleLogout() {
      localStorage.removeItem('token');
      sessionStorage.removeItem('token');
      window.location.href = '/auth/login';
    }

    function checkAuth() {
      return SRL.getMe().then(function(user) {
        currentUser = user;
        if(window.SRLTheme)SRLTheme.restoreFromUser(user);
        var allowed = ['ADMIN', 'CEO', 'ACCOUNTING'];
        if (allowed.indexOf(user.role) === -1) {
          document.getElementById('loading-state').style.display = 'none';
          document.getElementById('unauthorized-state').style.display = 'flex';
          return Promise.reject(new Error('Unauthorized role'));
        }
        document.getElementById('user-name').textContent = user.name || user.email;
        document.getElementById('user-role').textContent = user.role;
        return user;
      }).catch(function(err) {
        if (err.message === 'Unauthorized role') throw err;
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('unauthorized-state').style.display = 'flex';
        throw err;
      });
    }

    // --- Quick Report Selection ---
    function selectQuickReport(type) {
      // Reset all quick cards
      document.querySelectorAll('.quick-card').forEach(function(c) { c.classList.remove('active'); });

      if (type === 'weekly') {
        document.getElementById('qr-weekly').classList.add('active');
        activeQuickReport = 'weekly';
        loadWeeklyReport();
      } else if (type === 'monthly') {
        document.getElementById('qr-monthly').classList.add('active');
        activeQuickReport = 'monthly';
        loadMonthlyReport();
      }
    }

    function closeReportDisplay() {
      document.getElementById('report-display').style.display = 'none';
      document.querySelectorAll('.quick-card').forEach(function(c) { c.classList.remove('active'); });
      activeQuickReport = null;
    }

    // --- Weekly Report ---
    function loadWeeklyReport() {
      var display = document.getElementById('report-display');
      display.style.display = 'block';
      document.getElementById('report-display-title').textContent = 'Weekly Financial Report';
      document.getElementById('report-display-body').innerHTML =
        '<div class="loading-spinner"><div class="spinner"></div><span>Loading weekly report...</span></div>';

      SRL.acctWeeklyReport().then(function(data) {
        renderWeeklyReport(data);
      }).catch(function(err) {
        document.getElementById('report-display-body').innerHTML =
          '<div class="empty-state"><div class="empty-state-icon">&#9888;</div>Failed to load weekly report: ' + escHtml(err.message) + '</div>';
      });
    }

    function renderWeeklyReport(data) {
      var body = document.getElementById('report-display-body');
      var html = '';

      // Period info
      var periodText = data.period || 'Current Week';
      html += '<div class="report-period-info">Period: ' + escHtml(typeof periodText === 'string' ? periodText : (periodText.start + ' to ' + periodText.end)) + '</div>';

      // Comparison table
      html += '<table class="comparison-table">';
      html += '<thead><tr><th>Metric</th><th>Current Week</th><th>Previous Week</th><th>Change</th></tr></thead>';
      html += '<tbody>';

      var cur = data.current || {};
      var prev = data.previous || {};
      var change = data.change || {};

      var rows = [
        { label: 'Load Count', curVal: cur.loadCount || 0, prevVal: prev.loadCount || 0, changePct: change.loadCount },
        { label: 'Revenue', curVal: fmt(cur.revenue), prevVal: fmt(prev.revenue), changePct: change.revenue },
        { label: 'Cost', curVal: fmt(cur.cost), prevVal: fmt(prev.cost), changePct: null },
        { label: 'Margin', curVal: fmt(cur.margin), prevVal: fmt(prev.margin), changePct: change.margin },
        { label: 'Avg Margin %', curVal: fmtPct(cur.avgMarginPercent), prevVal: fmtPct(prev.avgMarginPercent), changePct: null }
      ];

      rows.forEach(function(row) {
        html += '<tr>';
        html += '<td style="font-weight:600;">' + row.label + '</td>';
        html += '<td>' + row.curVal + '</td>';
        html += '<td>' + row.prevVal + '</td>';
        html += '<td>' + (row.changePct !== null && row.changePct !== undefined ? changePctHtml(row.changePct) : '--') + '</td>';
        html += '</tr>';
      });

      html += '</tbody></table>';

      // Stats grid
      html += '<div class="stats-grid">';
      html += '<div class="stat-card"><div class="stat-card-label">Invoices Sent</div><div class="stat-card-value">' + (data.invoicesSent || 0) + '</div></div>';

      var pmCount = data.paymentsMade ? data.paymentsMade.count : 0;
      var pmTotal = data.paymentsMade ? data.paymentsMade.total : 0;
      html += '<div class="stat-card"><div class="stat-card-label">Payments Made</div><div class="stat-card-value">' + pmCount + '</div><div class="stat-card-sub">' + fmt(pmTotal) + '</div></div>';

      var prCount = data.paymentsReceived ? data.paymentsReceived.count : 0;
      var prTotal = data.paymentsReceived ? data.paymentsReceived.total : 0;
      html += '<div class="stat-card"><div class="stat-card-label">Payments Received</div><div class="stat-card-value">' + prCount + '</div><div class="stat-card-sub">' + fmt(prTotal) + '</div></div>';

      html += '<div class="stat-card"><div class="stat-card-label">Open Disputes</div><div class="stat-card-value">' + (data.openDisputes || 0) + '</div></div>';
      html += '</div>';

      body.innerHTML = html;
    }

    // --- Monthly Report ---
    function loadMonthlyReport(month, year) {
      var display = document.getElementById('report-display');
      display.style.display = 'block';
      document.getElementById('report-display-title').textContent = 'Monthly Financial Report';

      var now = new Date();
      if (!month) month = now.getMonth() + 1;
      if (!year) year = now.getFullYear();

      var controlsHtml = '<div class="month-controls">' +
        '<select id="monthly-month" onchange="reloadMonthly()">';
      var monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      for (var i = 0; i < 12; i++) {
        controlsHtml += '<option value="' + (i + 1) + '"' + (month === i + 1 ? ' selected' : '') + '>' + monthNames[i] + '</option>';
      }
      controlsHtml += '</select>';
      controlsHtml += '<select id="monthly-year" onchange="reloadMonthly()">';
      for (var y = now.getFullYear(); y >= now.getFullYear() - 3; y--) {
        controlsHtml += '<option value="' + y + '"' + (year === y ? ' selected' : '') + '>' + y + '</option>';
      }
      controlsHtml += '</select>';
      controlsHtml += '<button class="btn-secondary btn-sm" onclick="reloadMonthly()">Load</button>';
      controlsHtml += '</div>';
      controlsHtml += '<div id="monthly-content"><div class="loading-spinner"><div class="spinner"></div><span>Loading monthly report...</span></div></div>';

      document.getElementById('report-display-body').innerHTML = controlsHtml;

      SRL.acctMonthlyReport({ month: month, year: year }).then(function(data) {
        renderMonthlyReport(data);
      }).catch(function(err) {
        document.getElementById('monthly-content').innerHTML =
          '<div class="empty-state"><div class="empty-state-icon">&#9888;</div>Failed to load monthly report: ' + escHtml(err.message) + '</div>';
      });
    }

    function reloadMonthly() {
      var month = parseInt(document.getElementById('monthly-month').value);
      var year = parseInt(document.getElementById('monthly-year').value);

      document.getElementById('monthly-content').innerHTML =
        '<div class="loading-spinner"><div class="spinner"></div><span>Loading monthly report...</span></div>';

      SRL.acctMonthlyReport({ month: month, year: year }).then(function(data) {
        renderMonthlyReport(data);
      }).catch(function(err) {
        document.getElementById('monthly-content').innerHTML =
          '<div class="empty-state"><div class="empty-state-icon">&#9888;</div>Failed to load monthly report: ' + escHtml(err.message) + '</div>';
      });
    }

    function renderMonthlyReport(data) {
      var container = document.getElementById('monthly-content');
      var html = '';

      // Period info
      var periodText = data.period || 'Selected Month';
      html += '<div class="report-period-info">Period: ' + escHtml(typeof periodText === 'string' ? periodText : (periodText.month + '/' + periodText.year)) + '</div>';

      // Comparison table
      html += '<table class="comparison-table">';
      html += '<thead><tr><th>Metric</th><th>Current Month</th><th>Previous Month</th><th>Change</th></tr></thead>';
      html += '<tbody>';

      var cur = data.current || {};
      var prev = data.previous || {};
      var change = data.change || {};

      var rows = [
        { label: 'Load Count', curVal: cur.loadCount || 0, prevVal: prev.loadCount || 0, changePct: change.loadCount },
        { label: 'Revenue', curVal: fmt(cur.revenue), prevVal: fmt(prev.revenue), changePct: change.revenue },
        { label: 'Cost', curVal: fmt(cur.cost), prevVal: fmt(prev.cost), changePct: null },
        { label: 'Margin', curVal: fmt(cur.margin), prevVal: fmt(prev.margin), changePct: change.margin },
        { label: 'Avg Margin %', curVal: fmtPct(cur.avgMarginPercent), prevVal: fmtPct(prev.avgMarginPercent), changePct: null }
      ];

      rows.forEach(function(row) {
        html += '<tr>';
        html += '<td style="font-weight:600;">' + row.label + '</td>';
        html += '<td>' + row.curVal + '</td>';
        html += '<td>' + row.prevVal + '</td>';
        html += '<td>' + (row.changePct !== null && row.changePct !== undefined ? changePctHtml(row.changePct) : '--') + '</td>';
        html += '</tr>';
      });

      html += '</tbody></table>';

      // Stats grid
      html += '<div class="stats-grid">';
      html += '<div class="stat-card"><div class="stat-card-label">Invoices Sent</div><div class="stat-card-value">' + (data.invoicesSent || 0) + '</div></div>';

      var pmCount = data.paymentsMade ? data.paymentsMade.count : 0;
      var pmTotal = data.paymentsMade ? data.paymentsMade.total : 0;
      html += '<div class="stat-card"><div class="stat-card-label">Payments Made</div><div class="stat-card-value">' + pmCount + '</div><div class="stat-card-sub">' + fmt(pmTotal) + '</div></div>';

      var prCount = data.paymentsReceived ? data.paymentsReceived.count : 0;
      var prTotal = data.paymentsReceived ? data.paymentsReceived.total : 0;
      html += '<div class="stat-card"><div class="stat-card-label">Payments Received</div><div class="stat-card-value">' + prCount + '</div><div class="stat-card-sub">' + fmt(prTotal) + '</div></div>';

      html += '<div class="stat-card"><div class="stat-card-label">Open Disputes</div><div class="stat-card-value">' + (data.openDisputes || 0) + '</div></div>';
      html += '</div>';

      // Equipment breakdown (if available)
      if (data.equipmentBreakdown && data.equipmentBreakdown.length > 0) {
        html += '<h3 style="font-size:15px;font-weight:600;color:var(--navy);margin:24px 0 12px;">Equipment Breakdown</h3>';
        html += '<table class="comparison-table">';
        html += '<thead><tr><th>Equipment Type</th><th>Loads</th><th>Revenue</th><th>Cost</th><th>Margin</th></tr></thead>';
        html += '<tbody>';
        data.equipmentBreakdown.forEach(function(eq) {
          html += '<tr>';
          html += '<td style="font-weight:600;">' + escHtml(eq.type || eq.equipmentType) + '</td>';
          html += '<td>' + (eq.loadCount || eq.count || 0) + '</td>';
          html += '<td>' + fmt(eq.revenue) + '</td>';
          html += '<td>' + fmt(eq.cost) + '</td>';
          html += '<td class="' + changeClass(eq.margin) + '">' + fmt(eq.margin) + '</td>';
          html += '</tr>';
        });
        html += '</tbody></table>';
      }

      // Dispute stats (if available)
      if (data.disputeStats) {
        var ds = data.disputeStats;
        html += '<h3 style="font-size:15px;font-weight:600;color:var(--navy);margin:24px 0 12px;">Dispute Statistics</h3>';
        html += '<div class="stats-grid">';
        html += '<div class="stat-card"><div class="stat-card-label">Total Disputes</div><div class="stat-card-value">' + (ds.total || 0) + '</div></div>';
        html += '<div class="stat-card"><div class="stat-card-label">Resolved</div><div class="stat-card-value">' + (ds.resolved || 0) + '</div></div>';
        html += '<div class="stat-card"><div class="stat-card-label">Pending</div><div class="stat-card-value">' + (ds.pending || ds.open || 0) + '</div></div>';
        html += '<div class="stat-card"><div class="stat-card-label">Total Amount</div><div class="stat-card-value">' + fmt(ds.totalAmount) + '</div></div>';
        html += '</div>';
      }

      container.innerHTML = html;
    }

    // --- Profitability Tabs ---
    function selectProfitTab(tab) {
      activeProfitTab = tab;

      document.querySelectorAll('.profit-tab').forEach(function(t) {
        t.classList.toggle('active', t.getAttribute('data-tab') === tab);
      });

      // Reset sort
      profitSortField = null;
      profitSortDir = 'desc';

      // Load data if not cached
      if (profitData[tab]) {
        renderProfitTable(tab, profitData[tab]);
      } else {
        loadProfitData(tab);
      }
    }

    function loadProfitData(tab) {
      document.getElementById('profit-tbody').innerHTML =
        '<tr><td colspan="8"><div class="loading-spinner"><div class="spinner"></div><span>Loading profitability data...</span></div></td></tr>';
      document.getElementById('profit-thead').innerHTML = '';

      var loader;
      switch (tab) {
        case 'loads': loader = SRL.acctPnlLoads(); break;
        case 'lanes': loader = SRL.acctLaneProfitability(); break;
        case 'carriers': loader = SRL.acctCarrierProfitability(); break;
        case 'shippers': loader = SRL.acctShipperProfitability(); break;
        default: return;
      }

      loader.then(function(data) {
        var items = data.data || data.loads || data.lanes || data.carriers || data.shippers || data || [];
        if (Array.isArray(items)) {
          profitData[tab] = items;
        } else {
          profitData[tab] = [];
        }
        renderProfitTable(tab, profitData[tab]);
      }).catch(function(err) {
        console.error('Profitability error:', err);
        document.getElementById('profit-tbody').innerHTML =
          '<tr><td colspan="8"><div class="empty-state">Failed to load profitability data: ' + escHtml(err.message) + '</div></td></tr>';
      });
    }

    function renderProfitTable(tab, data) {
      var thead = document.getElementById('profit-thead');
      var tbody = document.getElementById('profit-tbody');

      // Define columns per tab
      var columns;
      switch (tab) {
        case 'loads':
          columns = [
            { key: 'loadNumber', label: 'Load #', fmt: 'text' },
            { key: 'origin', label: 'Origin', fmt: 'text' },
            { key: 'destination', label: 'Destination', fmt: 'text' },
            { key: 'revenue', label: 'Revenue', fmt: 'money' },
            { key: 'cost', label: 'Cost', fmt: 'money' },
            { key: 'margin', label: 'Margin', fmt: 'money-color' },
            { key: 'marginPercent', label: 'Margin %', fmt: 'pct-color' }
          ];
          break;
        case 'lanes':
          columns = [
            { key: 'lane', label: 'Lane', fmt: 'text' },
            { key: 'loadCount', label: 'Loads', fmt: 'number' },
            { key: 'totalRevenue', label: 'Revenue', fmt: 'money' },
            { key: 'totalCost', label: 'Cost', fmt: 'money' },
            { key: 'totalMargin', label: 'Margin', fmt: 'money-color' },
            { key: 'avgMarginPercent', label: 'Avg Margin %', fmt: 'pct-color' },
            { key: 'avgRPM', label: 'Avg RPM', fmt: 'money' }
          ];
          break;
        case 'carriers':
          columns = [
            { key: 'carrierName', label: 'Carrier', fmt: 'text' },
            { key: 'loadCount', label: 'Loads', fmt: 'number' },
            { key: 'totalPaid', label: 'Total Paid', fmt: 'money' },
            { key: 'totalRevenue', label: 'Revenue', fmt: 'money' },
            { key: 'totalMargin', label: 'Margin', fmt: 'money-color' },
            { key: 'avgMarginPercent', label: 'Avg Margin %', fmt: 'pct-color' },
            { key: 'onTimePercent', label: 'On-Time %', fmt: 'pct' }
          ];
          break;
        case 'shippers':
          columns = [
            { key: 'shipperName', label: 'Shipper', fmt: 'text' },
            { key: 'loadCount', label: 'Loads', fmt: 'number' },
            { key: 'totalRevenue', label: 'Revenue', fmt: 'money' },
            { key: 'totalCost', label: 'Cost', fmt: 'money' },
            { key: 'totalMargin', label: 'Margin', fmt: 'money-color' },
            { key: 'avgMarginPercent', label: 'Avg Margin %', fmt: 'pct-color' },
            { key: 'avgDaysToPay', label: 'Avg Days to Pay', fmt: 'number' }
          ];
          break;
      }

      // Render header
      var hHtml = '<tr>';
      columns.forEach(function(col) {
        var sortCls = '';
        if (profitSortField === col.key) {
          sortCls = profitSortDir === 'asc' ? 'sort-asc' : 'sort-desc';
        }
        hHtml += '<th class="' + sortCls + '" onclick="sortProfitBy(\'' + col.key + '\')">' + col.label + '</th>';
      });
      hHtml += '</tr>';
      thead.innerHTML = hHtml;

      // Sort data if needed
      var sorted = data.slice();
      if (profitSortField) {
        sorted.sort(function(a, b) {
          var aVal = a[profitSortField];
          var bVal = b[profitSortField];
          if (typeof aVal === 'string') aVal = aVal.toLowerCase();
          if (typeof bVal === 'string') bVal = bVal.toLowerCase();
          var numA = parseFloat(aVal);
          var numB = parseFloat(bVal);
          if (!isNaN(numA) && !isNaN(numB)) { aVal = numA; bVal = numB; }
          if (aVal < bVal) return profitSortDir === 'asc' ? -1 : 1;
          if (aVal > bVal) return profitSortDir === 'asc' ? 1 : -1;
          return 0;
        });
      }

      // Render body
      if (!sorted || sorted.length === 0) {
        tbody.innerHTML = '<tr><td colspan="' + columns.length + '"><div class="empty-state"><div class="empty-state-icon">&#128202;</div>No profitability data available</div></td></tr>';
        return;
      }

      var bHtml = '';
      sorted.forEach(function(row) {
        bHtml += '<tr>';
        columns.forEach(function(col) {
          var val = row[col.key];
          var cellHtml = '';
          switch (col.fmt) {
            case 'text': cellHtml = escHtml(val || '--'); break;
            case 'number': cellHtml = val !== null && val !== undefined ? val : '--'; break;
            case 'money': cellHtml = fmt(val); break;
            case 'money-color':
              var n = parseFloat(val);
              cellHtml = '<span class="' + (n >= 0 ? 'amount-positive' : 'amount-negative') + '">' + fmt(val) + '</span>';
              break;
            case 'pct': cellHtml = fmtPct(val); break;
            case 'pct-color':
              var p = parseFloat(val);
              cellHtml = '<span class="' + (p >= 0 ? 'change-positive' : 'change-negative') + '">' + fmtPct(val) + '</span>';
              break;
            default: cellHtml = escHtml(val || '--');
          }
          bHtml += '<td>' + cellHtml + '</td>';
        });
        bHtml += '</tr>';
      });

      tbody.innerHTML = bHtml;
    }

    function sortProfitBy(field) {
      if (profitSortField === field) {
        profitSortDir = profitSortDir === 'asc' ? 'desc' : 'asc';
      } else {
        profitSortField = field;
        profitSortDir = 'desc';
      }
      if (profitData[activeProfitTab]) {
        renderProfitTable(activeProfitTab, profitData[activeProfitTab]);
      }
    }

    // --- Stored Reports ---
    function refreshStoredReports() {
      document.getElementById('stored-tbody').innerHTML =
        '<tr><td colspan="7"><div class="loading-spinner"><div class="spinner"></div><span>Loading stored reports...</span></div></td></tr>';

      SRL.acctStoredReports().then(function(data) {
        var reports = data.reports || data.data || data || [];
        renderStoredReports(Array.isArray(reports) ? reports : []);
      }).catch(function(err) {
        console.error('Stored reports error:', err);
        document.getElementById('stored-tbody').innerHTML =
          '<tr><td colspan="7"><div class="empty-state">Failed to load stored reports: ' + escHtml(err.message) + '</div></td></tr>';
      });
    }

    function renderStoredReports(reports) {
      var tbody = document.getElementById('stored-tbody');

      if (!reports || reports.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><div class="empty-state-icon">&#128196;</div>No stored reports yet. Generate one above.</div></td></tr>';
        return;
      }

      var html = '';
      reports.forEach(function(r) {
        var type = r.reportType || r.type || 'CUSTOM';
        var status = r.status || 'COMPLETED';
        var periodStr = '';
        if (r.periodStart && r.periodEnd) {
          periodStr = fmtDate(r.periodStart) + ' - ' + fmtDate(r.periodEnd);
        } else if (r.period) {
          periodStr = typeof r.period === 'string' ? r.period : JSON.stringify(r.period);
        } else {
          periodStr = '--';
        }

        html += '<tr>';
        html += '<td style="font-weight:600;">' + escHtml(r.title || 'Untitled Report') + '</td>';
        html += '<td><span class="report-type-badge ' + escHtml(type) + '">' + escHtml(type) + '</span></td>';
        html += '<td>' + escHtml(periodStr) + '</td>';
        html += '<td><span class="status-badge ' + escHtml(status) + '">' + escHtml(status) + '</span></td>';
        html += '<td>' + escHtml(r.generatedByName || r.generatedBy || '--') + '</td>';
        html += '<td>' + fmtDateTime(r.createdAt || r.date) + '</td>';
        html += '<td>';
        if (currentUser && (currentUser.role === 'ADMIN' || currentUser.role === 'CEO')) {
          html += '<button class="btn-danger btn-sm" onclick="deleteReport(\'' + r.id + '\')">Delete</button>';
        }
        html += '</td>';
        html += '</tr>';
      });

      tbody.innerHTML = html;
    }

    function deleteReport(id) {
      if (!confirm('Are you sure you want to delete this report?')) return;

      SRL.acctDeleteReport(id).then(function() {
        refreshStoredReports();
      }).catch(function(err) {
        alert('Failed to delete report: ' + (err.message || 'Unknown error'));
      });
    }

    // --- Generate Report Modal ---
    function openGenerateModal() {
      document.getElementById('gen-title').value = '';
      document.getElementById('gen-type').value = 'MONTHLY';
      document.getElementById('gen-start').value = '';
      document.getElementById('gen-end').value = '';
      document.getElementById('gen-error').style.display = 'none';
      document.getElementById('gen-submit-btn').disabled = false;
      document.getElementById('gen-submit-btn').textContent = 'Generate Report';
      document.getElementById('generate-modal').classList.add('open');
    }

    function closeGenerateModal() {
      document.getElementById('generate-modal').classList.remove('open');
    }

    function submitGenerateReport() {
      var title = document.getElementById('gen-title').value.trim();
      var reportType = document.getElementById('gen-type').value;
      var periodStart = document.getElementById('gen-start').value;
      var periodEnd = document.getElementById('gen-end').value;
      var errorEl = document.getElementById('gen-error');
      var submitBtn = document.getElementById('gen-submit-btn');

      if (!title) {
        errorEl.textContent = 'Please enter a report title.';
        errorEl.style.display = 'block';
        return;
      }
      if (!periodStart || !periodEnd) {
        errorEl.textContent = 'Please select both start and end dates.';
        errorEl.style.display = 'block';
        return;
      }
      if (new Date(periodStart) > new Date(periodEnd)) {
        errorEl.textContent = 'Start date must be before end date.';
        errorEl.style.display = 'block';
        return;
      }

      errorEl.style.display = 'none';
      submitBtn.disabled = true;
      submitBtn.textContent = 'Generating...';

      SRL.acctGenerateReport({
        reportType: reportType,
        periodStart: periodStart,
        periodEnd: periodEnd,
        title: title
      }).then(function() {
        closeGenerateModal();
        refreshStoredReports();
      }).catch(function(err) {
        errorEl.textContent = err.message || 'Failed to generate report.';
        errorEl.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Generate Report';
      });
    }

    // Close generate modal on overlay click
    document.getElementById('generate-modal').addEventListener('click', function(e) {
      if (e.target === this) closeGenerateModal();
    });

    // --- Export Modal ---
    function openExportModal() {
      document.getElementById('exp-type').value = 'invoices';
      document.getElementById('exp-from').value = '';
      document.getElementById('exp-to').value = '';
      document.getElementById('exp-format').value = 'CSV';
      document.getElementById('exp-error').style.display = 'none';
      document.getElementById('exp-submit-btn').disabled = false;
      document.getElementById('exp-submit-btn').textContent = 'Export';
      document.getElementById('export-modal').classList.add('open');
    }

    function closeExportModal() {
      document.getElementById('export-modal').classList.remove('open');
    }

    function submitExport() {
      var type = document.getElementById('exp-type').value;
      var dateFrom = document.getElementById('exp-from').value;
      var dateTo = document.getElementById('exp-to').value;
      var format = document.getElementById('exp-format').value;
      var errorEl = document.getElementById('exp-error');
      var submitBtn = document.getElementById('exp-submit-btn');

      if (!dateFrom || !dateTo) {
        errorEl.textContent = 'Please select both date from and date to.';
        errorEl.style.display = 'block';
        return;
      }
      if (new Date(dateFrom) > new Date(dateTo)) {
        errorEl.textContent = 'Start date must be before end date.';
        errorEl.style.display = 'block';
        return;
      }

      errorEl.style.display = 'none';
      submitBtn.disabled = true;
      submitBtn.textContent = 'Exporting...';

      SRL.acctExport({
        type: type,
        dateFrom: dateFrom,
        dateTo: dateTo,
        format: format
      }).then(function(data) {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Export';

        if (format === 'CSV' && data) {
          // Download CSV file
          var csvContent = '';
          if (typeof data === 'string') {
            csvContent = data;
          } else if (data.csv) {
            csvContent = data.csv;
          } else if (data.data && typeof data.data === 'string') {
            csvContent = data.data;
          } else {
            // Convert JSON data to CSV
            csvContent = jsonToCSV(data.data || data.records || data);
          }

          var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          var url = URL.createObjectURL(blob);
          var link = document.createElement('a');
          link.href = url;
          link.download = type + '_export_' + dateFrom + '_to_' + dateTo + '.csv';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
          closeExportModal();
        } else if (format === 'JSON' && data) {
          // Download JSON file
          var jsonContent = typeof data === 'string' ? data : JSON.stringify(data.data || data, null, 2);
          var blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
          var url = URL.createObjectURL(blob);
          var link = document.createElement('a');
          link.href = url;
          link.download = type + '_export_' + dateFrom + '_to_' + dateTo + '.json';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
          closeExportModal();
        } else {
          closeExportModal();
        }
      }).catch(function(err) {
        errorEl.textContent = err.message || 'Failed to export data.';
        errorEl.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Export';
      });
    }

    function jsonToCSV(data) {
      if (!data || !Array.isArray(data) || data.length === 0) return '';
      var keys = Object.keys(data[0]);
      var csv = keys.join(',') + '\n';
      data.forEach(function(row) {
        var vals = keys.map(function(k) {
          var v = row[k];
          if (v === null || v === undefined) return '';
          var s = String(v);
          if (s.indexOf(',') !== -1 || s.indexOf('"') !== -1 || s.indexOf('\n') !== -1) {
            return '"' + s.replace(/"/g, '""') + '"';
          }
          return s;
        });
        csv += vals.join(',') + '\n';
      });
      return csv;
    }

    // Close export modal on overlay click
    document.getElementById('export-modal').addEventListener('click', function(e) {
      if (e.target === this) closeExportModal();
    });

    // --- Init ---
    function init() {
      checkAuth().then(function() {
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('main-container').style.display = 'block';

        // Load initial data
        selectProfitTab('loads');
        refreshStoredReports();

        document.getElementById('last-updated').textContent = 'Loaded ' + new Date().toLocaleTimeString();
      }).catch(function(err) {
        console.error('Init error:', err);
      });
    }

    // Start
    init();
  </script>
<script src="/ae/js/sidebar.js"></script>
<script src="/ae/js/notification-bell.js"></script>
<script src="/shared/js/themeEngine.js"></script>
<script src="/shared/js/marco-polo.js"></script>
</body>
</html>
