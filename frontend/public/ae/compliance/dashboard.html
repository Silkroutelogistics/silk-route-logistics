<!DOCTYPE html>
<html lang="en">
<head>
  <script>
(function(){var A=window.API_URL||'https://api.silkroutelogistics.ai';fetch(A+'/api/build-version').then(function(r){return r.json()}).then(function(d){var s=localStorage.getItem('srl_build_version');if(s&&s!==d.version){localStorage.removeItem('token');localStorage.removeItem('carrier_token');localStorage.removeItem('user');localStorage.removeItem('carrier_user');localStorage.setItem('srl_build_version',d.version);window.location.href='/auth/login.html';return}localStorage.setItem('srl_build_version',d.version)}).catch(function(){})})();
</script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Compliance Dashboard - Silk Route Logistics</title>
  <link rel="icon" href="/logo.png" type="image/png">
  <link rel="stylesheet" href="/ae/css/console.css">
  <link rel="stylesheet" href="/shared/css/themes.css">
  <link rel="stylesheet" href="/shared/css/marco-polo.css">
  <script>(function(){try{var t=localStorage.getItem('srl_theme')||'silk-route-classic';var m=localStorage.getItem('srl_mode')||'light';document.documentElement.setAttribute('data-theme',t);document.documentElement.setAttribute('data-mode',m)}catch(e){document.documentElement.setAttribute('data-theme','silk-route-classic');document.documentElement.setAttribute('data-mode','light')}})()</script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>
    /* ========== Compliance Dashboard Styles ========== */

    /* --- Buttons --- */
    .btn-primary {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 8px 18px; background: var(--gold); color: var(--white);
      border: none; border-radius: 6px; font-size: 13px; font-weight: 600;
      cursor: pointer; white-space: nowrap; text-decoration: none;
    }
    .btn-primary:hover { background: var(--gold-hover); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-secondary {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 6px 14px; background: var(--white); color: var(--navy);
      border: 1px solid var(--gray-200); border-radius: 6px; font-size: 12px;
      font-weight: 500; cursor: pointer; text-decoration: none;
    }
    .btn-secondary:hover { border-color: var(--gold); color: var(--gold); }
    .btn-sm { padding: 5px 12px; font-size: 12px; }

    /* --- Critical Alerts Banner --- */
    .critical-banner {
      background: var(--red-bg);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: var(--radius-lg);
      padding: 16px 20px;
      margin-bottom: 24px;
      display: none;
    }
    .critical-banner.visible { display: block; }
    .critical-banner-header {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      font-weight: 700;
      color: var(--red);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }
    .critical-banner-header svg { flex-shrink: 0; }
    .critical-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: rgba(255,255,255,0.6);
      border-radius: var(--radius);
      margin-bottom: 6px;
      font-size: 13px;
      color: var(--gray-700);
    }
    .critical-item:last-child { margin-bottom: 0; }
    .critical-item-info {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }
    .critical-item-name { font-weight: 600; color: var(--navy); }
    .critical-item-mc { color: var(--gray-500); font-size: 12px; }
    .critical-item-issue { color: var(--red); font-weight: 500; }

    /* --- KPI Grid --- */
    .comp-kpi-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }
    .comp-kpi-card {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      padding: 20px;
      text-align: center;
      position: relative;
      border-top: 3px solid var(--gray-200);
    }
    .comp-kpi-card.kpi-blue { border-top-color: #3B82F6; }
    .comp-kpi-card.kpi-green { border-top-color: #22C55E; }
    .comp-kpi-card.kpi-amber { border-top-color: #F59E0B; }
    .comp-kpi-card.kpi-red { border-top-color: #EF4444; }
    .comp-kpi-card.kpi-gray { border-top-color: var(--gray-400); }
    .comp-kpi-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      margin-bottom: 8px;
    }
    .comp-kpi-icon.icon-blue { background: rgba(59,130,246,0.1); color: #3B82F6; }
    .comp-kpi-icon.icon-green { background: rgba(34,197,94,0.1); color: #22C55E; }
    .comp-kpi-icon.icon-amber { background: rgba(245,158,11,0.1); color: #F59E0B; }
    .comp-kpi-icon.icon-red { background: rgba(239,68,68,0.1); color: #EF4444; }
    .comp-kpi-icon.icon-gray { background: var(--gray-100); color: var(--gray-500); }
    .comp-kpi-label {
      font-size: 11px;
      color: var(--gray-400);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    .comp-kpi-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--navy);
      line-height: 1.2;
    }
    .comp-kpi-value.val-blue { color: #3B82F6; }
    .comp-kpi-value.val-green { color: #22C55E; }
    .comp-kpi-value.val-amber { color: #F59E0B; }
    .comp-kpi-value.val-red { color: #EF4444; }
    .comp-kpi-sub {
      font-size: 12px;
      color: var(--gray-400);
      margin-top: 4px;
    }

    /* --- Two-Column Layout --- */
    .comp-columns {
      display: grid;
      grid-template-columns: 3fr 2fr;
      gap: 20px;
      margin-bottom: 24px;
    }

    /* --- Chart Card --- */
    .chart-card {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      padding: 20px;
    }
    .chart-card h3 {
      font-size: 14px;
      color: var(--navy);
      margin-bottom: 16px;
      font-weight: 600;
    }
    .chart-container {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 260px;
    }
    .chart-center-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      pointer-events: none;
    }
    .chart-center-number {
      font-size: 32px;
      font-weight: 700;
      color: var(--navy);
      line-height: 1.2;
    }
    .chart-center-label {
      font-size: 12px;
      color: var(--gray-400);
      margin-top: 2px;
    }

    /* --- Recently Verified Card --- */
    .verified-card {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      padding: 20px;
      max-height: 340px;
      display: flex;
      flex-direction: column;
    }
    .verified-card h3 {
      font-size: 14px;
      color: var(--navy);
      margin-bottom: 12px;
      font-weight: 600;
    }
    .verified-list {
      flex: 1;
      overflow-y: auto;
    }
    .verified-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--gray-100);
      font-size: 13px;
    }
    .verified-item:last-child { border-bottom: none; }
    .verified-name {
      font-weight: 500;
      color: var(--navy);
    }
    .verified-date {
      color: var(--gray-400);
      font-size: 12px;
      margin-right: 8px;
    }
    .verified-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      background: rgba(34,197,94,0.1);
      color: #15803D;
    }

    /* --- Expiring Table Section --- */
    .expiring-section {
      margin-bottom: 24px;
    }
    .expiring-section h3 {
      font-size: 16px;
      color: var(--navy);
      margin-bottom: 12px;
      font-weight: 600;
    }
    .table-wrap {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      overflow: hidden;
    }
    .comp-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .comp-table th {
      text-align: left;
      padding: 12px 16px;
      font-size: 11px;
      color: var(--gray-400);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid var(--gray-200);
      background: var(--gray-50);
      white-space: nowrap;
    }
    .comp-table td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--gray-100);
      color: var(--gray-700);
      white-space: nowrap;
    }
    .comp-table tr:last-child td { border-bottom: none; }
    .comp-table tr:hover td { background: var(--gray-50); }
    .comp-table .carrier-name { font-weight: 600; color: var(--navy); }

    /* --- Status Badges --- */
    .status-badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }
    .badge-expiring {
      background: rgba(245,158,11,0.1);
      color: #B45309;
    }
    .badge-critical {
      background: rgba(239,68,68,0.1);
      color: #EF4444;
    }
    .badge-compliant {
      background: rgba(34,197,94,0.1);
      color: #15803D;
    }

    /* --- Empty Row --- */
    .empty-row td {
      text-align: center;
      color: var(--gray-400);
      padding: 32px 16px !important;
      font-style: italic;
    }

    /* --- Loading State --- */
    .loading-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--gray-400);
      font-size: 14px;
    }
    .loading-spinner {
      display: inline-block;
      width: 32px;
      height: 32px;
      border: 3px solid var(--gray-200);
      border-top-color: var(--gold);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 12px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* --- Toast --- */
    .toast {
      position: fixed; bottom: 24px; right: 24px; padding: 12px 20px;
      border-radius: 8px; font-size: 13px; font-weight: 500; color: var(--white);
      z-index: 9999; transform: translateY(80px); opacity: 0;
      transition: transform 0.3s, opacity 0.3s;
    }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast-success { background: #15803D; }
    .toast-error { background: #EF4444; }

    /* --- Responsive --- */
    @media (max-width: 1200px) {
      .comp-kpi-grid { grid-template-columns: repeat(3, 1fr); }
      .comp-columns { grid-template-columns: 1fr; }
    }
    @media (max-width: 768px) {
      .comp-kpi-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 640px) {
      .comp-kpi-grid { grid-template-columns: 1fr; }
      .comp-table { font-size: 12px; }
      .comp-table th, .comp-table td { padding: 8px 10px; }
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-logo"><img src="/logo.png" alt="SRL"><span>SRL Command</span></div>
      <div class="sidebar-user">
        <div class="sidebar-user-name" id="user-name">--</div>
        <div class="sidebar-user-role" id="user-role">--</div>
      </div>
      <nav class="sidebar-nav">
        <a href="/ae/dashboard"><svg class="sidebar-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>Dashboard</a>
        <a href="/ae/loads.html"><svg class="sidebar-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 3h15v13H1z"/><path d="M16 8h4l3 3v5h-7V8z"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>Load Board</a>
        <a href="/ae/caravan.html"><svg class="sidebar-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 6h13"/><path d="M8 12h13"/><path d="M8 18h13"/><path d="M3 6h.01"/><path d="M3 12h.01"/><path d="M3 18h.01"/></svg>The Caravan</a>
        <a href="/ae/analytics.html"><svg class="sidebar-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10"/><path d="M12 20V4"/><path d="M6 20v-6"/></svg>Analytics</a>
        <a href="/ae/crm.html"><svg class="sidebar-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>CRM</a>
        <a href="/ae/communications.html"><svg class="sidebar-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>Communications</a>
        <a href="/ae/claims.html"><svg class="sidebar-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="9" y1="15" x2="15" y2="15"/><line x1="9" y1="11" x2="13" y2="11"/></svg>Claims</a>
        <a href="/ae/financials.html"><svg class="sidebar-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>Financials</a>
        <a href="/ae/training.html"><svg class="sidebar-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>Training</a>
        <a href="/ae/accounting/dashboard.html"><svg class="sidebar-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="18" rx="2"/><path d="M2 9h20M9 21V9"/></svg>Accounting</a>
        <div style="border-top:1px solid var(--gray-200);margin:12px 0;padding-top:12px;">
          <div style="font-size:10px;color:var(--gray-400);text-transform:uppercase;letter-spacing:1px;padding:0 16px 8px;">Compliance</div>
          <a href="/ae/compliance/dashboard.html" class="active">
            <svg class="sidebar-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
            Dashboard
          </a>
          <a href="/ae/compliance/overview.html">
            <svg class="sidebar-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
            Overview
          </a>
          <a href="/ae/compliance/alerts.html">
            <svg class="sidebar-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
            Alerts
          </a>
        </div>
      </nav>
      <div class="sidebar-footer">
        <button class="sidebar-logout" onclick="handleLogout()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>Sign Out</button>
      </div>
    </aside>
    <button class="hamburger" id="hamburger" onclick="toggleSidebar()">&#9776;</button>
    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

    <!-- Main Content -->
    <main class="main">
      <div class="main-header" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;">
        <div>
          <h1>Compliance Dashboard</h1>
          <p>Carrier compliance monitoring and enforcement</p>
        </div>
        <button class="btn-primary" id="scan-btn" onclick="runFullScan()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
          Run Full Scan
        </button>
      </div>

      <!-- Loading State -->
      <div id="loading-state" class="loading-state">
        <div class="loading-spinner"></div>
        <div>Loading compliance data...</div>
      </div>

      <!-- Dashboard Content -->
      <div id="dashboard-content" style="display:none;padding:0 32px 24px;">

        <!-- Critical Alerts Banner -->
        <div class="critical-banner" id="critical-banner">
          <div class="critical-banner-header">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
            <span id="critical-count">0</span> CRITICAL COMPLIANCE ISSUES &mdash; Carriers with expired insurance or revoked authority
          </div>
          <div id="critical-list"></div>
        </div>

        <!-- KPI Cards -->
        <div class="comp-kpi-grid">
          <!-- Total Active Carriers -->
          <div class="comp-kpi-card kpi-blue">
            <div class="comp-kpi-icon icon-blue">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 3h15v13H1z"/><path d="M16 8h4l3 3v5h-7V8z"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>
            </div>
            <div class="comp-kpi-label">Total Active Carriers</div>
            <div class="comp-kpi-value val-blue" id="kpi-total">--</div>
          </div>
          <!-- Fully Compliant -->
          <div class="comp-kpi-card kpi-green">
            <div class="comp-kpi-icon icon-green">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
            </div>
            <div class="comp-kpi-label">Fully Compliant</div>
            <div class="comp-kpi-value val-green" id="kpi-compliant">--</div>
            <div class="comp-kpi-sub" id="kpi-compliant-pct">--% of total</div>
          </div>
          <!-- Expiring in 30 Days -->
          <div class="comp-kpi-card kpi-amber">
            <div class="comp-kpi-icon icon-amber">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
            </div>
            <div class="comp-kpi-label">Expiring in 30 Days</div>
            <div class="comp-kpi-value val-amber" id="kpi-expiring">--</div>
          </div>
          <!-- Non-Compliant / Expired -->
          <div class="comp-kpi-card kpi-red">
            <div class="comp-kpi-icon icon-red">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
            </div>
            <div class="comp-kpi-label">Non-Compliant / Expired</div>
            <div class="comp-kpi-value val-red" id="kpi-expired">--</div>
          </div>
          <!-- Last System-Wide Scan -->
          <div class="comp-kpi-card kpi-gray">
            <div class="comp-kpi-icon icon-gray">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
            </div>
            <div class="comp-kpi-label">Last System-Wide Scan</div>
            <div class="comp-kpi-value" id="kpi-scan-date" style="font-size:18px;">--</div>
            <div class="comp-kpi-sub" id="kpi-scan-time">--</div>
          </div>
        </div>

        <!-- Two-Column Layout -->
        <div class="comp-columns">
          <!-- LEFT: Compliance Health Chart -->
          <div class="chart-card">
            <h3>Compliance Health</h3>
            <div class="chart-container">
              <canvas id="healthChart"></canvas>
              <div class="chart-center-text">
                <div class="chart-center-number" id="chart-total">--</div>
                <div class="chart-center-label">Total Carriers</div>
              </div>
            </div>
          </div>
          <!-- RIGHT: Recently Verified -->
          <div class="verified-card">
            <h3>Recently Verified</h3>
            <div class="verified-list" id="verified-list">
              <div style="text-align:center;color:var(--gray-400);padding:20px;font-size:13px;font-style:italic;">Loading...</div>
            </div>
          </div>
        </div>

        <!-- Expiring Soon Table -->
        <div class="expiring-section">
          <h3>Expiring Within 30 Days</h3>
          <div class="table-wrap">
            <table class="comp-table">
              <thead>
                <tr>
                  <th>Carrier Name</th>
                  <th>MC#</th>
                  <th>Item Type</th>
                  <th>Expiry Date</th>
                  <th>Days Remaining</th>
                  <th>Status</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="expiring-tbody">
                <tr class="empty-row"><td colspan="7">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

      </div><!-- /dashboard-content -->
    </main>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast"></div>

  <script src="/js/auth.js"></script>
  <script src="/js/session-timeout.js"></script>
  <script src="/ae/js/api.js"></script>
  <script>
    (function() {
      var healthChartInst = null;

      // ========== AUTH CHECK ==========
      SRL.getMe().then(function(user) {
        if (window.SRLTheme) SRLTheme.restoreFromUser(user);
        document.getElementById('user-name').textContent = user.firstName + ' ' + user.lastName;
        document.getElementById('user-role').textContent = user.role;
        loadDashboard();
      }).catch(function() {
        window.location.href = '/auth/login';
      });

      // ========== LOAD DASHBOARD ==========
      function loadDashboard() {
        document.getElementById('loading-state').style.display = 'block';
        document.getElementById('dashboard-content').style.display = 'none';

        Promise.allSettled([
          SRL.request('/api/compliance/dashboard'),
          SRL.request('/api/compliance/alerts?status=ACTIVE&severity=CRITICAL')
        ]).then(function(results) {
          var dashData = results[0].status === 'fulfilled' ? results[0].value : null;
          var alertsData = results[1].status === 'fulfilled' ? results[1].value : null;

          document.getElementById('loading-state').style.display = 'none';
          document.getElementById('dashboard-content').style.display = 'block';

          renderKPIs(dashData);
          renderCriticalAlerts(alertsData);
          renderHealthChart(dashData);
          renderRecentlyVerified(dashData);
          renderExpiringTable(dashData);
        }).catch(function(err) {
          console.error('Compliance dashboard load error:', err);
          document.getElementById('loading-state').style.display = 'none';
          document.getElementById('dashboard-content').style.display = 'block';
          renderKPIs(null);
          renderCriticalAlerts(null);
          renderHealthChart(null);
          renderRecentlyVerified(null);
          renderExpiringTable(null);
        });
      }

      // ========== FORMAT HELPERS ==========
      function escHtml(str) {
        if (!str) return '';
        var div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      }

      function fmtDate(dateStr) {
        if (!dateStr) return '--';
        var d = new Date(dateStr);
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      }

      function fmtTime(dateStr) {
        if (!dateStr) return '--';
        var d = new Date(dateStr);
        return d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
      }

      function daysUntil(dateStr) {
        if (!dateStr) return null;
        var now = new Date();
        now.setHours(0, 0, 0, 0);
        var target = new Date(dateStr);
        target.setHours(0, 0, 0, 0);
        return Math.ceil((target - now) / (1000 * 60 * 60 * 24));
      }

      // ========== RENDER KPIs ==========
      function renderKPIs(data) {
        if (!data) {
          document.getElementById('kpi-total').textContent = '0';
          document.getElementById('kpi-compliant').textContent = '0';
          document.getElementById('kpi-compliant-pct').textContent = '0% of total';
          document.getElementById('kpi-expiring').textContent = '0';
          document.getElementById('kpi-expired').textContent = '0';
          document.getElementById('kpi-scan-date').textContent = 'Never';
          document.getElementById('kpi-scan-time').textContent = '--';
          return;
        }

        var total = data.totalCarriers || 0;
        var compliant = data.compliantCount || 0;
        var expiring = data.expiringCount || 0;
        var expired = data.expiredCount || data.nonCompliantCount || 0;
        var pct = total > 0 ? Math.round((compliant / total) * 100) : 0;

        document.getElementById('kpi-total').textContent = total;
        document.getElementById('kpi-compliant').textContent = compliant;
        document.getElementById('kpi-compliant-pct').textContent = pct + '% of total';
        document.getElementById('kpi-expiring').textContent = expiring;
        document.getElementById('kpi-expired').textContent = expired;

        if (data.lastScanDate) {
          document.getElementById('kpi-scan-date').textContent = fmtDate(data.lastScanDate);
          document.getElementById('kpi-scan-time').textContent = fmtTime(data.lastScanDate);
        } else {
          document.getElementById('kpi-scan-date').textContent = 'Never';
          document.getElementById('kpi-scan-time').textContent = '--';
        }
      }

      // ========== RENDER CRITICAL ALERTS ==========
      function renderCriticalAlerts(alertsData) {
        var banner = document.getElementById('critical-banner');
        var list = document.getElementById('critical-list');
        var countEl = document.getElementById('critical-count');

        var alerts = [];
        if (alertsData) {
          alerts = Array.isArray(alertsData) ? alertsData : (alertsData.alerts || []);
        }

        if (alerts.length === 0) {
          banner.classList.remove('visible');
          return;
        }

        countEl.textContent = alerts.length;
        banner.classList.add('visible');
        list.innerHTML = '';

        alerts.forEach(function(alert) {
          var carrierName = alert.carrierName || (alert.carrier && alert.carrier.name) || 'Unknown Carrier';
          var mc = alert.mcNumber || (alert.carrier && alert.carrier.mcNumber) || '--';
          var issue = alert.message || alert.description || alert.type || 'Compliance issue';

          var div = document.createElement('div');
          div.className = 'critical-item';
          div.innerHTML =
            '<div class="critical-item-info">' +
              '<span class="critical-item-name">' + escHtml(carrierName) + '</span>' +
              '<span class="critical-item-mc">MC# ' + escHtml(mc) + '</span>' +
              '<span class="critical-item-issue">' + escHtml(issue) + '</span>' +
            '</div>' +
            '<button class="btn-secondary btn-sm" onclick="viewCarrier(\'' + escHtml(alert.carrierId || '') + '\')">View</button>';
          list.appendChild(div);
        });
      }

      // ========== RENDER HEALTH CHART ==========
      function renderHealthChart(data) {
        var canvas = document.getElementById('healthChart');
        if (healthChartInst) healthChartInst.destroy();

        var compliant = (data && data.compliantCount) || 0;
        var expiring = (data && data.expiringCount) || 0;
        var expired = (data && (data.expiredCount || data.nonCompliantCount)) || 0;
        var total = compliant + expiring + expired;

        document.getElementById('chart-total').textContent = total || '--';

        if (total === 0) {
          // Render empty state
          healthChartInst = new Chart(canvas, {
            type: 'doughnut',
            data: {
              labels: ['No Data'],
              datasets: [{
                data: [1],
                backgroundColor: ['rgba(148,163,184,0.2)'],
                borderWidth: 0
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              cutout: '70%',
              plugins: { legend: { display: false }, tooltip: { enabled: false } }
            }
          });
          return;
        }

        healthChartInst = new Chart(canvas, {
          type: 'doughnut',
          data: {
            labels: ['Compliant', 'Expiring', 'Expired'],
            datasets: [{
              data: [compliant, expiring, expired],
              backgroundColor: ['#22c55e', '#f59e0b', '#ef4444'],
              borderColor: ['#16a34a', '#d97706', '#dc2626'],
              borderWidth: 2,
              hoverOffset: 6
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            cutout: '70%',
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  font: { size: 12 },
                  usePointStyle: true,
                  pointStyleWidth: 12,
                  padding: 16
                }
              },
              tooltip: {
                callbacks: {
                  label: function(ctx) {
                    var pct = total > 0 ? ((ctx.parsed / total) * 100).toFixed(1) : 0;
                    return ctx.label + ': ' + ctx.parsed + ' (' + pct + '%)';
                  }
                }
              }
            }
          }
        });
      }

      // ========== RENDER RECENTLY VERIFIED ==========
      function renderRecentlyVerified(data) {
        var container = document.getElementById('verified-list');
        var items = (data && data.recentlyVerified) || [];

        if (items.length === 0) {
          container.innerHTML = '<div style="text-align:center;color:var(--gray-400);padding:20px;font-size:13px;font-style:italic;">No recent verifications</div>';
          return;
        }

        container.innerHTML = '';
        var displayItems = items.slice(0, 10);
        displayItems.forEach(function(item) {
          var name = item.carrierName || item.name || 'Unknown';
          var date = fmtDate(item.verifiedDate || item.checkedAt || item.updatedAt);

          var div = document.createElement('div');
          div.className = 'verified-item';
          div.innerHTML =
            '<span class="verified-name">' + escHtml(name) + '</span>' +
            '<span style="display:flex;align-items:center;gap:6px;">' +
              '<span class="verified-date">' + date + '</span>' +
              '<span class="verified-badge">Passed</span>' +
            '</span>';
          container.appendChild(div);
        });
      }

      // ========== RENDER EXPIRING TABLE ==========
      function renderExpiringTable(data) {
        var tbody = document.getElementById('expiring-tbody');
        tbody.innerHTML = '';

        var items = (data && data.expiringItems) || [];

        if (items.length === 0) {
          var tr = document.createElement('tr');
          tr.className = 'empty-row';
          tr.innerHTML = '<td colspan="7">No items expiring within 30 days</td>';
          tbody.appendChild(tr);
          return;
        }

        items.forEach(function(item) {
          var days = daysUntil(item.expiryDate || item.expirationDate);
          var isCritical = days !== null && days < 7;
          var badgeClass = isCritical ? 'badge-critical' : 'badge-expiring';
          var badgeText = isCritical ? 'Critical' : 'Expiring';

          var tr = document.createElement('tr');
          tr.innerHTML =
            '<td class="carrier-name">' + escHtml(item.carrierName || item.name || '--') + '</td>' +
            '<td>' + escHtml(item.mcNumber || '--') + '</td>' +
            '<td>' + escHtml(item.itemType || item.type || '--') + '</td>' +
            '<td>' + fmtDate(item.expiryDate || item.expirationDate) + '</td>' +
            '<td style="font-weight:600;color:' + (isCritical ? 'var(--red)' : 'var(--amber)') + '">' + (days !== null ? days + ' days' : '--') + '</td>' +
            '<td><span class="status-badge ' + badgeClass + '">' + badgeText + '</span></td>' +
            '<td><button class="btn-secondary btn-sm" onclick="viewCarrier(\'' + escHtml(item.carrierId || '') + '\')">View Carrier</button></td>';
          tbody.appendChild(tr);
        });
      }

      // ========== RUN FULL SCAN ==========
      window.runFullScan = function() {
        var btn = document.getElementById('scan-btn');
        btn.disabled = true;
        btn.innerHTML =
          '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="animation:spin 0.8s linear infinite"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-1.64-8.36L23 10"/></svg>' +
          'Scanning...';

        SRL.request('/api/compliance/scan', { method: 'POST' })
          .then(function(result) {
            showToast('Compliance scan completed successfully', 'success');
            loadDashboard();
          })
          .catch(function(err) {
            showToast('Scan failed: ' + (err.message || 'Unknown error'), 'error');
          })
          .finally(function() {
            btn.disabled = false;
            btn.innerHTML =
              '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>' +
              'Run Full Scan';
          });
      };

      // ========== VIEW CARRIER ==========
      window.viewCarrier = function(carrierId) {
        if (carrierId) {
          window.location.href = '/ae/caravan.html?carrier=' + carrierId;
        }
      };

      // ========== TOAST ==========
      function showToast(message, type) {
        var toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = 'toast toast-' + (type || 'success');
        toast.classList.add('show');
        setTimeout(function() {
          toast.classList.remove('show');
        }, 3500);
      }

      // ========== SIDEBAR TOGGLE ==========
      window.toggleSidebar = function() {
        document.getElementById('sidebar').classList.toggle('open');
        document.getElementById('overlay').classList.toggle('open');
      };

      // ========== LOGOUT ==========
      window.handleLogout = function() {
        localStorage.removeItem('token');
        sessionStorage.removeItem('token');
        window.location.href = '/auth/login';
      };

      // ========== AUTO REFRESH (every 2 minutes) ==========
      setInterval(function() {
        if (!document.hidden && document.getElementById('dashboard-content').style.display !== 'none') {
          loadDashboard();
        }
      }, 120000);

    })();
  </script>
<script src="/ae/js/sidebar.js"></script>
<script src="/ae/js/notification-bell.js"></script>
<script src="/shared/js/themeEngine.js"></script>
<script src="/shared/js/marco-polo.js"></script>
</body>
</html>
