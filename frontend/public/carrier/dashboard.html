<!DOCTYPE html>
<html lang="en">
<head>
  <script>
(function(){var A=window.API_URL||'https://api.silkroutelogistics.ai';fetch(A+'/api/build-version').then(function(r){return r.json()}).then(function(d){var s=localStorage.getItem('srl_build_version');if(s&&s!==d.version){localStorage.removeItem('token');localStorage.removeItem('carrier_token');localStorage.removeItem('user');localStorage.removeItem('carrier_user');localStorage.setItem('srl_build_version',d.version);window.location.href='/auth/login.html';return}localStorage.setItem('srl_build_version',d.version)}).catch(function(){})})();
</script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard | SRL Carrier Portal</title>
  <link rel="stylesheet" href="/carrier/css/carrier-console.css">
  <link rel="stylesheet" href="/shared/css/themes.css">
  <link rel="stylesheet" href="/shared/css/marco-polo.css">
  <script>(function(){try{var t=localStorage.getItem('srl_theme')||'silk-route-classic';var m=localStorage.getItem('srl_mode')||'light';document.documentElement.setAttribute('data-theme',t);document.documentElement.setAttribute('data-mode',m)}catch(e){document.documentElement.setAttribute('data-theme','silk-route-classic');document.documentElement.setAttribute('data-mode','light')}})()</script>
</head>
<body>
  <button class="hamburger" id="hamburger">&#9776;</button>
  <div class="overlay" id="overlay"></div>

  <aside class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <h2>SILK ROUTE</h2>
      <p>Carrier Portal</p>
    </div>
    <div class="sidebar-user" id="sidebarUser">
      <div class="user-name skeleton skeleton-line w75"></div>
      <div class="user-role">CARRIER</div>
    </div>
    <nav class="sidebar-nav">
      <a href="/carrier/dashboard.html" class="active"><span class="nav-icon">&#9673;</span> Dashboard</a>
      <a href="/carrier/loads.html"><span class="nav-icon">&#9776;</span> My Loads</a>
      <a href="/carrier/loads.html?tab=available"><span class="nav-icon">&#10149;</span> Available Loads</a>
      <a href="/carrier/payments.html"><span class="nav-icon">&#36;</span> Payments</a>
      <a href="/carrier/compliance.html"><span class="nav-icon">&#9888;</span> Compliance</a>
      <a href="/carrier/analytics.html"><span class="nav-icon">&#128202;</span> Analytics</a>
      <a href="/carrier/tools.html"><span class="nav-icon">&#9881;</span> Tools</a>
      <a href="/carrier/help.html"><span class="nav-icon">&#63;</span> Help & SOPs</a>
    </nav>
    <div class="sidebar-footer">
      <button onclick="CARRIER.logout()">Sign Out</button>
    </div>
  </aside>

  <main class="main">
    <!-- Status Strip -->
    <div class="status-strip green" id="statusStrip">
      All systems operational
      <button class="refresh-btn" onclick="loadDashboard()">Refresh</button>
    </div>

    <div class="page-header">
      <div>
        <h1>Carrier Dashboard</h1>
        <p class="subtitle" id="welcomeMsg">Welcome back</p>
      </div>
    </div>

    <!-- CPP Tier Card -->
    <div class="tier-card" id="tierCard" style="margin-bottom:24px">
      <div class="skeleton skeleton-line w50"></div>
      <div class="skeleton skeleton-box"></div>
    </div>

    <!-- KPIs -->
    <div class="grid-4" id="kpiGrid" style="margin-bottom:24px">
      <div class="kpi-tile"><div class="skeleton skeleton-box"></div></div>
      <div class="kpi-tile"><div class="skeleton skeleton-box"></div></div>
      <div class="kpi-tile"><div class="skeleton skeleton-box"></div></div>
      <div class="kpi-tile"><div class="skeleton skeleton-box"></div></div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid-3">
      <!-- Col 1: My Active Loads -->
      <div class="card">
        <div class="card-header">
          <h3>Active Loads</h3>
          <a href="/carrier/loads.html" class="card-action">View All</a>
        </div>
        <div id="activeLoadsList">
          <div class="skeleton skeleton-line w100"></div>
          <div class="skeleton skeleton-line w75"></div>
          <div class="skeleton skeleton-line w100"></div>
        </div>
      </div>

      <!-- Col 2: The Caravan Load Board -->
      <div class="card">
        <div class="card-header">
          <h3 style="display:flex;align-items:center;gap:8px"><span style="color:var(--gold)">&#9670;</span> The Caravan Load Board</h3>
          <a href="/carrier/loads.html?tab=available" class="card-action">Browse All</a>
        </div>
        <div id="caravanTierBanner" style="display:none"></div>
        <div id="availableLoadsList">
          <div class="skeleton skeleton-line w100"></div>
          <div class="skeleton skeleton-line w75"></div>
          <div class="skeleton skeleton-line w100"></div>
        </div>
      </div>

      <!-- Col 3: Notifications & Quick Actions -->
      <div>
        <!-- Compliance Alerts -->
        <div class="card" style="margin-bottom:20px">
          <div class="card-header">
            <h3>Compliance Alerts</h3>
            <a href="/carrier/compliance.html" class="card-action">View All</a>
          </div>
          <div id="complianceAlerts">
            <div class="skeleton skeleton-line w100"></div>
            <div class="skeleton skeleton-line w75"></div>
          </div>
        </div>

        <!-- Recent Notifications -->
        <div class="card">
          <div class="card-header"><h3>Notifications</h3></div>
          <div id="notificationsList">
            <div class="skeleton skeleton-line w100"></div>
            <div class="skeleton skeleton-line w75"></div>
          </div>
        </div>
      </div>
    </div>

    <footer class="main-footer">
      Silk Route Logistics &middot; Carrier Portal &middot; <span id="lastUpdated"></span>
    </footer>
  </main>

  <script src="/js/auth.js"></script>
  <script src="/carrier/js/carrier-api.js"></script>
  <script>
    if (!CARRIER.requireAuth()) throw new Error("Not authenticated");

    function esc(s) { var d = document.createElement("div"); d.textContent = s || ""; return d.innerHTML; }
    function money(n) { return "$" + (n || 0).toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
    function shortDate(d) { return d ? new Date(d).toLocaleDateString("en-US", { month: "short", day: "numeric" }) : "--"; }

    function statusBadge(s) {
      var colors = {
        POSTED: "blue", BOOKED: "gold", CONFIRMED: "gold", DISPATCHED: "amber",
        AT_PICKUP: "amber", LOADED: "amber", IN_TRANSIT: "gold",
        AT_DELIVERY: "amber", DELIVERED: "green", COMPLETED: "green",
        INVOICED: "blue", CANCELLED: "red", TONU: "red"
      };
      return '<span class="badge badge-' + (colors[s] || "slate") + '">' + esc((s || "").replace(/_/g, " ")) + '</span>';
    }

    function loadDashboard() {
      CARRIER.fetchDashboardData().then(renderDashboard);
    }

    function renderDashboard(data) {
      if(window.SRLTheme && data.user)SRLTheme.restoreFromUser(data.user);
      // User info
      if (data.user) {
        var u = data.user;
        document.getElementById("sidebarUser").innerHTML =
          '<div class="user-name">' + esc(u.firstName + " " + u.lastName) + '</div>' +
          '<div class="user-role">CARRIER</div>' +
          (u.carrierProfile ? '<div class="user-tier tier-' + u.carrierProfile.tier + '">' + u.carrierProfile.tier + '</div>' : '');
        document.getElementById("welcomeMsg").textContent = "Welcome back, " + u.firstName;
      }

      // CPP Tier Card
      renderTierCard(data.cpp, data.dashboard);

      // KPIs
      renderKPIs(data.dashboard, data.payments);

      // Active Loads
      renderActiveLoads(data.myLoads);

      // Available Loads
      renderAvailableLoads(data.availableLoads);

      // Compliance
      renderComplianceAlerts(data.compliance);

      // Notifications
      renderNotifications(data.notifications);

      // Status strip
      renderStatusStrip(data.compliance);

      document.getElementById("lastUpdated").textContent = "Updated " + new Date().toLocaleTimeString();
    }

    var _carrierTier = "BRONZE"; // tracked globally for rate visibility

    function renderTierCard(cpp, dashboard) {
      var card = document.getElementById("tierCard");
      if (!cpp) {
        card.innerHTML = '<div style="text-align:center;color:var(--slate);padding:20px">CPP data loading...</div>';
        return;
      }

      var tier = cpp.tier || "BRONZE";
      _carrierTier = tier;
      var score = cpp.score || 0;
      var nextTier = cpp.nextTier;
      var progressPct = Math.min(100, score);
      var totalLoads = cpp.totalLoads || 0;

      // Guest tier: show 3-load conversion progress
      if (tier === "GUEST") {
        var guestProgress = Math.min(3, totalLoads);
        var guestPct = Math.round((guestProgress / 3) * 100);
        card.innerHTML =
          '<div class="tier-badge-lg" style="background:rgba(128,128,128,0.15);color:#808080;border:2px solid #808080">GUEST</div>' +
          '<div style="margin:12px 0 8px;font-size:14px;color:#CBD5E1;font-weight:600">Join The Caravan as a Bronze member</div>' +
          '<div style="font-size:12px;color:var(--slate);margin-bottom:12px">Complete 3 loads with a score of 70+ to earn your spot</div>' +
          '<div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">' +
            '<div style="flex:1;height:12px;background:rgba(255,255,255,0.1);border-radius:6px;overflow:hidden">' +
              '<div style="height:100%;width:' + guestPct + '%;background:linear-gradient(90deg,#808080,var(--gold));border-radius:6px;transition:width 0.4s"></div>' +
            '</div>' +
            '<span style="font-size:14px;font-weight:700;color:var(--gold)">' + guestProgress + ' / 3</span>' +
          '</div>' +
          (score >= 70
            ? '<div style="font-size:11px;color:var(--green)">&#10003; Your avg score (' + score.toFixed(0) + ') qualifies! Complete ' + (3 - guestProgress) + ' more load(s).</div>'
            : '<div style="font-size:11px;color:#f59e0b">&#9888; Avg score ' + score.toFixed(0) + ' — need 70+ to qualify for Bronze</div>');
        renderCaravanBanner(tier, totalLoads);
        return;
      }

      card.innerHTML =
        '<div class="tier-badge-lg tier-' + tier + '">' + tier + ' TIER</div>' +
        '<div class="tier-score">' + score.toFixed(1) + ' <span>/ 100 pts</span></div>' +
        '<div class="tier-progress"><div class="tier-progress-bar" style="width:' + progressPct + '%"></div></div>' +
        (nextTier
          ? '<div class="next-tier">' + (nextTier.pointsNeeded > 0 ? nextTier.pointsNeeded.toFixed(1) + ' pts to ' + nextTier.name : 'Top tier reached!') + '</div>'
          : '<div class="next-tier">Top tier reached!</div>') +
        '<div style="margin-top:12px;display:flex;gap:24px;font-size:12px;color:var(--slate)">' +
          '<span>Loads: <strong style="color:#fff">' + (totalLoads) + '</strong></span>' +
          '<span>Miles: <strong style="color:#fff">' + Math.round(cpp.totalMiles || 0).toLocaleString() + '</strong></span>' +
          '<span>Bonus Rate: <strong style="color:var(--gold)">' + (cpp.bonusPercentage || 0) + '%</strong></span>' +
        '</div>';

      renderCaravanBanner(tier, totalLoads);
    }

    function renderCaravanBanner(tier, totalLoads) {
      var banner = document.getElementById("caravanTierBanner");
      var perks = {
        GUEST:    { msg: "Complete 3 loads to join The Caravan", perksText: "No perks yet", color: "#808080" },
        BRONZE:   { msg: "Welcome to The Caravan!", perksText: "Standard rates, QuickPay at 3%", color: "#CD7F32" },
        SILVER:   { msg: "Silver Caravan Member", perksText: "Priority matching, QuickPay at 2%", color: "#A0AEC0" },
        GOLD:     { msg: "Gold Caravan Member", perksText: "1.5% load bonus, QuickPay at 1.5%, priority loads", color: "#C8963E" },
        PLATINUM: { msg: "Platinum Caravan Elite", perksText: "3% load bonus, instant QuickPay at 1%, dedicated support", color: "#E5E7EB" }
      };
      var p = perks[tier] || perks.BRONZE;
      banner.style.display = "block";
      banner.innerHTML =
        '<div style="padding:10px 14px;margin-bottom:10px;border-radius:8px;border:1px solid ' + p.color + '22;background:' + p.color + '0D;display:flex;align-items:center;gap:10px">' +
          '<span style="font-size:16px;color:' + p.color + '">&#9670;</span>' +
          '<div>' +
            '<div style="font-size:12px;font-weight:600;color:' + p.color + '">' + esc(p.msg) + '</div>' +
            '<div style="font-size:11px;color:var(--slate)">' + esc(p.perksText) + '</div>' +
          '</div>' +
        '</div>';
    }

    function renderKPIs(dashboard, payments) {
      var grid = document.getElementById("kpiGrid");
      var d = dashboard || {};
      var p = payments || {};
      var stats = d.stats || {};

      grid.innerHTML =
        '<div class="kpi-tile gold"><div class="kpi-value">' + (stats.activeLoads || 0) + '</div><div class="kpi-label">Active Loads</div></div>' +
        '<div class="kpi-tile green"><div class="kpi-value">' + money(stats.weeklyRevenue || 0) + '</div><div class="kpi-label">This Week</div></div>' +
        '<div class="kpi-tile blue"><div class="kpi-value">' + money(stats.monthlyRevenue || 0) + '</div><div class="kpi-label">This Month</div></div>' +
        '<div class="kpi-tile amber"><div class="kpi-value">' + money(p.totalPending ? p.totalPending.amount : 0) + '</div><div class="kpi-label">Pending Pay</div></div>';
    }

    function renderActiveLoads(data) {
      var el = document.getElementById("activeLoadsList");
      var loads = data && data.loads ? data.loads : [];
      if (loads.length === 0) {
        el.innerHTML = '<div class="empty-state"><p>No active loads</p></div>';
        return;
      }

      el.innerHTML = loads.slice(0, 5).map(function (l) {
        return '<div style="padding:8px 0;border-bottom:1px solid var(--card-border);display:flex;align-items:center;justify-content:space-between">' +
          '<div>' +
            '<div style="font-size:13px;font-weight:600;color:#fff">' + esc(l.referenceNumber) + '</div>' +
            '<div style="font-size:11px;color:var(--slate)">' + esc(l.originCity + ', ' + l.originState) + ' → ' + esc(l.destCity + ', ' + l.destState) + '</div>' +
          '</div>' +
          '<div>' + statusBadge(l.status) + '</div>' +
        '</div>';
      }).join("");
    }

    function renderAvailableLoads(data) {
      var el = document.getElementById("availableLoadsList");
      var loads = data && data.loads ? data.loads : [];
      if (loads.length === 0) {
        el.innerHTML = '<div class="empty-state"><p>No loads available</p></div>';
        return;
      }

      var isGuest = _carrierTier === "GUEST";
      el.innerHTML = loads.slice(0, 5).map(function (l) {
        var rateDisplay = isGuest
          ? '<span style="color:#808080;font-size:11px;font-style:italic">Accept to see rate</span>'
          : '<span style="color:var(--gold);font-weight:600;font-size:13px">' + money(l.carrierRate || l.rate) + '</span>';
        return '<div style="padding:8px 0;border-bottom:1px solid var(--card-border)">' +
          '<div style="display:flex;justify-content:space-between;align-items:center">' +
            '<div style="font-size:13px;font-weight:600;color:#fff">' + esc(l.originCity + ', ' + l.originState) + ' → ' + esc(l.destCity + ', ' + l.destState) + '</div>' +
            rateDisplay +
          '</div>' +
          '<div style="font-size:11px;color:var(--slate);margin-top:2px">' +
            esc((l.equipmentType || "").replace(/_/g, " ")) + ' &middot; ' + shortDate(l.pickupDate) +
            (l.distance ? ' &middot; ' + l.distance + ' mi' : '') +
          '</div>' +
        '</div>';
      }).join("");
    }

    function renderComplianceAlerts(data) {
      var el = document.getElementById("complianceAlerts");
      if (!data || !data.alerts || data.alerts.length === 0) {
        el.innerHTML = '<div style="padding:8px 0;color:var(--green);font-size:13px">&#10003; All clear - no compliance alerts</div>';
        return;
      }

      el.innerHTML = data.alerts.slice(0, 3).map(function (a) {
        var color = a.severity === "CRITICAL" ? "red" : "amber";
        return '<div style="padding:6px 0;border-bottom:1px solid var(--card-border);display:flex;align-items:center;gap:8px">' +
          '<span class="badge badge-' + color + '">' + esc(a.severity) + '</span>' +
          '<span style="font-size:12px;color:#CBD5E1">' + esc(a.type.replace(/_/g, " ")) + ' - ' + esc(a.entityName) + '</span>' +
        '</div>';
      }).join("");
    }

    function renderNotifications(data) {
      var el = document.getElementById("notificationsList");
      var list = Array.isArray(data) ? data : (data && data.notifications ? data.notifications : []);
      if (list.length === 0) {
        el.innerHTML = '<div class="empty-state"><p>No notifications</p></div>';
        return;
      }

      el.innerHTML = list.slice(0, 5).map(function (n) {
        return '<div style="padding:6px 0;border-bottom:1px solid var(--card-border)">' +
          '<div style="font-size:12px;font-weight:500;color:#fff">' + esc(n.title) + '</div>' +
          '<div style="font-size:11px;color:var(--slate)">' + esc(n.message) + '</div>' +
        '</div>';
      }).join("");
    }

    function renderStatusStrip(compliance) {
      var strip = document.getElementById("statusStrip");
      if (compliance && compliance.alertsSummary) {
        var s = compliance.alertsSummary;
        if (s.critical > 0) {
          strip.className = "status-strip red";
          strip.innerHTML = s.critical + " critical compliance issue(s) require attention <button class='refresh-btn' onclick='loadDashboard()'>Refresh</button>";
        } else if (s.warning > 0) {
          strip.className = "status-strip amber";
          strip.innerHTML = s.warning + " compliance warning(s) - review recommended <button class='refresh-btn' onclick='loadDashboard()'>Refresh</button>";
        } else {
          strip.className = "status-strip green";
          strip.innerHTML = "All systems operational <button class='refresh-btn' onclick='loadDashboard()'>Refresh</button>";
        }
      }
    }

    // Init
    loadDashboard();
    CARRIER.startAutoRefresh(loadDashboard);

    // Sidebar toggle
    document.getElementById("hamburger").addEventListener("click", function () {
      document.getElementById("sidebar").classList.toggle("open");
      document.getElementById("overlay").classList.toggle("show");
    });
    document.getElementById("overlay").addEventListener("click", function () {
      document.getElementById("sidebar").classList.remove("open");
      this.classList.remove("show");
    });
  </script>
<script src="/ae/js/notification-bell.js"></script>
<script src="/shared/js/themeEngine.js"></script>
<script src="/shared/js/marco-polo.js"></script>
</body>
</html>
