<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign In - Silk Route Logistics</title>
  <link rel="icon" href="/logo.png" type="image/png">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #0D1B2A;
      color: #E2E8F0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .login-card {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 48px 40px;
      width: 100%;
      max-width: 420px;
      backdrop-filter: blur(12px);
    }
    .logo { text-align: center; margin-bottom: 32px; }
    .logo img { width: 56px; height: 56px; border-radius: 12px; }
    .logo h1 { font-size: 22px; font-weight: 700; color: #C8963E; margin-top: 12px; }
    .logo p { font-size: 13px; color: #94a3b8; margin-top: 4px; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; font-size: 12px; font-weight: 600; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
    .form-group input {
      width: 100%;
      padding: 12px 14px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 8px;
      color: #E2E8F0;
      font-size: 15px;
      outline: none;
      transition: border-color 0.2s;
    }
    .form-group input:focus { border-color: #C8963E; }
    .form-group input::placeholder { color: #475569; }
    .btn {
      width: 100%;
      padding: 13px;
      background: linear-gradient(135deg, #C8963E, #B8860B);
      color: #fff;
      font-size: 15px;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .btn:hover { opacity: 0.9; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .error-msg { color: #ef4444; font-size: 13px; margin-bottom: 16px; display: none; text-align: center; }
    .otp-section { display: none; }
    .otp-section.show { display: block; }
    .email-section.hide { display: none; }
    .back-link { text-align: center; margin-top: 16px; }
    .back-link a { color: #94a3b8; font-size: 13px; cursor: pointer; text-decoration: underline; }
    .back-link a:hover { color: #C8963E; }
    .info-msg { color: #22c55e; font-size: 13px; margin-bottom: 16px; display: none; text-align: center; }
    .remember-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; margin-top: -4px; }
    .remember-row label { display: flex; align-items: center; gap: 8px; font-size: 13px; color: #94a3b8; cursor: pointer; text-transform: none; letter-spacing: 0; font-weight: 400; }
    .remember-row input[type="checkbox"] {
      width: 16px; height: 16px; accent-color: #C8963E; cursor: pointer;
      border-radius: 3px; border: 1px solid rgba(255,255,255,0.2);
    }
    .remember-row a { color: #C8963E; font-size: 13px; text-decoration: none; }
    .remember-row a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div class="login-card">
    <div class="logo">
      <img src="/logo.png" alt="SRL">
      <h1>Silk Route Logistics</h1>
      <p>AE Command Center</p>
    </div>

    <div id="error" class="error-msg"></div>
    <div id="info" class="info-msg"></div>

    <!-- Step 1: Email + Password -->
    <div id="email-section" class="email-section">
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="email" placeholder="you@silkroutelogistics.ai" autocomplete="email">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="password" placeholder="Enter your password" autocomplete="current-password">
      </div>
      <div class="remember-row">
        <label><input type="checkbox" id="rememberMe"> Remember me</label>
        <a href="/auth/forgot-password">Forgot password?</a>
      </div>
      <button class="btn" id="login-btn" onclick="handleLogin()">Sign In</button>
    </div>

    <!-- Step 2: OTP -->
    <div id="otp-section" class="otp-section">
      <div class="form-group">
        <label>Verification Code</label>
        <input type="text" id="otp" placeholder="Enter 6-digit code" maxlength="6" autocomplete="one-time-code" inputmode="numeric">
      </div>
      <button class="btn" id="otp-btn" onclick="handleOtp()">Verify</button>
      <div class="back-link"><a onclick="goBack()">Back to sign in</a></div>
    </div>
  </div>

  <script src="/js/auth.js"></script>
  <script>
    var BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
      ? 'http://localhost:4000' : 'https://api.silkroutelogistics.ai';
    var pendingEmail = '';

    // Auto-fill remembered email
    var savedEmail = SRLAuth.getRememberedEmail('ae');
    if (savedEmail) {
      document.getElementById('email').value = savedEmail;
      document.getElementById('rememberMe').checked = true;
    }

    // If already logged in, redirect
    var existingToken = SRLAuth.getToken('token');
    if (existingToken) {
      fetch(BASE + '/api/auth/me', { headers: { 'Authorization': 'Bearer ' + existingToken } })
        .then(function(r) { if (r.ok) window.location.href = '/ae/dashboard/index.html'; });
    }

    // Enter key support
    document.getElementById('email').addEventListener('keydown', function(e) { if (e.key === 'Enter') document.getElementById('password').focus(); });
    document.getElementById('password').addEventListener('keydown', function(e) { if (e.key === 'Enter') handleLogin(); });
    document.getElementById('otp').addEventListener('keydown', function(e) { if (e.key === 'Enter') handleOtp(); });

    function showError(msg) {
      var el = document.getElementById('error');
      el.textContent = msg;
      el.style.display = msg ? 'block' : 'none';
      document.getElementById('info').style.display = 'none';
    }

    function showInfo(msg) {
      var el = document.getElementById('info');
      el.textContent = msg;
      el.style.display = msg ? 'block' : 'none';
      document.getElementById('error').style.display = 'none';
    }

    function handleLogin() {
      var email = document.getElementById('email').value.trim();
      var password = document.getElementById('password').value;
      if (!email || !password) { showError('Please enter email and password'); return; }

      var btn = document.getElementById('login-btn');
      btn.disabled = true;
      btn.textContent = 'Signing in...';
      showError('');

      fetch(BASE + '/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: email, password: password })
      })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        btn.disabled = false;
        btn.textContent = 'Sign In';

        if (data.error) {
          showError(data.error);
          return;
        }

        if (data.pendingOtp) {
          pendingEmail = email;
          document.getElementById('email-section').classList.add('hide');
          document.getElementById('otp-section').classList.add('show');
          showInfo('A verification code has been sent to your email');
          setTimeout(function() { document.getElementById('otp').focus(); }, 100);
          return;
        }

        if (data.token) {
          var remember = document.getElementById('rememberMe').checked;
          SRLAuth.setToken('token', data.token, remember);
          if (remember) {
            SRLAuth.setRememberedEmail(email, 'ae');
          } else {
            SRLAuth.setRememberedEmail('', 'ae');
          }
          window.location.href = '/ae/dashboard/index.html';
        }
      })
      .catch(function(err) {
        btn.disabled = false;
        btn.textContent = 'Sign In';
        showError('Connection error. Please try again.');
      });
    }

    function handleOtp() {
      var code = document.getElementById('otp').value.trim();
      if (!code || code.length < 6) { showError('Please enter the 6-digit code'); return; }

      var btn = document.getElementById('otp-btn');
      btn.disabled = true;
      btn.textContent = 'Verifying...';
      showError('');

      fetch(BASE + '/api/auth/verify-otp', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: pendingEmail, code: code })
      })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        btn.disabled = false;
        btn.textContent = 'Verify';

        if (data.error) {
          showError(data.error);
          return;
        }

        if (data.token) {
          var remember = document.getElementById('rememberMe').checked;
          SRLAuth.setToken('token', data.token, remember);
          if (remember) {
            SRLAuth.setRememberedEmail(pendingEmail, 'ae');
          } else {
            SRLAuth.setRememberedEmail('', 'ae');
          }
          var redirect = new URLSearchParams(window.location.search).get('redirect');
          window.location.href = redirect || '/ae/dashboard/index.html';
        }
      })
      .catch(function(err) {
        btn.disabled = false;
        btn.textContent = 'Verify';
        showError('Connection error. Please try again.');
      });
    }

    function goBack() {
      document.getElementById('email-section').classList.remove('hide');
      document.getElementById('otp-section').classList.remove('show');
      document.getElementById('otp').value = '';
      showError('');
      showInfo('');
    }
  </script>
</body>
</html>
