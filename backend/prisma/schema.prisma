generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Enums ───────────────────────────────────────────

enum UserRole {
  CARRIER
  BROKER
  SHIPPER
  FACTOR
  ADMIN
  DISPATCH
  OPERATIONS
  ACCOUNTING
  CEO
  AE
  READONLY
}

enum LoadStatus {
  DRAFT
  PLANNED
  POSTED
  TENDERED
  CONFIRMED
  BOOKED
  DISPATCHED
  AT_PICKUP
  LOADED
  IN_TRANSIT
  AT_DELIVERY
  DELIVERED
  POD_RECEIVED
  INVOICED
  COMPLETED
  TONU
  CANCELLED
  PICKED_UP // legacy alias
}

enum InvoiceStatus {
  DRAFT
  SUBMITTED
  SENT
  PARTIAL
  UNDER_REVIEW
  APPROVED
  FUNDED
  PAID
  OVERDUE
  REJECTED
  VOID
}

enum CarrierTier {
  PLATINUM
  GOLD
  SILVER
  BRONZE
  GUEST
  NONE
}

enum OnboardingStatus {
  PENDING
  DOCUMENTS_SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  SUSPENDED
}

enum ScorecardPeriod {
  WEEKLY
  MONTHLY
}

enum BonusType {
  PERFORMANCE
  REFERRAL
  VOLUME
  TIER
}

enum BonusStatus {
  PENDING
  APPROVED
  PAID
}

enum TenderStatus {
  OFFERED
  ACCEPTED
  COUNTERED
  DECLINED
  EXPIRED
}

enum LineItemType {
  LINEHAUL
  FUEL_SURCHARGE
  ACCESSORIAL
  DETENTION
  LUMPER
  OTHER
}

enum CarrierPayStatus {
  PENDING
  PREPARED
  SUBMITTED
  APPROVED
  PROCESSING
  PAID
  DISPUTED
  VOID
  ON_HOLD
  SCHEDULED
  REJECTED
}

enum PaymentMethod {
  ACH
  CHECK
  WIRE
  ZELLE
  QUICKPAY
  FACTORING
  OTHER
}

enum PaymentTier {
  FLASH
  EXPRESS
  PRIORITY
  PARTNER
  ELITE
  STANDARD
}

enum SettlementPeriod {
  WEEKLY
  BIWEEKLY
}

enum SettlementStatus {
  DRAFT
  FINALIZED
  PAID
}

enum IntegrationStatus {
  ACTIVE
  INACTIVE
  ERROR
}

enum ShipmentStatus {
  PENDING
  BOOKED
  DISPATCHED
  PICKED_UP
  IN_TRANSIT
  DELIVERED
  COMPLETED
  CANCELLED
}

enum DriverStatus {
  AVAILABLE
  ON_ROUTE
  OFF_DUTY
  SLEEPER
  INACTIVE
  ACTIVE
  TERMINATED
}

enum EquipmentStatus {
  ACTIVE
  IN_SHOP
  OUT_OF_SERVICE
}

enum TruckType {
  DAY_CAB
  SLEEPER
  STRAIGHT
  BOX_TRUCK
}

enum TrailerType {
  DRY_VAN
  REEFER
  FLATBED
  STEP_DECK
  LOWBOY
  TANKER
  CAR_HAULER
  CONESTOGA
  POWER_ONLY
  CONTAINER
}

enum OwnershipType {
  COMPANY
  LEASED
  OWNER_OPERATOR
}

enum AssetStatus {
  ACTIVE
  IN_SHOP
  OUT_OF_SERVICE
  SOLD
  MAINTENANCE
}

enum CustomerType {
  SHIPPER
  CONSIGNEE
  BOTH
}

enum CreditStatus {
  NOT_CHECKED
  APPROVED
  CONDITIONAL
  DENIED
  PENDING_REVIEW
}

enum CreditGrade {
  A
  B
  C
  D
}

enum ShipperPaymentTerms {
  NET15
  NET30
  NET60
  COD
}

enum CarrierApplicationStatus {
  NEW
  REVIEW
  APPROVED
  REJECTED
  SUSPENDED
}

enum ShipperStatus {
  NEW
  CONTACTED
  ACTIVE
  DECLINED
  SUSPENDED
}

enum DisputeType {
  SHORT_PAY
  WRONG_AMOUNT
  MISSING_ACCESSORIAL
  UNAUTHORIZED_DEDUCTION
  LATE_PAYMENT
  DOCUMENTATION
  OTHER
}

enum DisputeStatus {
  OPEN
  INVESTIGATING
  PROPOSED
  APPROVED
  DENIED
  CLOSED
}

enum FactoringTransactionType {
  INITIAL_DEPOSIT
  CARRIER_PAYMENT_OUT
  SHIPPER_PAYMENT_IN
  QP_FEE_EARNED
  ADJUSTMENT
  WITHDRAWAL
}

enum ReconciliationStatus {
  IN_PROGRESS
  RECONCILED
  DISCREPANCY
}

enum ApprovalType {
  CARRIER_PAYMENT
  INVOICE_VOID
  CREDIT_OVERRIDE
  FUND_ADJUSTMENT
  BULK_PAYMENT
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  ESCALATED
  EXPIRED
}

enum ReportType {
  WEEKLY
  MONTHLY
  QUARTERLY
  ANNUAL
  CUSTOM
}

enum ReportStatus {
  GENERATING
  COMPLETED
  FAILED
}

enum ClaimStatus {
  FILED
  UNDER_REVIEW
  INVESTIGATING
  RESOLVED
  CLOSED
}

enum ClaimType {
  DAMAGE
  SHORTAGE
  LATE
  NO_SHOW
  OTHER
}

enum LogType {
  API_CALL
  ERROR
  AUTH
  SECURITY
  PAYMENT
  STATUS_CHANGE
  CRON_JOB
  INTEGRATION
  ALERT
}

enum LogSeverity {
  INFO
  WARNING
  ERROR
  CRITICAL
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  STATUS_CHANGE
  APPROVE
  REJECT
  LOGIN
  EXPORT
  COMPLIANCE_OVERRIDE
  CARRIER_SUSPENDED
  SCAN
  DISMISS
  RESOLVE
}

enum NotificationType {
  CARRIER_APPLICATION
  LOAD_TENDERED
  LOAD_UPDATE
  PAYMENT_PENDING
  PAYMENT_APPROVED
  INVOICE_OVERDUE
  FUND_ALERT
  CREDIT_LIMIT
  CPP_UPGRADE
  DISPUTE_FILED
  POD_RECEIVED
  SYSTEM_ERROR
  GENERAL
}

enum ShipmentType {
  DOMESTIC
  CROSS_BORDER
}

enum RateType {
  FLAT
  PER_MILE
}

enum FuelSurchargeType {
  FLAT
  PERCENTAGE
}

enum AssignmentType {
  COMPANY_DRIVER
  PARTNER_CARRIER
}

enum CarrierPaymentMethod {
  QUICK_PAY
  STANDARD
  FACTORING
}

enum CheckCallDriverStatus {
  ON_SCHEDULE
  DELAYED_WEATHER
  DELAYED_MECHANICAL
  DELAYED_SHIPPER
  DELAYED_RECEIVER
  STOPPED_REST
  AT_PICKUP
  AT_DELIVERY
  LOADED
  EMPTY
  OTHER
}

// ─── Core Models ──────────────────────────────────────────

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  firstName     String
  lastName      String
  company       String?
  role          UserRole
  phone         String?
  isVerified    Boolean   @default(false)
  isActive      Boolean   @default(true)
  lastLogin     DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  carrierProfile  CarrierProfile?
  loadsPosted     Load[]          @relation("LoadPoster")
  loadsCarried    Load[]          @relation("LoadCarrier")
  invoices        Invoice[]
  documents       Document[]
  sentMessages    Message[]       @relation("MessageSender")
  receivedMessages Message[]      @relation("MessageReceiver")
  notifications   Notification[]
  auditLogs       AuditLog[]
  preferredTheme       String    @default("silk-route-classic")
  darkMode             Boolean   @default(false)
  passwordChangedAt    DateTime?
  totpSecret           String?
  totpEnabled          Boolean   @default(false)
  totpBackupCodes      String?
  otpCodes             OtpCode[]
  rateConfirmations    RateConfirmation[] @relation("RateConfCreator")
  checkCalls           CheckCall[]        @relation("CheckCallUser")
  carrierPays          CarrierPay[]       @relation("CarrierPayments")
  settlements          Settlement[]       @relation("CarrierSettlements")
  statusUpdates        Load[]             @relation("StatusUpdater")
  tenderedLoads        Load[]             @relation("TenderCreator")
  systemLogs           SystemLog[]
  auditTrails          AuditTrail[]       @relation("AuditPerformer")

  // Accounting relations
  preparedPayments   CarrierPay[]       @relation("PaymentPreparer")
  approvedPayments   CarrierPay[]       @relation("PaymentApprover")
  rejectedPayments   CarrierPay[]       @relation("PaymentRejecter")
  createdInvoices    Invoice[]          @relation("InvoiceCreator")
  filedDisputes      PaymentDispute[]   @relation("DisputeFiler")
  resolvedDisputes   PaymentDispute[]   @relation("DisputeResolver")
  factoringEntries   FactoringFund[]    @relation("FactoringCreator")
  reconciliations    BankReconciliation[] @relation("ReconciliationUser")
  communications     Communication[]
  filedClaims        Claim[]            @relation("ClaimFiler")
  assignedClaims     Claim[]            @relation("ClaimAssignee")
  requestedApprovals ApprovalQueue[]    @relation("ApprovalRequester")
  reviewedApprovals  ApprovalQueue[]    @relation("ApprovalReviewer")
  generatedReports   FinancialReport[]  @relation("ReportGenerator")
  errorLogs          ErrorLog[]         @relation("ErrorLogUser")
  marcoPoloChats     MarcoPoloConversation[]
  complianceNotes     ComplianceNote[]     @relation("ComplianceNotes")
  complianceOverrides ComplianceOverride[] @relation("ComplianceOverrides")

  // Shipper portal: link to Customer account
  customerAccount     Customer?            @relation("CustomerUser")

  @@index([email])
  @@index([role])
  @@index([isActive, role])
  @@index([company])
  @@map("users")
}

// ─── Carrier Models ──────────────────────────────────────

model CarrierProfile {
  id                    String                  @id @default(cuid())
  userId                String                  @unique
  user                  User                    @relation(fields: [userId], references: [id])
  mcNumber              String?                 @unique
  dotNumber             String?                 @unique
  companyName           String?
  contactName           String?
  contactPhone          String?
  contactEmail          String?
  insuranceExpiry       DateTime?
  safetyScore           Float?
  tier                  CarrierTier             @default(BRONZE)
  equipmentTypes        String[]
  operatingRegions      String[]
  preferredLanes        Json?
  onboardingStatus      OnboardingStatus        @default(PENDING)
  status                CarrierApplicationStatus @default(NEW)
  approvedAt            DateTime?
  w9Uploaded            Boolean                 @default(false)
  w9Url                 String?
  insuranceCertUploaded Boolean                 @default(false)
  coiUrl                String?
  authorityDocUploaded  Boolean                 @default(false)
  authorityLetterUrl    String?
  address               String?
  city                  String?
  state                 String?
  zip                   String?
  numberOfTrucks        Int?
  numberOfDrivers       Int?

  // Insurance details
  insuranceCompany       String?
  insurancePolicyNumber  String?
  cargoInsuranceAmount   Float?
  autoLiabilityAmount    Float?
  generalLiabilityAmount Float?

  // Payment preferences
  paymentPreference     PaymentTier?
  eldProvider           String?

  // CPP Loyalty
  cppTier             CarrierTier             @default(NONE)
  cppTotalLoads       Int                     @default(0)
  cppTotalMiles       Float                   @default(0)
  cppJoinedDate       DateTime?

  // FMCSA
  safetyRating          String?
  fmcsaBasicScores      Json?
  fmcsaAuthorityStatus  String?
  fmcsaLastChecked      DateTime?

  notes                 String?

  // Caravan / DAT source tracking
  source                String?                 @default("caravan")   // 'caravan' | 'dat'
  emergencyApproved     Boolean                 @default(false)
  emergencyApproveReason String?
  emergencyApprovedById String?
  emergencyApprovedAt   DateTime?

  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt

  scorecards  CarrierScorecard[]
  bonuses     CarrierBonus[]
  tenders     LoadTender[]

  complianceScans     ComplianceScan[]
  complianceReminders ComplianceReminder[]
  complianceNotes     ComplianceNote[]
  complianceOverrides ComplianceOverride[]

  // AI Learning
  aiIntelligence      CarrierIntelligence[] @relation("CarrierIntelligence")
  complianceForecast  ComplianceForecast?   @relation("ComplianceForecast")

  @@index([mcNumber])
  @@index([dotNumber])
  deletedAt   DateTime?
  deletedBy   String?

  @@index([status])
  @@index([cppTier])
  @@index([source])
  @@map("carrier_profiles")
}

model CarrierScorecard {
  id                          String          @id @default(cuid())
  carrierId                   String
  carrier                     CarrierProfile  @relation(fields: [carrierId], references: [id])
  period                      ScorecardPeriod
  onTimePickupPct             Float           @default(0)
  onTimeDeliveryPct           Float           @default(0)
  communicationScore          Float           @default(0)
  claimRatio                  Float           @default(0)
  documentSubmissionTimeliness Float          @default(0)
  acceptanceRate              Float           @default(0)
  gpsCompliancePct            Float           @default(0)
  overallScore                Float           @default(0)
  tierAtTime                  CarrierTier
  bonusEarned                 Float           @default(0)
  calculatedAt                DateTime        @default(now())

  @@index([carrierId, period])
  @@map("carrier_scorecards")
}

model CarrierBonus {
  id          String      @id @default(cuid())
  carrierId   String
  carrier     CarrierProfile @relation(fields: [carrierId], references: [id])
  type        BonusType
  amount      Float
  period      String?
  status      BonusStatus @default(PENDING)
  description String?
  createdAt   DateTime    @default(now())

  @@index([carrierId])
  @@map("carrier_bonuses")
}

// ─── Load & Tender Models ──────────────────────────────────

model Load {
  id              String     @id @default(cuid())
  referenceNumber String     @unique @default(cuid())
  loadNumber      String?    @unique
  status          LoadStatus @default(POSTED)

  // Route
  originCompany   String?
  originAddress   String?
  originCity      String
  originState     String
  originZip       String
  originContactName  String?
  originContactPhone String?
  destCompany     String?
  destAddress     String?
  destCity        String
  destState       String
  destZip         String
  destContactName  String?
  destContactPhone String?
  distance        Float?

  // Schedule
  pickupDate      DateTime
  pickupTimeStart String?
  pickupTimeEnd   String?
  deliveryDate    DateTime
  deliveryTimeStart String?
  deliveryTimeEnd String?
  actualPickupDatetime  DateTime?
  actualDeliveryDatetime DateTime?

  // Freight
  weight          Float?
  pieces          Int?
  pallets         Int?
  equipmentType   String
  trailerLength   String?
  commodity       String?
  freightClass    String?
  dimensionsLength Float?
  dimensionsWidth  Float?
  dimensionsHeight Float?
  stackable       Boolean    @default(true)

  // Hazmat
  hazmat          Boolean    @default(false)
  hazmatUnNumber  String?
  hazmatClass     String?
  hazmatEmergencyContact String?
  hazmatPlacardRequired Boolean @default(false)

  // Temperature
  temperatureControlled Boolean @default(false)
  tempMin         Float?
  tempMax         Float?
  tempContinuousMonitoring Boolean @default(false)

  // Customs / Cross-border
  customsRequired Boolean    @default(false)
  shipmentType    ShipmentType @default(DOMESTIC)
  borderCrossingPoint String?
  customsBrokerName   String?
  customsBrokerPhone  String?
  bondType        String?
  parsPapsNumber  String?

  // Shipper info
  shipperReference String?
  shipperPoNumber  String?
  pickupNumber     String?
  pickupInstructions String?
  pickupHours      String?
  loadingType      String?
  deliveryReference String?
  deliveryAppointment String?
  deliveryInstructions String?
  deliveryHours    String?
  unloadingType    String?

  // Multi-stop
  isMultiStop     Boolean    @default(false)
  stops           Json?
  extraStopPay    Float      @default(0)

  // Assignment
  assignmentType  AssignmentType?
  carrierDispatcherName String?
  carrierDispatcherPhone String?
  driverName      String?
  driverPhone     String?
  truckNumber     String?
  trailerNumber   String?

  // Financials
  rate            Float
  customerRate    Float?
  carrierRate     Float?
  rateType        RateType   @default(FLAT)
  fuelSurcharge   Float      @default(0)
  fuelSurchargeType FuelSurchargeType @default(FLAT)
  accessorials    Json?
  totalCarrierPay Float?
  grossMargin     Float?
  marginPercent   Float?
  revenuePerMile  Float?
  costPerMile     Float?
  marginPerMile   Float?

  // Status tracking
  statusUpdatedAt DateTime?
  statusUpdatedById String?
  statusUpdatedBy User?      @relation("StatusUpdater", fields: [statusUpdatedById], references: [id])

  // Documents
  rateConfirmationPdfUrl String?
  bolUrl          String?
  podUrl          String?
  podSigned       Boolean    @default(false)
  podReceivedAt   DateTime?

  // Tender
  tenderedAt      DateTime?
  tenderedById    String?
  tenderedBy      User?      @relation("TenderCreator", fields: [tenderedById], references: [id])
  carrierConfirmedAt DateTime?

  // Payment terms
  carrierPaymentMethod CarrierPaymentMethod?
  carrierPaymentTier   PaymentTier?
  quickPayFeePercent   Float?

  // Terms
  termsConditions  String?
  specialInstructions String?
  checkCallFrequency String?  @default("4 hours")
  noBrokerClause  Boolean    @default(true)

  notes           String?

  // Shipper Tracking
  trackingToken   String?    @unique @default(uuid())

  // DAT Load Board
  datPostId       String?
  datPostedAt     DateTime?
  datPostedFields Json?

  // Legacy fields kept for compatibility
  length          Float?
  width           Float?
  height          Float?
  contactName     String?
  contactPhone    String?

  // Asset assignment
  truckId         String?
  truck           Truck?     @relation(fields: [truckId], references: [id])
  trailerId       String?
  trailer         Trailer?   @relation(fields: [trailerId], references: [id])
  driverId        String?
  driver          Driver?    @relation(fields: [driverId], references: [id])
  customerId      String?
  customer        Customer?  @relation(fields: [customerId], references: [id])

  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  posterId        String
  poster          User       @relation("LoadPoster", fields: [posterId], references: [id])
  carrierId       String?
  carrier         User?      @relation("LoadCarrier", fields: [carrierId], references: [id])

  invoices        Invoice[]
  documents       Document[]
  tenders         LoadTender[]
  messages        Message[]
  ediTransactions EDITransaction[]
  shipments       Shipment[]
  rateConfirmations  RateConfirmation[]
  checkCalls      CheckCall[]
  carrierPays     CarrierPay[]
  matchResults    MatchResult[]
  checkCallSchedules CheckCallSchedule[]
  riskLogs        RiskLog[]
  fallOffEvents   FallOffEvent[]
  claims          Claim[]

  @@index([status])
  @@index([loadNumber])
  @@index([originState])
  @@index([destState])
  deletedAt          DateTime?
  deletedBy          String?
  cancellationReason String?

  @@index([customerId])
  @@index([carrierId])
  @@index([posterId])
  @@index([pickupDate])
  @@index([deliveryDate])
  @@index([statusUpdatedAt])
  @@index([status, createdAt])
  @@map("loads")
}

model LoadTender {
  id          String       @id @default(cuid())
  loadId      String
  load        Load         @relation(fields: [loadId], references: [id])
  carrierId   String
  carrier     CarrierProfile @relation(fields: [carrierId], references: [id])
  status      TenderStatus @default(OFFERED)
  offeredRate Float
  counterRate Float?
  respondedAt DateTime?
  expiresAt   DateTime
  createdAt   DateTime     @default(now())
  deletedAt   DateTime?

  @@index([carrierId, status])
  @@map("load_tenders")
}

// ─── Rate Confirmation ──────────────────────────────────

model RateConfirmation {
  id              String   @id @default(cuid())
  loadId          String
  load            Load     @relation(fields: [loadId], references: [id])
  rateConNumber   String?  @unique
  formData        Json
  pdfUrl          String?
  sentToEmail     String?
  sentAt          DateTime?
  signed          Boolean  @default(false)
  signedAt        DateTime?
  signedUrl       String?
  status          String   @default("DRAFT")

  // Indexed financial columns
  carrierRate     Float?
  fuelSurcharge   Float?
  accessorialTotal Float?
  totalCharges    Float?

  createdById     String
  createdBy       User     @relation("RateConfCreator", fields: [createdById], references: [id])

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  carrierPays     CarrierPay[]

  @@index([loadId])
  @@index([status])
  @@index([totalCharges])
  @@map("rate_confirmations")
}

// ─── Check Call (Track & Trace) ──────────────────────────

model CheckCall {
  id          String   @id @default(cuid())
  loadId      String
  load        Load     @relation(fields: [loadId], references: [id])
  status      String
  driverStatus CheckCallDriverStatus?
  location    String?
  city        String?
  state       String?
  notes       String?
  etaUpdate   DateTime?
  contactedBy String?
  method      String?
  calledById  String?
  calledBy    User?    @relation("CheckCallUser", fields: [calledById], references: [id])
  createdAt   DateTime @default(now())
  deletedAt   DateTime?

  @@index([loadId, createdAt])
  @@map("check_calls")
}

// ─── Finance Models ──────────────────────────────────

model Invoice {
  id              String        @id @default(cuid())
  invoiceNumber   String        @unique
  loadId          String
  load            Load          @relation(fields: [loadId], references: [id])
  status          InvoiceStatus @default(DRAFT)
  amount          Float
  lineHaulAmount  Float?
  fuelSurchargeAmount Float?
  accessorialsAmount  Float?
  totalAmount     Float?
  factoringFee    Float?
  advanceRate     Float?
  advanceAmount   Float?
  dueDate         DateTime?
  sentDate        DateTime?
  paidAt          DateTime?
  paidAmount      Float?
  paymentReference String?
  paymentMethod   PaymentMethod?
  pdfUrl          String?

  // Reminder tracking
  reminderSent31  Boolean   @default(false)
  reminderSent45  Boolean   @default(false)
  reminderSent60  Boolean   @default(false)
  reminderSentPre7  Boolean   @default(false)
  reminderSentDue   Boolean   @default(false)
  reminderSent7     Boolean   @default(false)
  reminderSent90    Boolean   @default(false)
  lastReminderAt    DateTime?

  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  userId          String
  user            User          @relation(fields: [userId], references: [id])
  createdById     String?
  createdBy       User?         @relation("InvoiceCreator", fields: [createdById], references: [id])

  documents       Document[]
  lineItems       InvoiceLineItem[]

  deletedAt   DateTime?

  @@index([status])
  @@index([userId, status])
  @@index([invoiceNumber])
  @@index([dueDate])
  @@map("invoices")
}

model InvoiceLineItem {
  id          String       @id @default(cuid())
  invoiceId   String
  invoice     Invoice      @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  description String
  quantity    Float        @default(1)
  rate        Float
  amount      Float
  type        LineItemType @default(LINEHAUL)
  sortOrder   Int          @default(0)
  createdAt   DateTime     @default(now())

  @@index([invoiceId])
  @@map("invoice_line_items")
}

// ─── Carrier Pay (Accounts Payable) ──────────────────────

model CarrierPay {
  id                String          @id @default(cuid())
  paymentNumber     String?         @unique
  carrierId         String
  carrier           User            @relation("CarrierPayments", fields: [carrierId], references: [id])
  loadId            String
  load              Load            @relation(fields: [loadId], references: [id])
  rateConfirmationId String?
  rateConfirmation  RateConfirmation? @relation(fields: [rateConfirmationId], references: [id])

  // Payment tier
  paymentTier       PaymentTier     @default(STANDARD)

  // Amounts
  lineHaul          Float?
  fuelSurcharge     Float?
  accessorialsTotal Float?
  amount            Float
  grossAmount       Float?
  quickPayDiscount  Float?
  quickPayFeePercent Float?         @default(0)
  quickPayFeeAmount Float?          @default(0)
  netAmount         Float

  status            CarrierPayStatus @default(PENDING)
  paymentMethod     PaymentMethod?
  checkNumber       String?
  referenceNumber   String?
  scheduledDate     DateTime?
  paidAt            DateTime?
  dueDate           DateTime?
  paymentDate       DateTime?

  // Approval workflow
  preparedById      String?
  preparedBy        User?           @relation("PaymentPreparer", fields: [preparedById], references: [id])
  preparedAt        DateTime?
  submittedAt       DateTime?
  approvedById      String?
  approvedBy        User?           @relation("PaymentApprover", fields: [approvedById], references: [id])
  approvedAt        DateTime?
  rejectedById      String?
  rejectedBy        User?           @relation("PaymentRejecter", fields: [rejectedById], references: [id])
  rejectedAt        DateTime?
  rejectionReason   String?

  // Remit-to info
  remitToName       String?
  remitToAddress    String?

  // Document checklist
  docSignedRateCon  Boolean         @default(false)
  docSignedBol      Boolean         @default(false)
  docPod            Boolean         @default(false)
  docCarrierInvoice Boolean         @default(false)
  docLumperReceipt  Boolean         @default(false)
  docScaleTicket    Boolean         @default(false)
  docTempLog        Boolean         @default(false)
  allDocsVerified   Boolean         @default(false)

  notes             String?
  settlementId      String?
  settlement        Settlement?     @relation(fields: [settlementId], references: [id])
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  disputes          PaymentDispute[]

  @@index([carrierId, status])
  @@index([loadId])
  @@index([status])
  @@index([dueDate])
  @@index([paymentTier])
  @@map("carrier_pays")
}

// ─── Payment Disputes ──────────────────────────────────

model PaymentDispute {
  id                String          @id @default(cuid())
  disputeNumber     String?         @unique
  carrierPaymentId  String
  carrierPayment    CarrierPay      @relation(fields: [carrierPaymentId], references: [id])
  loadId            String?
  carrierId         String?

  disputeType       DisputeType
  disputedAmount    Float
  description       String
  status            DisputeStatus   @default(OPEN)

  investigationNotes String?
  proposedResolution String?
  proposedAmount    Float?
  resolutionNotes   String?
  resolutionAmount  Float?

  filedById         String
  filedBy           User            @relation("DisputeFiler", fields: [filedById], references: [id])
  resolvedById      String?
  resolvedBy        User?           @relation("DisputeResolver", fields: [resolvedById], references: [id])
  filedAt           DateTime        @default(now())
  resolvedAt        DateTime?

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([status])
  @@index([carrierPaymentId])
  @@map("payment_disputes")
}

// ─── Shipper Credit ──────────────────────────────────

model ShipperCredit {
  id                String          @id @default(cuid())
  customerId        String          @unique
  customer          Customer        @relation(fields: [customerId], references: [id])

  creditGrade       CreditGrade     @default(B)
  creditLimit       Float           @default(0)
  currentUtilized   Float           @default(0)
  paymentTerms      ShipperPaymentTerms @default(NET30)
  avgDaysToPay      Float           @default(0)
  totalInvoices     Int             @default(0)
  onTimePayments    Int             @default(0)
  latePayments      Int             @default(0)
  lastCreditReview  DateTime?
  autoBlocked       Boolean         @default(false)
  blockedReason     String?
  blockedAt         DateTime?
  notes             String?

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@map("shipper_credits")
}

// ─── Factoring Fund ──────────────────────────────────

model FactoringFund {
  id                String          @id @default(cuid())
  transactionType   FactoringTransactionType
  amount            Float
  runningBalance    Float
  referenceType     String?
  referenceId       String?
  description       String
  createdById       String?
  createdBy         User?           @relation("FactoringCreator", fields: [createdById], references: [id])
  createdAt         DateTime        @default(now())

  @@index([createdAt])
  @@index([transactionType])
  @@map("factoring_fund")
}

// ─── Bank Reconciliation ──────────────────────────────────

model BankReconciliation {
  id                  String          @id @default(cuid())
  accountName         String
  periodStart         DateTime
  periodEnd           DateTime
  bankStatementBalance Float
  systemBalance       Float
  difference          Float
  status              ReconciliationStatus @default(IN_PROGRESS)
  matchedCount        Int             @default(0)
  unmatchedCount      Int             @default(0)
  reconciledById      String?
  reconciledBy        User?           @relation("ReconciliationUser", fields: [reconciledById], references: [id])
  reconciledAt        DateTime?
  csvUploadUrl        String?
  notes               String?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  @@map("bank_reconciliations")
}

// ─── Settlement ──────────────────────────────────────────

model Settlement {
  id               String           @id @default(cuid())
  settlementNumber String           @unique
  carrierId        String
  carrier          User             @relation("CarrierSettlements", fields: [carrierId], references: [id])
  periodStart      DateTime
  periodEnd        DateTime
  period           SettlementPeriod
  grossPay         Float
  deductions       Float            @default(0)
  netSettlement    Float
  status           SettlementStatus @default(DRAFT)
  paidAt           DateTime?
  notes            String?
  carrierPays      CarrierPay[]
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  deletedAt   DateTime?

  @@index([carrierId, status])
  @@index([periodStart, periodEnd])
  @@map("settlements")
}

// ─── Document & Communication Models ──────────────────

model Document {
  id          String   @id @default(cuid())
  fileName    String
  fileUrl     String
  fileType    String
  fileSize    Int
  entityType  String?  // LOAD, CARRIER, SHIPPER, INVOICE
  entityId    String?
  docType     String?  // BOL, POD, RATE_CON, W9, COI, AUTHORITY, OTHER
  createdAt   DateTime @default(now())

  userId      String
  user        User     @relation(fields: [userId], references: [id])
  loadId      String?
  load        Load?    @relation(fields: [loadId], references: [id])
  invoiceId   String?
  invoice     Invoice? @relation(fields: [invoiceId], references: [id])

  @@index([entityType, entityId])
  @@map("documents")
}

model Message {
  id         String   @id @default(cuid())
  senderId   String
  sender     User     @relation("MessageSender", fields: [senderId], references: [id])
  receiverId String
  receiver   User     @relation("MessageReceiver", fields: [receiverId], references: [id])
  loadId     String?
  load       Load?    @relation(fields: [loadId], references: [id])
  content    String
  readAt     DateTime?
  createdAt  DateTime @default(now())

  @@index([senderId, receiverId])
  @@index([receiverId, readAt])
  @@map("messages")
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id])
  type      String
  title     String
  message   String
  link      String?
  read      Boolean          @default(false)
  readAt    DateTime?
  actionUrl String?
  createdAt DateTime         @default(now())

  @@index([userId, read])
  @@index([userId, readAt])
  @@index([createdAt])
  @@map("notifications")
}

// ─── Customer / Shipper Models ──────────────────────────

model Customer {
  id              String       @id @default(cuid())
  name            String
  type            CustomerType @default(SHIPPER)
  contactName     String?
  email           String?
  phone           String?

  // Link to User account (shipper portal login)
  userId          String?      @unique
  user            User?        @relation("CustomerUser", fields: [userId], references: [id])
  address         String?
  city            String?
  state           String?
  zip             String?
  status          String       @default("Active")
  rating          Int          @default(0)
  notes           String?
  industry        String?

  // Financial
  creditLimit     Float?
  creditStatus    CreditStatus @default(NOT_CHECKED)
  creditCheckDate DateTime?
  paymentTerms    String?      @default("Net 30")
  taxId           String?
  annualRevenue   Float?

  // Business
  mcNumber        String?
  industryType    String?
  avgLoadsPerMonth Int?
  preferredEquipment String[]
  onboardingStatus OnboardingStatus @default(PENDING)
  contractUrl     String?
  origins         Json?
  destinations    Json?

  // Billing
  billingContactName  String?
  billingContactEmail String?
  billingContactPhone String?
  billingAddress  String?
  billingCity     String?
  billingState    String?
  billingZip      String?
  billingEmail    String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  shipments       Shipment[]
  loads           Load[]
  contacts        CustomerContact[]
  shipperCredit   ShipperCredit?

  // AI Learning
  aiIntelligence  CustomerIntelligence? @relation("CustomerIntelligence")

  deletedAt   DateTime?
  deletedBy   String?

  @@index([status])
  @@map("customers")
}

model CustomerContact {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  name       String
  title      String?
  email      String?
  phone      String?
  isPrimary  Boolean  @default(false)
  createdAt  DateTime @default(now())

  @@index([customerId])
  @@map("customer_contacts")
}

// ─── Fleet / Asset Models ──────────────────────────

model Truck {
  id                  String        @id @default(cuid())
  unitNumber          String        @unique
  type                TruckType     @default(SLEEPER)
  year                Int?
  make                String?
  model               String?
  vin                 String?       @unique
  licensePlate        String?
  licensePlateState   String?
  color               String?
  fuelType            String?       @default("Diesel")
  ownershipType       OwnershipType @default(COMPANY)
  status              AssetStatus   @default(ACTIVE)
  mileage             Int           @default(0)

  registrationExpiry  DateTime?
  lastInspectionDate  DateTime?
  nextInspectionDate  DateTime?
  insuranceExpiry     DateTime?
  ifta                Boolean       @default(false)
  iftaExpiry          DateTime?

  lastServiceDate     DateTime?
  nextServiceDate     DateTime?
  nextServiceMileage  Int?

  assignedDriverId    String?       @unique
  assignedDriver      Driver?       @relation("TruckDriver")

  loads               Load[]
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  @@map("trucks")
}

model Trailer {
  id                  String        @id @default(cuid())
  unitNumber          String        @unique
  type                TrailerType   @default(DRY_VAN)
  year                Int?
  make                String?
  model               String?
  vin                 String?       @unique
  licensePlate        String?
  licensePlateState   String?
  length              Int?
  capacity            Int?
  ownershipType       OwnershipType @default(COMPANY)
  status              AssetStatus   @default(ACTIVE)

  registrationExpiry  DateTime?
  lastInspectionDate  DateTime?
  nextInspectionDate  DateTime?

  reeferUnit          Boolean       @default(false)
  reeferModel         String?
  reeferHours         Int?

  assignedDriverId    String?       @unique
  assignedDriver      Driver?       @relation("TrailerDriver")

  loads               Load[]
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  @@map("trailers")
}

model Driver {
  id              String       @id @default(cuid())
  firstName       String
  lastName        String
  phone           String?
  email           String?
  dateOfBirth     DateTime?
  licenseType     String
  licenseNumber   String?
  licenseState    String?
  licenseExpiry   DateTime?
  status          DriverStatus @default(AVAILABLE)
  currentLocation String?
  hireDate        DateTime?
  terminationDate DateTime?
  safetyScore     Float        @default(100)
  violations      Int          @default(0)

  medicalCardExpiry DateTime?
  drugTestDate      DateTime?
  endorsements      String[]
  twicCard          Boolean       @default(false)
  twicExpiry        DateTime?
  backgroundCheckDate DateTime?
  mvrDate           DateTime?

  emergencyContactName  String?
  emergencyContactPhone String?

  hosDrivingUsed  Float        @default(0)
  hosOnDutyUsed   Float        @default(0)
  hosCycleUsed    Float        @default(0)
  hosCycleLimit   Float        @default(70)

  // CPP miles
  cppMilesEarned Float       @default(0)

  assignedTruckId     String?  @unique
  assignedTruck       Truck?   @relation("TruckDriver", fields: [assignedTruckId], references: [id])
  assignedTrailerId   String?  @unique
  assignedTrailer     Trailer? @relation("TrailerDriver", fields: [assignedTrailerId], references: [id])

  assignedEquipmentId String?  @unique
  assignedEquipment   Equipment? @relation("DriverEquipment", fields: [assignedEquipmentId], references: [id])

  shipments       Shipment[]
  loads           Load[]

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@map("drivers")
}

// ─── Shipment (legacy/external) ──────────────────────────

model Shipment {
  id              String         @id @default(cuid())
  shipmentNumber  String         @unique @default(cuid())
  proNumber       String?        @unique
  bolNumber       String?
  status          ShipmentStatus @default(PENDING)

  originCity      String
  originState     String
  originZip       String
  destCity        String
  destState       String
  destZip         String

  weight          Float?
  pieces          Int?
  commodity       String?
  equipmentType   String
  rate            Float
  distance        Float?
  specialInstructions String?

  pickupDate      DateTime
  deliveryDate    DateTime
  actualPickup    DateTime?
  actualDelivery  DateTime?

  customerId      String?
  customer        Customer?  @relation(fields: [customerId], references: [id])
  driverId        String?
  driver          Driver?    @relation(fields: [driverId], references: [id])
  equipmentId     String?
  equipment       Equipment? @relation(fields: [equipmentId], references: [id])

  loadId          String?
  load            Load?      @relation(fields: [loadId], references: [id])

  lastLocation    String?
  lastLocationAt  DateTime?
  eta             DateTime?

  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  @@index([status])
  @@index([customerId])
  @@index([driverId])
  @@index([loadId])
  @@map("shipments")
}

// ─── Legacy Equipment ───

model Equipment {
  id              String          @id @default(cuid())
  unitNumber      String          @unique
  type            String
  year            Int?
  make            String?
  model           String?
  vin             String?         @unique
  status          EquipmentStatus @default(ACTIVE)
  mileage         Int             @default(0)
  nextServiceDate DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  assignedDriver  Driver?         @relation("DriverEquipment")
  shipments       Shipment[]

  @@map("equipment")
}

// ─── SOP ──────────────────────────────────────────

model SOP {
  id          String   @id @default(cuid())
  title       String
  category    String
  version     String
  author      String
  description String?
  content     String?
  fileUrl     String?
  pages       Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@map("sops")
}

// ─── Integration & EDI ──────────────────────────────────

model BrokerIntegration {
  id              String            @id @default(cuid())
  name            String
  provider        String            @unique
  apiEndpoint     String?
  apiKeyEncrypted String?
  status          IntegrationStatus @default(INACTIVE)
  config          String?
  lastSyncAt      DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@map("broker_integrations")
}

model EDITransaction {
  id              String   @id @default(cuid())
  transactionSet  String
  direction       String
  loadId          String?
  load            Load?    @relation(fields: [loadId], references: [id])
  carrierId       String?
  rawPayload      String
  status          String   @default("PENDING")
  errorMessage    String?
  createdAt       DateTime @default(now())
  processedAt     DateTime?

  @@index([transactionSet, status])
  @@index([loadId])
  @@map("edi_transactions")
}

// ─── System Monitoring ──────────────────────────────────

model SystemLog {
  id          String      @id @default(cuid())
  logType     LogType
  severity    LogSeverity @default(INFO)
  source      String
  endpoint    String?
  userId      String?
  user        User?       @relation(fields: [userId], references: [id])
  message     String
  details     Json?
  ipAddress   String?
  durationMs  Int?
  createdAt   DateTime    @default(now())

  @@index([logType])
  @@index([severity])
  @@index([createdAt])
  @@map("system_logs")
}

model AuditTrail {
  id            String      @id @default(cuid())
  entityType    String
  entityId      String
  action        AuditAction
  changedFields Json?
  performedById String
  performedBy   User        @relation("AuditPerformer", fields: [performedById], references: [id])
  performedAt   DateTime    @default(now())
  ipAddress     String?

  @@index([entityType, entityId])
  @@index([performedAt])
  @@map("audit_trails")
}

// ─── Audit & Compliance (legacy) ──────────────────────────

model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  action     String
  entity     String
  entityId   String?
  changes    String?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([entity, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

model ComplianceAlert {
  id          String   @id @default(cuid())
  type        String
  entityType  String
  entityId    String
  entityName  String
  expiryDate  DateTime
  status      String   @default("ACTIVE")
  severity    String   @default("WARNING")
  notifiedAt   DateTime?
  resolvedAt   DateTime?
  snoozedUntil DateTime?
  createdAt    DateTime @default(now())

  @@index([status, severity])
  @@index([entityType, entityId])
  @@index([expiryDate])
  @@map("compliance_alerts")
}

model ComplianceScan {
  id              String   @id @default(cuid())
  carrierId       String
  scanType        String   @default("FMCSA_AUTO")
  fmcsaData       Json?
  previousData    Json?
  changesDetected Json?
  status          String   @default("PASSED")
  scannedAt       DateTime @default(now())
  carrier         CarrierProfile @relation(fields: [carrierId], references: [id])

  @@index([carrierId])
  @@index([scannedAt])
  @@map("compliance_scans")
}

model ComplianceReminder {
  id          String   @id @default(cuid())
  carrierId   String
  itemType    String
  tier        String
  sentAt      DateTime @default(now())
  emailStatus String   @default("SENT")
  carrier     CarrierProfile @relation(fields: [carrierId], references: [id])

  @@index([carrierId])
  @@index([sentAt])
  @@map("compliance_reminders")
}

model ComplianceNote {
  id        String   @id @default(cuid())
  carrierId String
  authorId  String
  content   String   @db.Text
  createdAt DateTime @default(now())
  carrier   CarrierProfile @relation(fields: [carrierId], references: [id])
  author    User     @relation("ComplianceNotes", fields: [authorId], references: [id])

  @@index([carrierId])
  @@map("compliance_notes")
}

model ComplianceOverride {
  id        String   @id @default(cuid())
  carrierId String
  reason    String   @db.Text
  adminId   String
  expiresAt DateTime
  createdAt DateTime @default(now())
  carrier   CarrierProfile @relation(fields: [carrierId], references: [id])
  admin     User     @relation("ComplianceOverrides", fields: [adminId], references: [id])

  @@index([carrierId])
  @@index([expiresAt])
  @@map("compliance_overrides")
}

// ─── Communication Log ──────────────────────────────────

model Communication {
  id          String   @id @default(cuid())
  type        String   // CALL_INBOUND, CALL_OUTBOUND, TEXT_INBOUND, TEXT_OUTBOUND, EMAIL_INBOUND, EMAIL_OUTBOUND, NOTE
  direction   String?  // INBOUND, OUTBOUND
  entityType  String   // CARRIER, SHIPPER, LOAD
  entityId    String
  loadId      String?
  from        String?  // Phone number or email
  to          String?
  subject     String?
  body        String?  @db.Text
  phoneNumber String?
  duration    Int?     // Call duration in seconds
  metadata    Json?
  userId      String   // Who logged this
  user        User     @relation(fields: [userId], references: [id])
  createdAt   DateTime @default(now())

  @@index([entityType, entityId])
  @@index([loadId])
  @@index([userId])
  @@index([createdAt])
  @@map("communications")
}

// ─── JWT Blacklist (Token Revocation on Logout) ────────────

model TokenBlacklist {
  id        String   @id @default(cuid())
  tokenHash String   @unique
  userId    String
  expiresAt DateTime
  reason    String   @default("logout")
  createdAt DateTime @default(now())

  @@index([tokenHash])
  @@index([expiresAt])
  @@map("token_blacklist")
}

// ─── OTP Codes ──────────────────────────────────────────

model OtpCode {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  code      String
  expiresAt DateTime
  used           Boolean  @default(false)
  failedAttempts Int      @default(0)
  createdAt      DateTime @default(now())

  @@index([userId, used])
  @@map("otp_codes")
}

// ─── Smart Carrier Matching (C.1) ──────────────────────────

model MatchResult {
  id              String   @id @default(cuid())
  loadId          String
  load            Load     @relation(fields: [loadId], references: [id])
  carrierId       String   // CarrierProfile id
  userId          String   // User id of carrier
  matchScore      Float
  laneScore       Float    @default(0)
  rateScore       Float    @default(0)
  cppScore      Float    @default(0)
  availabilityScore Float  @default(0)
  breakdown       Json?
  rank            Int      @default(0)
  wasAssigned     Boolean  @default(false)
  wasCompleted    Boolean  @default(false)
  createdAt       DateTime @default(now())

  @@index([loadId])
  @@index([carrierId])
  @@map("match_results")
}

// ─── Check-Call Schedule (C.2) ──────────────────────────

model CheckCallSchedule {
  id              String   @id @default(cuid())
  loadId          String
  load            Load     @relation(fields: [loadId], references: [id])
  scheduledTime   DateTime
  type            String   // PRE_PICKUP, AT_PICKUP, MIDPOINT, PRE_DELIVERY, AT_DELIVERY
  status          String   @default("PENDING")  // PENDING, SENT, RESPONDED, MISSED, ESCALATED
  sentAt          DateTime?
  respondedAt     DateTime?
  response        String?  // 1-5 carrier response
  responseText    String?
  retryCount      Int      @default(0)
  carrierPhone    String?
  escalatedAt     DateTime?
  createdAt       DateTime @default(now())

  @@index([loadId])
  @@index([status, scheduledTime])
  @@map("check_call_schedules")
}

// ─── Risk Log (C.3) ──────────────────────────

model RiskLog {
  id          String   @id @default(cuid())
  loadId      String
  load        Load     @relation(fields: [loadId], references: [id])
  score       Int      @default(0)
  level       String   // GREEN, AMBER, RED
  factors     Json     // Array of {factor, points, description}
  notified    Boolean  @default(false)
  createdAt   DateTime @default(now())

  @@index([loadId])
  @@index([level])
  @@index([createdAt])
  @@map("risk_logs")
}

// ─── Fall-Off Event (C.4) ──────────────────────────

model FallOffEvent {
  id              String   @id @default(cuid())
  loadId          String
  load            Load     @relation(fields: [loadId], references: [id])
  originalCarrierId String?
  reason          String?
  recoveryMethod  String?  // CARAVAN_MATCH, DAT, MANUAL
  newCarrierId    String?
  recoveryTimeMin Float?   // Minutes from fall-off to new assignment
  backupsSent     Int      @default(0)
  backupsAccepted Int      @default(0)
  status          String   @default("ACTIVE")  // ACTIVE, RECOVERED, UNRESOLVED
  resolvedAt      DateTime?
  createdAt       DateTime @default(now())

  @@index([loadId])
  @@index([status])
  @@map("fall_off_events")
}

// ─── Email Sequence (C.5) ──────────────────────────

model EmailSequence {
  id              String   @id @default(cuid())
  prospectId      String   // Customer id (prospect)
  prospectEmail   String
  prospectName    String
  templateName    String   @default("prospect_outreach")
  currentStep     Int      @default(0)  // 0-based
  totalSteps      Int      @default(4)
  nextSendAt      DateTime?
  status          String   @default("ACTIVE")  // ACTIVE, PAUSED, COMPLETED, STOPPED
  stopReason      String?  // REPLIED, MANUAL, STAGE_CHANGE
  schedule        Json     // [{day: 0, subject, template}, {day: 3, ...}, ...]
  metadata        Json?    // Track opens, clicks, etc.
  startedById     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([prospectId])
  @@index([status, nextSendAt])
  @@map("email_sequences")
}

// ─── Claims ───

model Claim {
  id              String      @id @default(cuid())
  claimNumber     String      @unique
  loadId          String
  load            Load        @relation(fields: [loadId], references: [id])
  claimType       ClaimType
  status          ClaimStatus @default(FILED)
  description     String      @db.Text
  estimatedValue  Float?
  resolvedValue   Float?
  photos          String[]
  notes           Json?       // Array of {date, author, text}
  filedById       String
  filedBy         User        @relation("ClaimFiler", fields: [filedById], references: [id])
  assignedToId    String?
  assignedTo      User?       @relation("ClaimAssignee", fields: [assignedToId], references: [id])
  resolvedAt      DateTime?
  closedAt        DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([loadId])
  @@index([status])
  @@index([claimType])
  @@map("claims")
}

// ─── Approval Queue ───

model ApprovalQueue {
  id              String         @id @default(cuid())
  type            ApprovalType
  status          ApprovalStatus @default(PENDING)
  referenceId     String
  referenceType   String         // CARRIER_PAY, INVOICE, CREDIT, FUND
  amount          Float
  description     String
  priority        String         @default("NORMAL") // LOW, NORMAL, HIGH, URGENT
  requestedById   String
  requestedBy     User           @relation("ApprovalRequester", fields: [requestedById], references: [id])
  requestedAt     DateTime       @default(now())
  reviewedById    String?
  reviewedBy      User?          @relation("ApprovalReviewer", fields: [reviewedById], references: [id])
  reviewedAt      DateTime?
  reviewNotes     String?
  escalatedToId   String?
  escalatedAt     DateTime?
  expiresAt       DateTime?
  metadata        Json?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([status])
  @@index([type])
  @@index([requestedById])
  @@index([referenceId])
  @@map("approval_queue")
}

// ─── Financial Reports ───

model FinancialReport {
  id              String       @id @default(cuid())
  reportType      ReportType
  status          ReportStatus @default(GENERATING)
  title           String
  periodStart     DateTime
  periodEnd       DateTime
  summary         Json?
  pdfUrl          String?
  csvUrl          String?
  generatedById   String?
  generatedBy     User?        @relation("ReportGenerator", fields: [generatedById], references: [id])
  generatedAt     DateTime?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([reportType])
  @@index([periodStart, periodEnd])
  @@map("financial_reports")
}

// ─── Scheduler Locks ───

model SchedulerLock {
  id        String   @id
  lockedAt  DateTime @default(now())
  lockedBy  String
  expiresAt DateTime

  @@map("scheduler_locks")
}

// ─── Cron Registry ───

model CronRegistry {
  id          String   @id @default(cuid())
  jobName     String   @unique
  schedule    String
  description String?
  lastRun     DateTime?
  lastStatus  String?  // SUCCESS, FAILED, RUNNING
  lastError   String?
  lastDuration Int?    // milliseconds
  nextRun     DateTime?
  enabled     Boolean  @default(true)
  runCount    Int      @default(0)
  failCount   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("cron_registry")
}

// ─── Mileage Cache ───

model MileageCache {
  id              String   @id @default(cuid())
  originHash      String   @map("origin_hash")
  destinationHash String   @map("destination_hash")
  originText      String   @map("origin_text")
  destinationText String   @map("destination_text")
  provider        String   // google, milemaker, pcmiler
  practicalMiles  Float    @map("practical_miles")
  shortestMiles   Float?   @map("shortest_miles")
  driveTimeHours  Float    @map("drive_time_hours")
  tollCost        Float?   @map("toll_cost")
  routeType       String   @map("route_type") // estimated, practical
  cachedAt        DateTime @default(now()) @map("cached_at")
  expiresAt       DateTime @map("expires_at")

  @@unique([originHash, destinationHash, provider])
  @@index([originHash, destinationHash])
  @@index([expiresAt])
  @@map("mileage_cache")
}

// ─── AI Auto-Learning Models ───

model RateIntelligence {
  id              String   @id @default(cuid())
  laneKey         String   @map("lane_key") // "origin_state:dest_state" or "origin_city:dest_city"
  equipmentType   String   @map("equipment_type") // DRY_VAN, REEFER, FLATBED
  avgRate         Float    @map("avg_rate")
  minRate         Float    @map("min_rate")
  maxRate         Float    @map("max_rate")
  medianRate      Float    @map("median_rate")
  stdDev          Float    @map("std_dev")
  sampleSize      Int      @map("sample_size")
  trend           String   @default("STABLE") // RISING, FALLING, STABLE, VOLATILE
  trendPct        Float    @default(0) @map("trend_pct")
  predictedRate   Float?   @map("predicted_rate")
  confidence      Float    @default(0) // 0-1 confidence score
  seasonalFactor  Float    @default(1.0) @map("seasonal_factor")
  dayOfWeekFactor Json?    @map("day_of_week_factor") // {mon: 1.02, tue: 0.98, ...}
  lastTrainedAt   DateTime @default(now()) @map("last_trained_at")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([laneKey, equipmentType])
  @@index([laneKey])
  @@index([equipmentType])
  @@map("rate_intelligence")
}

model CarrierIntelligence {
  id                  String   @id @default(cuid())
  carrierId           String   @map("carrier_id")
  carrier             CarrierProfile @relation("CarrierIntelligence", fields: [carrierId], references: [id])
  laneKey             String?  @map("lane_key")
  reliabilityScore    Float    @default(50) @map("reliability_score") // 0-100
  onTimeScore         Float    @default(50) @map("on_time_score")
  communicationScore  Float    @default(50) @map("communication_score")
  fallOffRisk         Float    @default(0.1) @map("fall_off_risk") // 0-1 probability
  rateNegotiability   Float    @default(0.5) @map("rate_negotiability") // 0-1 how flexible on rates
  preferredLanes      Json?    @map("preferred_lanes") // [{lane, score, loads}]
  performanceTrend    String   @default("STABLE") @map("performance_trend") // IMPROVING, DECLINING, STABLE
  predictedNextTier   String?  @map("predicted_next_tier")
  churnRisk           Float    @default(0.1) @map("churn_risk") // 0-1 probability carrier leaves
  totalDataPoints     Int      @default(0) @map("total_data_points")
  lastTrainedAt       DateTime @default(now()) @map("last_trained_at")

  // Merged: aggregate carrier scoring fields
  compositeScore      Float    @default(50) @map("composite_score")
  onTimeRate          Float    @default(0) @map("on_time_rate")
  tenderAcceptRate    Float    @default(0) @map("tender_accept_rate")
  avgResponseMinutes  Float    @default(0) @map("avg_response_minutes")
  damageRate          Float    @default(0) @map("damage_rate")
  claimRate           Float    @default(0) @map("claim_rate")
  totalLoadsCompleted Int      @default(0) @map("total_loads_completed")
  tier                String   @default("GOOD")
  scoreHistoryJson    Json     @default("[]") @map("score_history_json")
  weightConfigJson    Json     @default("{}") @map("weight_config_json")
  lastFullRecalc      DateTime? @map("last_full_recalc")

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([carrierId, laneKey])
  @@index([carrierId])
  @@index([reliabilityScore])
  @@index([compositeScore])
  @@index([tier])
  @@map("carrier_intelligence")
}

model LaneIntelligence {
  id                String   @id @default(cuid())
  originState       String   @map("origin_state")
  originCity        String?  @map("origin_city")
  destState         String   @map("dest_state")
  destCity          String?  @map("dest_city")
  laneKey           String   @unique @map("lane_key")
  totalLoads        Int      @default(0) @map("total_loads")
  avgTransitDays    Float    @default(0) @map("avg_transit_days")
  avgMiles          Float    @default(0) @map("avg_miles")
  avgRate           Float    @default(0) @map("avg_rate")
  avgRpm            Float    @default(0) @map("avg_rpm")
  demand            String   @default("MODERATE") // HIGH, MODERATE, LOW
  demandTrend       String   @default("STABLE") @map("demand_trend") // RISING, FALLING, STABLE
  bestDaysToBook    Json?    @map("best_days_to_book") // [0,1,2] = Sun, Mon, Tue
  avgLeadTimeDays   Float    @default(3) @map("avg_lead_time_days")
  backhaulLaneKey   String?  @map("backhaul_lane_key") // Best return lane
  backhaulScore     Float    @default(0) @map("backhaul_score") // 0-100
  deadheadAvgMiles  Float    @default(0) @map("deadhead_avg_miles")
  competitorDensity String   @default("MEDIUM") @map("competitor_density") // HIGH, MEDIUM, LOW
  seasonality       Json?    // {jan: 1.1, feb: 0.9, ...}
  lastTrainedAt     DateTime @default(now()) @map("last_trained_at")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([originState, destState])
  @@index([demand])
  @@map("lane_intelligence")
}

model CustomerIntelligence {
  id                  String   @id @default(cuid())
  customerId          String   @unique @map("customer_id")
  customer            Customer @relation("CustomerIntelligence", fields: [customerId], references: [id])
  lifetimeValue       Float    @default(0) @map("lifetime_value")
  avgLoadFrequency    Float    @default(0) @map("avg_load_frequency") // loads per month
  avgLoadValue        Float    @default(0) @map("avg_load_value")
  churnRisk           Float    @default(0.1) @map("churn_risk") // 0-1
  churnReason         String?  @map("churn_reason")
  growthPotential     Float    @default(0.5) @map("growth_potential") // 0-1
  paymentReliability  Float    @default(1.0) @map("payment_reliability") // 0-1
  avgPaymentDays      Float    @default(30) @map("avg_payment_days")
  preferredLanes      Json?    @map("preferred_lanes")
  preferredEquipment  Json?    @map("preferred_equipment")
  seasonalPattern     Json?    @map("seasonal_pattern") // monthly shipping volumes
  lastShipmentAt      DateTime? @map("last_shipment_at")
  daysSinceLastLoad   Int      @default(0) @map("days_since_last_load")
  engagementScore     Float    @default(50) @map("engagement_score") // 0-100
  recommendedAction   String?  @map("recommended_action") // UPSELL, RETAIN, RE-ENGAGE, NURTURE
  lastTrainedAt       DateTime @default(now()) @map("last_trained_at")

  // Merged: shipper intelligence fields
  paymentScore        Float    @default(50) @map("payment_score")
  disputeRate         Float    @default(0) @map("dispute_rate")
  volumeTrend         String   @default("STABLE") @map("volume_trend")
  creditScore         Float    @default(50) @map("credit_score")
  totalLoads          Int      @default(0) @map("total_loads")

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([churnRisk])
  @@index([engagementScore])
  @@index([creditScore])
  @@map("customer_intelligence")
}

model ComplianceForecast {
  id                  String   @id @default(cuid())
  carrierId           String   @map("carrier_id")
  carrier             CarrierProfile @relation("ComplianceForecast", fields: [carrierId], references: [id])
  insuranceExpiryRisk Float    @default(0) @map("insurance_expiry_risk") // 0-1
  authorityRisk       Float    @default(0) @map("authority_risk")
  safetyRisk          Float    @default(0) @map("safety_risk")
  overallRisk         Float    @default(0) @map("overall_risk")
  predictedIssues     Json?    @map("predicted_issues") // [{type, probability, eta}]
  daysUntilExpiry     Int?     @map("days_until_expiry") // nearest expiring doc
  recommendedAction   String?  @map("recommended_action")
  autoAlertSent       Boolean  @default(false) @map("auto_alert_sent")
  lastTrainedAt       DateTime @default(now()) @map("last_trained_at")
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([carrierId])
  @@index([overallRisk])
  @@map("compliance_forecast")
}

model AILearningCycle {
  id              String   @id @default(cuid())
  serviceName     String   @map("service_name") // rate, carrier, lane, customer, compliance, system
  cycleType       String   @map("cycle_type") // DAILY, WEEKLY, MONTHLY, ON_DEMAND
  dataPointsProcessed Int  @default(0) @map("data_points_processed")
  modelsUpdated   Int      @default(0) @map("models_updated")
  accuracy        Float?   // Self-measured accuracy improvement
  durationMs      Int      @default(0) @map("duration_ms")
  improvements    Json?    // [{metric, before, after, delta}]
  errors          Json?    // Any issues during learning
  status          String   @default("COMPLETED") // RUNNING, COMPLETED, FAILED
  startedAt       DateTime @default(now()) @map("started_at")
  completedAt     DateTime? @map("completed_at")

  @@index([serviceName])
  @@index([startedAt])
  @@map("ai_learning_cycles")
}

model SystemMetric {
  id              String   @id @default(cuid())
  metricName      String   @map("metric_name")
  metricValue     Float    @map("metric_value")
  previousValue   Float?   @map("previous_value")
  changePercent   Float?   @map("change_percent")
  category        String   // PERFORMANCE, REVENUE, OPERATIONS, CARRIER, CUSTOMER
  period          String   // DAILY, WEEKLY, MONTHLY
  metadata        Json?
  recordedAt      DateTime @default(now()) @map("recorded_at")

  @@index([metricName, recordedAt])
  @@index([category])
  @@map("system_metrics")
}

// ─── Error Log ───

model ErrorLog {
  id          String   @id @default(cuid())
  errorType   String   // UNHANDLED, VALIDATION, DATABASE, INTEGRATION, CRON, AUTH
  message     String
  stackTrace  String?
  endpoint    String?
  method      String?
  userId      String?
  user        User?    @relation("ErrorLogUser", fields: [userId], references: [id])
  ipAddress   String?
  userAgent   String?
  statusCode  Int?
  metadata    Json?
  createdAt   DateTime @default(now())

  @@index([errorType])
  @@index([createdAt])
  @@index([userId])
  @@map("error_logs")
}

// ─── Website Leads & Contact Submissions ──────────────────────────

model WebsiteLead {
  id          String   @id @default(cuid())
  type        String   // "quote_request" or "contact"
  name        String
  company     String
  email       String
  phone       String?
  // Quote-specific fields
  originCity  String?
  originState String?
  destCity    String?
  destState   String?
  equipment   String?
  weight      String?
  pickupDate  String?
  details     String?
  // Contact-specific fields
  inquiryType String?
  message     String?
  // Tracking
  status      String   @default("new") // new, contacted, qualified, converted
  notes       String?
  assignedTo  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@map("website_leads")
}

// ─── Marco Polo Chat Conversations ──────────────────────────────

model MarcoPoloConversation {
  id           String   @id @default(cuid())
  userId       String
  role         String   // user role at time of conversation
  messagesJson Json     @default("[]") // array of {role, content, timestamp, actions?}
  console      String   @default("ae") // ae, carrier, accounting, public
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([updatedAt])
  @@map("marco_polo_conversations")
}

// ─── News Aggregation ──────────────────────────────────────────

model NewsArticle {
  id           String   @id @default(cuid())
  title        String
  slug         String   @unique
  excerpt      String   @db.Text
  content      String?  @db.Text
  sourceUrl    String   @unique
  sourceName   String
  sourceIcon   String?
  imageUrl     String?
  category     String   @default("Industry")
  tags         String[] @default([])
  publishedAt  DateTime
  fetchedAt    DateTime @default(now())
  featured     Boolean  @default(false)

  @@index([category])
  @@index([publishedAt])
  @@index([featured])
}

model NewsSource {
  id          String   @id @default(cuid())
  name        String   @unique
  feedUrl     String
  iconUrl     String?
  category    String   @default("Industry")
  isActive    Boolean  @default(true)
  lastFetched DateTime?
  articleCount Int     @default(0)
  createdAt   DateTime @default(now())
}

// ─── Competitive Features & AI Learning Models ──────────────────────

model FacilityRating {
  id              String   @id @default(uuid())
  facilityName    String
  facilityAddress String
  facilityCity    String
  facilityState   String
  facilityZip     String
  carrierId       String
  loadId          String
  locationType    String   // PICKUP or DELIVERY
  waitTimeMinutes Int?
  dockAccess      Int      // 1-5
  communication   Int      // 1-5
  safety          Int      // 1-5
  overall         Int      // 1-5
  comments        String?
  createdAt       DateTime @default(now())

  @@index([facilityAddress])
  @@index([facilityZip])
  @@index([carrierId])
  @@map("facility_ratings")
}

model FacilityProfile {
  id               String    @id @default(uuid())
  facilityName     String
  address          String
  city             String
  state            String
  zip              String
  avgWaitTime      Float     @default(0)
  avgDockAccess    Float     @default(0)
  avgCommunication Float     @default(0)
  avgSafety        Float     @default(0)
  avgOverall       Float     @default(0)
  totalRatings     Int       @default(0)
  lastRatedAt      DateTime?
  updatedAt        DateTime  @updatedAt

  @@unique([address, city, state])
  @@index([zip])
  @@index([avgOverall])
  @@map("facility_profiles")
}

model CarrierPreferences {
  id                 String   @id @default(uuid())
  carrierId          String   @unique
  preferredLanes     Json     @default("[]")
  preferredRegions   Json     @default("[]")
  avoidRegions       Json     @default("[]")
  preferredLoadTypes Json     @default("[]")
  minRatePerMile     Float?
  maxDeadheadMiles   Int      @default(150)
  preferredPayTerms  String?
  homeBaseLat        Float?
  homeBaseLng        Float?
  typicalRadiusMiles Int      @default(500)
  notifyMethod       String   @default("EMAIL")
  notifyFrequency    String   @default("IMMEDIATE")
  autoLearned        Json     @default("{}")
  lastUpdatedBy      String   @default("SYSTEM")
  updatedAt          DateTime @updatedAt
  createdAt          DateTime @default(now())

  @@map("carrier_preferences")
}

model LaneRateIntelligence {
  id               String   @id @default(uuid())
  originZip        String
  destZip          String
  equipmentType    String   @default("DRY_VAN")
  avgRatePerMile   Float    @default(0)
  minAccepted      Float?
  maxRejected      Float?
  acceptanceRate   Float    @default(0)
  sampleSize       Int      @default(0)
  volatility       Float    @default(0)
  trend            String   @default("STABLE")
  seasonalJson     Json     @default("{}")
  confidence       String   @default("LOW")
  lastQuotedRate   Float?
  lastAcceptedRate Float?
  updatedAt        DateTime @updatedAt
  createdAt        DateTime @default(now())

  @@unique([originZip, destZip, equipmentType])
  @@index([confidence])
  @@index([updatedAt])
  @@map("lane_rate_intelligence")
}

model CarrierScoreEvent {
  id        String   @id @default(uuid())
  carrierId String
  eventType String
  adjustment Float
  reason    String
  loadId    String?
  createdAt DateTime @default(now())

  @@index([carrierId])
  @@index([createdAt])
  @@map("carrier_score_events")
}

model DemandForecast {
  id              String   @id @default(uuid())
  laneKey         String
  equipmentType   String   @default("DRY_VAN")
  forecastDate    DateTime
  predictedVolume Float
  actualVolume    Float?
  confidence      String   @default("LOW")
  trend           String   @default("STABLE")
  modelVersion    String   @default("v1")
  createdAt       DateTime @default(now())

  @@unique([laneKey, equipmentType, forecastDate])
  @@index([forecastDate])
  @@index([confidence])
  @@map("demand_forecasts")
}

model MatchingOutcome {
  id         String   @id @default(uuid())
  loadId     String
  carrierId  String
  matchScore Float
  outcome    String
  factors    Json     @default("{}")
  createdAt  DateTime @default(now())

  @@index([outcome])
  @@index([createdAt])
  @@map("matching_outcomes")
}

model AnomalyLog {
  id          String    @id @default(uuid())
  entityType  String
  entityId    String
  anomalyType String
  severity    String
  description String
  dataJson    Json      @default("{}")
  status      String    @default("NEW")
  reviewedBy  String?
  reviewedAt  DateTime?
  createdAt   DateTime  @default(now())

  @@index([severity])
  @@index([status])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("anomaly_logs")
}

model LearningEventQueue {
  id          String    @id @default(uuid())
  eventType   String
  payload     Json
  attempts    Int       @default(0)
  lastError   String?
  status      String    @default("PENDING")
  createdAt   DateTime  @default(now())
  processedAt DateTime?

  @@index([status])
  @@index([eventType])
  @@index([createdAt])
  @@map("learning_event_queue")
}

model AILearningLog {
  id          String   @id @default(uuid())
  serviceName String
  eventType   String
  dataJson    Json     @default("{}")
  outcome     String?
  confidence  Float?
  durationMs  Int?
  createdAt   DateTime @default(now())

  @@index([serviceName])
  @@index([eventType])
  @@index([createdAt])
  @@map("ai_learning_logs")
}

model AIApiUsage {
  id           String   @id @default(uuid())
  provider     String
  model        String
  inputTokens  Int
  outputTokens Int
  costUsd      Float
  latencyMs    Int
  queryType    String
  source       String
  success      Boolean
  errorType    String?
  userId       String?
  createdAt    DateTime @default(now())

  @@index([provider])
  @@index([createdAt])
  @@index([source])
  @@map("ai_api_usage")
}

model EmailQuoteLog {
  id                      String   @id @default(uuid())
  emailSubject            String?
  sender                  String?
  classification          String?
  classificationConfidence Float?
  extractedDataJson       Json     @default("{}")
  generatedRate           Float?
  rateConfidence          String?
  outcome                 String   @default("PENDING")
  processingTimeMs        Int?
  createdAt               DateTime @default(now())

  @@index([outcome])
  @@index([createdAt])
  @@map("email_quote_logs")
}

model RecommendationLog {
  id            String    @id @default(uuid())
  loadId        String
  carrierId     String
  matchScore    Float
  factors       Json      @default("{}")
  outcome       String    @default("PENDING")
  recommendedAt DateTime  @default(now())
  respondedAt   DateTime?

  @@index([carrierId])
  @@index([loadId])
  @@index([outcome])
  @@map("recommendation_logs")
}

model InstantBookLog {
  id                String   @id @default(uuid())
  loadId            String
  postedRate        Float
  accepted          Boolean  @default(false)
  carrierId         String?
  timeToBookSeconds Int?
  createdAt         DateTime @default(now())

  @@index([loadId])
  @@index([accepted])
  @@map("instant_book_logs")
}

model ShipmentRiskLog {
  id             String   @id @default(uuid())
  loadId         String
  riskScore      Int
  riskLevel      String   // GREEN, AMBER, RED
  riskFactorsJson Json    @default("{}")
  alertSent      Boolean  @default(false)
  scannedAt      DateTime @default(now())

  @@index([loadId])
  @@index([riskLevel])
  @@index([scannedAt])
  @@map("shipment_risk_logs")
}
