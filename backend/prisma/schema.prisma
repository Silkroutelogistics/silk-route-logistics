generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Enums ───────────────────────────────────────────

enum UserRole {
  CARRIER
  BROKER
  SHIPPER
  FACTOR
  ADMIN
  DISPATCH
  OPERATIONS
  ACCOUNTING
  CEO
}

enum LoadStatus {
  DRAFT
  POSTED
  BOOKED
  DISPATCHED
  PICKED_UP
  IN_TRANSIT
  DELIVERED
  COMPLETED
  CANCELLED
}

enum InvoiceStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  FUNDED
  PAID
  REJECTED
}

enum CarrierTier {
  PLATINUM
  GOLD
  SILVER
  BRONZE
}

enum OnboardingStatus {
  PENDING
  DOCUMENTS_SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
}

enum ScorecardPeriod {
  WEEKLY
  MONTHLY
}

enum BonusType {
  PERFORMANCE
  REFERRAL
  VOLUME
  TIER
}

enum BonusStatus {
  PENDING
  APPROVED
  PAID
}

enum TenderStatus {
  OFFERED
  ACCEPTED
  COUNTERED
  DECLINED
  EXPIRED
}

enum IntegrationStatus {
  ACTIVE
  INACTIVE
  ERROR
}

enum ShipmentStatus {
  PENDING
  BOOKED
  DISPATCHED
  PICKED_UP
  IN_TRANSIT
  DELIVERED
  COMPLETED
  CANCELLED
}

enum DriverStatus {
  AVAILABLE
  ON_ROUTE
  OFF_DUTY
  SLEEPER
  INACTIVE
}

enum EquipmentStatus {
  ACTIVE
  IN_SHOP
  OUT_OF_SERVICE
}

enum TruckType {
  DAY_CAB
  SLEEPER
  STRAIGHT
  BOX_TRUCK
}

enum TrailerType {
  DRY_VAN
  REEFER
  FLATBED
  STEP_DECK
  LOWBOY
  TANKER
  CAR_HAULER
  CONESTOGA
  POWER_ONLY
}

enum OwnershipType {
  COMPANY
  LEASED
  OWNER_OPERATOR
}

enum AssetStatus {
  ACTIVE
  IN_SHOP
  OUT_OF_SERVICE
  SOLD
}

enum CustomerType {
  SHIPPER
  CONSIGNEE
  BOTH
}

enum CreditStatus {
  NOT_CHECKED
  APPROVED
  CONDITIONAL
  DENIED
  PENDING_REVIEW
}

// ─── Core Models ──────────────────────────────────────────

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  firstName     String
  lastName      String
  company       String?
  role          UserRole
  phone         String?
  isVerified    Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  carrierProfile  CarrierProfile?
  loadsPosted     Load[]          @relation("LoadPoster")
  loadsCarried    Load[]          @relation("LoadCarrier")
  invoices        Invoice[]
  documents       Document[]
  sentMessages    Message[]       @relation("MessageSender")
  receivedMessages Message[]      @relation("MessageReceiver")
  notifications   Notification[]
  auditLogs       AuditLog[]
  passwordChangedAt DateTime?
  otpCodes        OtpCode[]

  @@map("users")
}

// ─── Carrier Models ──────────────────────────────────────

model CarrierProfile {
  id                    String           @id @default(cuid())
  userId                String           @unique
  user                  User             @relation(fields: [userId], references: [id])
  mcNumber              String?          @unique
  dotNumber             String?          @unique
  insuranceExpiry       DateTime?
  safetyScore           Float?
  tier                  CarrierTier      @default(BRONZE)
  equipmentTypes        String[]
  operatingRegions      String[]
  onboardingStatus      OnboardingStatus @default(PENDING)
  approvedAt            DateTime?
  w9Uploaded            Boolean          @default(false)
  insuranceCertUploaded Boolean          @default(false)
  authorityDocUploaded  Boolean          @default(false)
  address               String?
  city                  String?
  state                 String?
  zip                   String?
  numberOfTrucks        Int?
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt

  scorecards  CarrierScorecard[]
  bonuses     CarrierBonus[]
  tenders     LoadTender[]

  @@map("carrier_profiles")
}

model CarrierScorecard {
  id                          String          @id @default(cuid())
  carrierId                   String
  carrier                     CarrierProfile  @relation(fields: [carrierId], references: [id])
  period                      ScorecardPeriod
  onTimePickupPct             Float           @default(0)
  onTimeDeliveryPct           Float           @default(0)
  communicationScore          Float           @default(0)
  claimRatio                  Float           @default(0)
  documentSubmissionTimeliness Float          @default(0)
  acceptanceRate              Float           @default(0)
  gpsCompliancePct            Float           @default(0)
  overallScore                Float           @default(0)
  tierAtTime                  CarrierTier
  bonusEarned                 Float           @default(0)
  calculatedAt                DateTime        @default(now())

  @@index([carrierId, period])
  @@map("carrier_scorecards")
}

model CarrierBonus {
  id          String      @id @default(cuid())
  carrierId   String
  carrier     CarrierProfile @relation(fields: [carrierId], references: [id])
  type        BonusType
  amount      Float
  period      String?
  status      BonusStatus @default(PENDING)
  description String?
  createdAt   DateTime    @default(now())

  @@index([carrierId])
  @@map("carrier_bonuses")
}

// ─── Load & Tender Models ──────────────────────────────────

model Load {
  id              String     @id @default(cuid())
  referenceNumber String     @unique @default(cuid())
  status          LoadStatus @default(POSTED)

  originCity      String
  originState     String
  originZip       String
  destCity        String
  destState       String
  destZip         String

  weight          Float?
  pieces          Int?
  equipmentType   String
  commodity       String?
  rate            Float
  distance        Float?
  notes           String?

  freightClass    String?
  hazmat          Boolean    @default(false)
  tempMin         Float?
  tempMax         Float?
  customsRequired Boolean    @default(false)
  bondType        String?
  accessorials    String[]
  specialInstructions String?
  contactName     String?
  contactPhone    String?
  length          Float?
  width           Float?
  height          Float?

  // Asset assignment (for company-owned fleet)
  truckId         String?
  truck           Truck?     @relation(fields: [truckId], references: [id])
  trailerId       String?
  trailer         Trailer?   @relation(fields: [trailerId], references: [id])
  driverId        String?
  driver          Driver?    @relation(fields: [driverId], references: [id])
  customerId      String?
  customer        Customer?  @relation(fields: [customerId], references: [id])

  pickupDate      DateTime
  deliveryDate    DateTime
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  posterId        String
  poster          User       @relation("LoadPoster", fields: [posterId], references: [id])
  carrierId       String?
  carrier         User?      @relation("LoadCarrier", fields: [carrierId], references: [id])
  invoices        Invoice[]
  documents       Document[]
  tenders         LoadTender[]
  messages        Message[]
  ediTransactions EDITransaction[]
  shipments       Shipment[]

  @@index([status])
  @@index([originState])
  @@index([destState])
  @@index([customerId])
  @@index([carrierId])
  @@map("loads")
}

model LoadTender {
  id          String       @id @default(cuid())
  loadId      String
  load        Load         @relation(fields: [loadId], references: [id])
  carrierId   String
  carrier     CarrierProfile @relation(fields: [carrierId], references: [id])
  status      TenderStatus @default(OFFERED)
  offeredRate Float
  counterRate Float?
  respondedAt DateTime?
  expiresAt   DateTime
  createdAt   DateTime     @default(now())

  @@index([carrierId, status])
  @@map("load_tenders")
}

// ─── Finance Models ──────────────────────────────────

model Invoice {
  id              String        @id @default(cuid())
  invoiceNumber   String        @unique
  status          InvoiceStatus @default(DRAFT)
  amount          Float
  factoringFee    Float?
  advanceRate     Float?
  advanceAmount   Float?
  dueDate         DateTime?
  paidAt          DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  userId          String
  user            User          @relation(fields: [userId], references: [id])
  loadId          String
  load            Load          @relation(fields: [loadId], references: [id])
  documents       Document[]

  @@index([status])
  @@index([userId, status])
  @@map("invoices")
}

// ─── Document & Communication Models ──────────────────

model Document {
  id          String   @id @default(cuid())
  fileName    String
  fileUrl     String
  fileType    String
  fileSize    Int
  createdAt   DateTime @default(now())

  userId      String
  user        User     @relation(fields: [userId], references: [id])
  loadId      String?
  load        Load?    @relation(fields: [loadId], references: [id])
  invoiceId   String?
  invoice     Invoice? @relation(fields: [invoiceId], references: [id])

  @@map("documents")
}

model Message {
  id         String   @id @default(cuid())
  senderId   String
  sender     User     @relation("MessageSender", fields: [senderId], references: [id])
  receiverId String
  receiver   User     @relation("MessageReceiver", fields: [receiverId], references: [id])
  loadId     String?
  load       Load?    @relation(fields: [loadId], references: [id])
  content    String
  readAt     DateTime?
  createdAt  DateTime @default(now())

  @@index([senderId, receiverId])
  @@index([receiverId, readAt])
  @@map("messages")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  type      String
  title     String
  message   String
  readAt    DateTime?
  actionUrl String?
  createdAt DateTime @default(now())

  @@index([userId, readAt])
  @@map("notifications")
}

// ─── Customer / Shipper Models ──────────────────────────

model Customer {
  id              String       @id @default(cuid())
  name            String
  type            CustomerType @default(SHIPPER)
  contactName     String?
  email           String?
  phone           String?
  address         String?
  city            String?
  state           String?
  zip             String?
  status          String       @default("Active")
  rating          Int          @default(0)
  notes           String?

  // Financial
  creditLimit     Float?
  creditStatus    CreditStatus @default(NOT_CHECKED)
  creditCheckDate DateTime?
  paymentTerms    String?      @default("Net 30")
  taxId           String?
  annualRevenue   Float?

  // Business
  mcNumber        String?
  industryType    String?
  avgLoadsPerMonth Int?
  preferredEquipment String[]
  onboardingStatus OnboardingStatus @default(PENDING)
  contractUrl     String?

  // Billing
  billingAddress  String?
  billingCity     String?
  billingState    String?
  billingZip      String?
  billingEmail    String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  shipments       Shipment[]
  loads           Load[]
  contacts        CustomerContact[]

  @@map("customers")
}

model CustomerContact {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  name       String
  title      String?
  email      String?
  phone      String?
  isPrimary  Boolean  @default(false)
  createdAt  DateTime @default(now())

  @@index([customerId])
  @@map("customer_contacts")
}

// ─── Fleet / Asset Models ──────────────────────────

model Truck {
  id                  String        @id @default(cuid())
  unitNumber          String        @unique
  type                TruckType     @default(SLEEPER)
  year                Int?
  make                String?
  model               String?
  vin                 String?       @unique
  licensePlate        String?
  licensePlateState   String?
  color               String?
  fuelType            String?       @default("Diesel")
  ownershipType       OwnershipType @default(COMPANY)
  status              AssetStatus   @default(ACTIVE)
  mileage             Int           @default(0)

  // Compliance
  registrationExpiry  DateTime?
  lastInspectionDate  DateTime?
  nextInspectionDate  DateTime?
  insuranceExpiry     DateTime?
  ifta                Boolean       @default(false)
  iftaExpiry          DateTime?

  // Service
  lastServiceDate     DateTime?
  nextServiceDate     DateTime?
  nextServiceMileage  Int?

  // Assignment
  assignedDriverId    String?       @unique
  assignedDriver      Driver?       @relation("TruckDriver")

  loads               Load[]
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  @@map("trucks")
}

model Trailer {
  id                  String        @id @default(cuid())
  unitNumber          String        @unique
  type                TrailerType   @default(DRY_VAN)
  year                Int?
  make                String?
  model               String?
  vin                 String?       @unique
  licensePlate        String?
  licensePlateState   String?
  length              Int?          // feet
  capacity            Int?          // lbs
  ownershipType       OwnershipType @default(COMPANY)
  status              AssetStatus   @default(ACTIVE)

  // Compliance
  registrationExpiry  DateTime?
  lastInspectionDate  DateTime?
  nextInspectionDate  DateTime?

  // Reefer-specific
  reeferUnit          Boolean       @default(false)
  reeferModel         String?
  reeferHours         Int?

  // Assignment
  assignedDriverId    String?       @unique
  assignedDriver      Driver?       @relation("TrailerDriver")

  loads               Load[]
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  @@map("trailers")
}

model Driver {
  id              String       @id @default(cuid())
  firstName       String
  lastName        String
  phone           String?
  email           String?
  dateOfBirth     DateTime?
  licenseType     String
  licenseNumber   String?
  licenseState    String?
  licenseExpiry   DateTime?
  status          DriverStatus @default(AVAILABLE)
  currentLocation String?
  hireDate        DateTime?
  terminationDate DateTime?
  safetyScore     Float        @default(100)
  violations      Int          @default(0)

  // Compliance
  medicalCardExpiry DateTime?
  drugTestDate      DateTime?
  endorsements      String[]      // HAZMAT, TANKER, DOUBLES, etc.
  twicCard          Boolean       @default(false)
  twicExpiry        DateTime?
  backgroundCheckDate DateTime?
  mvrDate           DateTime?     // Motor Vehicle Record check

  // Emergency contact
  emergencyContactName  String?
  emergencyContactPhone String?

  // HOS (Hours of Service)
  hosDrivingUsed  Float        @default(0)
  hosOnDutyUsed   Float        @default(0)
  hosCycleUsed    Float        @default(0)
  hosCycleLimit   Float        @default(70)

  // Fleet assignment
  assignedTruckId     String?  @unique
  assignedTruck       Truck?   @relation("TruckDriver", fields: [assignedTruckId], references: [id])
  assignedTrailerId   String?  @unique
  assignedTrailer     Trailer? @relation("TrailerDriver", fields: [assignedTrailerId], references: [id])

  // Legacy equipment relation (kept for backward compat with Shipment)
  assignedEquipmentId String?  @unique
  assignedEquipment   Equipment? @relation("DriverEquipment", fields: [assignedEquipmentId], references: [id])

  shipments       Shipment[]
  loads           Load[]

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@map("drivers")
}

// ─── Shipment (legacy/external) ──────────────────────────

model Shipment {
  id              String         @id @default(cuid())
  shipmentNumber  String         @unique @default(cuid())
  proNumber       String?        @unique
  bolNumber       String?
  status          ShipmentStatus @default(PENDING)

  originCity      String
  originState     String
  originZip       String
  destCity        String
  destState       String
  destZip         String

  weight          Float?
  pieces          Int?
  commodity       String?
  equipmentType   String
  rate            Float
  distance        Float?
  specialInstructions String?

  pickupDate      DateTime
  deliveryDate    DateTime
  actualPickup    DateTime?
  actualDelivery  DateTime?

  customerId      String?
  customer        Customer?  @relation(fields: [customerId], references: [id])
  driverId        String?
  driver          Driver?    @relation(fields: [driverId], references: [id])
  equipmentId     String?
  equipment       Equipment? @relation(fields: [equipmentId], references: [id])

  loadId          String?
  load            Load?      @relation(fields: [loadId], references: [id])

  lastLocation    String?
  lastLocationAt  DateTime?
  eta             DateTime?

  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  @@index([status])
  @@index([customerId])
  @@index([driverId])
  @@index([loadId])
  @@map("shipments")
}

// ─── Legacy Equipment (kept for backward compatibility) ───

model Equipment {
  id              String          @id @default(cuid())
  unitNumber      String          @unique
  type            String
  year            Int?
  make            String?
  model           String?
  vin             String?         @unique
  status          EquipmentStatus @default(ACTIVE)
  mileage         Int             @default(0)
  nextServiceDate DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  assignedDriver  Driver?         @relation("DriverEquipment")
  shipments       Shipment[]

  @@map("equipment")
}

// ─── SOP ──────────────────────────────────────────

model SOP {
  id          String   @id @default(cuid())
  title       String
  category    String
  version     String
  author      String
  description String?
  content     String?
  fileUrl     String?
  pages       Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@map("sops")
}

// ─── Integration & EDI ──────────────────────────────────

model BrokerIntegration {
  id              String            @id @default(cuid())
  name            String
  provider        String            @unique
  apiEndpoint     String?
  apiKeyEncrypted String?
  status          IntegrationStatus @default(INACTIVE)
  config          String?           // JSON config (rate sources, ELD provider settings)
  lastSyncAt      DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@map("broker_integrations")
}

model EDITransaction {
  id              String   @id @default(cuid())
  transactionSet  String
  direction       String
  loadId          String?
  load            Load?    @relation(fields: [loadId], references: [id])
  carrierId       String?
  rawPayload      String
  status          String   @default("PENDING")
  errorMessage    String?
  createdAt       DateTime @default(now())
  processedAt     DateTime?

  @@index([transactionSet, status])
  @@index([loadId])
  @@map("edi_transactions")
}

// ─── Audit & Compliance ──────────────────────────────────

model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  action     String   // CREATE, UPDATE, DELETE, LOGIN, EXPORT, etc.
  entity     String   // Load, Customer, Invoice, etc.
  entityId   String?
  changes    String?  // JSON diff of before/after
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([entity, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

model ComplianceAlert {
  id          String   @id @default(cuid())
  type        String   // LICENSE_EXPIRY, INSURANCE_EXPIRY, MEDICAL_CARD, INSPECTION_DUE, etc.
  entityType  String   // Driver, Truck, Trailer, CarrierProfile
  entityId    String
  entityName  String   // Human-readable name for display
  expiryDate  DateTime
  status      String   @default("ACTIVE") // ACTIVE, RESOLVED, DISMISSED
  severity    String   @default("WARNING") // CRITICAL, WARNING, INFO
  notifiedAt  DateTime?
  resolvedAt  DateTime?
  createdAt   DateTime @default(now())

  @@index([status, severity])
  @@index([entityType, entityId])
  @@index([expiryDate])
  @@map("compliance_alerts")
}

// ─── OTP Codes ──────────────────────────────────────────

model OtpCode {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  code      String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId, used])
  @@map("otp_codes")
}

// ─── Scheduler Locks (prevents duplicate cron runs on multi-instance) ───

model SchedulerLock {
  id        String   @id
  lockedAt  DateTime @default(now())
  lockedBy  String   // instance identifier
  expiresAt DateTime

  @@map("scheduler_locks")
}
